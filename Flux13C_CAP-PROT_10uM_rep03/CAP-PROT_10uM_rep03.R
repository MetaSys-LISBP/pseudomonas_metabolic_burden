# This is an automatically generated R code. Don't edit.
# Generated by 
# D:\Users\vogeleer\Anaconda3\Scripts\ftbl2optR.py --clownr --tblimit 0 --ropts "clownr=1e-05; sln=TRUE; zc=1e-05" .\FTBL33B_condition2_G6Pcommenté_v2.ftbl
# at Mon May 16 14:10:56 2022.

# Copyright 2011-2022, INRAE, France.

# working dir
dirw="D:\\Users\\vogeleer\\Documents\\PVO_FTBL_finaux\\PVO_flux13C_pmalEGFP_10uM_rep3"

# installation dir (where influx_si/R/*.R live)
dirr="D:\\Users\\vogeleer\\Anaconda3\\Lib\\site-packages\\influx_si\\R"
# short base name of the FTBL (withount '.ftbl')
baseshort="FTBL33B_condition2_G6Pcommenté_v2"

fcerr=file(file.path(dirw, sprintf("%s.err", baseshort)), "ab")
fclog=file(file.path(dirw, sprintf("%s.log", baseshort)), "ab")

options(warn=1)
options(digits.secs=2)

case_i=FALSE

if (length(find("bitwAnd"))==0L) {
   suppressPackageStartupMessages(library(bitops))
   bitwAnd=bitAnd
}
source(file.path(dirr, "libs.R"))

# define matprod for simple_triplet_matrix
`%stm%` = slam::matprod_simple_triplet_matrix

# default options
version=FALSE
noopt=FALSE
noscale=FALSE
meth="nlsic"
fullsys=FALSE
emu=FALSE
irand=FALSE
sens=""
cupx=0.999
cupn=1.e3
cupp=1.e5
clownr=0
cinout=0
clowp=1.e-8
np=0
ln=FALSE
tikhreg=FALSE
sln=FALSE
lim=FALSE
zc=-.Machine$double.xmax
ffguess=FALSE
fdfit=FALSE
addnoise=FALSE
fseries=""
iseries=""
seed=-.Machine$integer.max
excl_outliers=FALSE
TIMEIT=FALSE
prof=FALSE
time_order="1"

# get runtime arguments
clownr=1e-05
sln=TRUE
zc=1e-05

# synonymous
myver=version
optimize=!noopt
methods=trimws(strsplit(meth, ",")[[1L]])
sensitive=sens
least_norm=ln
initrand=irand

vernum="5.4.0"

# sanity check for command line parameters
if (substring(sensitive, 1, 3)=="mc=") {
   # read the mc iteration number
   nmc=as.integer(substring(sensitive, 4))
   sensitive="mc"
} else if (sensitive=="mc") {
   nmc=10
}
# cupx==0 means no upper limit => cupx=1
cupx=ifelse(cupx, cupx, 1)
if (cupx < 0 || cupx > 1) {
   stop_mes("Option '--cupx N' must have N in the interval [0,1]\n",
      "Instead, the value ", cupx, " is given.", file=fcerr)
}
if (cinout < 0) {
   stop_mes("Option '--cinout N' must have N non negative\n",
      "Instead, the value ", cinout, " is given.", file=fcerr)
}
# minimization method
validmethods=c("BFGS", "Nelder-Mead", "SANN", "ipopt", "nlsic", "pso")
if (! all(igood <- (methods %in% validmethods))) {
   cat(paste("Warning: optimization methods ", paste0(methods[!igood], collapse=", "), " are not implemented. 'nlsic' is used instead."), "\n", sep="", file=fcerr)
   methods[!igood]="nlsic"
}
if ("ipopt" %in% methods) {
   installed=suppressPackageStartupMessages(library(ipoptr, logical.return=TRUE))
   if (!installed) {
      stop_mes("An optimization method ipopt is requested but not available in this R installation", file=fcerr)
   }
}
if (least_norm && sln) {
   stop_mes("Options --ln and --sln cannot be activated simultaniously.", file=fcerr)
}

avaco=try(detectCores(), silent=TRUE)
if (inherits(avaco, "try-error")) {
   avaco=NULL
}
if (np > 0L && np < 1L) {
   np=round(avaco*np)
} else if (np >= 1L) {
   np=round(np)
} else {
   np=avaco
}
if (is.null(np) || np <= 0L) {
   np=1L
}
if (sensitive=="mc") {
   np=min(np, nmc)
}
options(mc.cores=np)

if (least_norm+tikhreg+lim > 1) {
   stop_mes("Options --ln, --lim and --tikhreg cannot be activated simultaneously. Use only one of them at a time.", file=fcerr)
}
lsi_fun=lsi
if (least_norm || sln) {
   lsi_fun=lsi_ln
} else if (tikhreg) {
   lsi_fun=lsi_reg
} else if (lim) {
   suppressPackageStartupMessages(library(limSolve));
   lsi_fun=lsi_lim
}
if (zc==-.Machine$double.xmax) {
   # no zero scrossing to apply
   zerocross=F
} else {
   if (zc < 0.) {
      stop_mes("Zero crossing value ZC must be non negative, instead ", zc, " is given.", file=fcerr)
   }
   zerocross=T
}
if (seed==-.Machine$integer.max) {
   # no seed to apply
   set_seed=F
} else {
   set_seed=T
   set.seed(seed)
}
time_order=gsub("\\s", "", time_order) # remove spaces if any
if (!(time_order %in% c("1", "2", "1,2"))) {
   stop_mes("time_order must be '1', '2' or '1,2'. Instead got '", time_order, "'", file=fcerr)
}
opts=commandArgs()
# end command line argument proceeding

# get some cumomer tools
source(file.path(dirr, "opt_cumo_tools.R"))
#loadcmp(file.path(dirr, "opt_cumo_tools.Rc"))

lab_resid=cumo_resid
lab_sim=param2fl_x
jx_f=new.env()
control_ftbl=list(`default`=list())
if (TIMEIT) {
   cat("rinit   : ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
}

# R profiling
if (prof) {
   Rprof(sprintf("%s.Rprof", baseshort))
}

nm_list=list()
nb_f=list()

if (TIMEIT) {
   cat("r_flux  : ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
}

# fwd-rev flux names
nm_fwrv=c("fwd.BM", "fwd.CO2_in", "fwd.Glc_in_1", "fwd.Glc_in_U", "fwd.aceA", "fwd.aceB", "fwd.akgdh", "fwd.ald", "fwd.bs_accoa", "fwd.bs_akg", "fwd.bs_e4p", "fwd.bs_fru6P", "fwd.bs_ga3p", "fwd.bs_glc6P", "fwd.bs_oaa", "fwd.bs_pep", "fwd.bs_pga", "fwd.bs_pyr", "fwd.bs_rib5p", "fwd.bsp_accoa", "fwd.bsp_akg", "fwd.bsp_e4p", "fwd.bsp_oaa", "fwd.bsp_pep", "fwd.bsp_pga", "fwd.bsp_pyr", "fwd.bsp_rib5p", "fwd.citsynth", "fwd.eda", "fwd.edd", "fwd.eno", "fwd.fba", "fwd.fum_a", "fwd.fum_b", "fwd.gad", "fwd.gcd", "fwd.glk", "fwd.gnd", "fwd.gntk", "fwd.idh", "fwd.kdgk", "fwd.kgud", "fwd.mae", "fwd.maldh", "fwd.out_Gnt", "fwd.out_Kdg", "fwd.out_co2", "fwd.pdh", "fwd.pgi", "fwd.pgk", "fwd.ppc", "fwd.prot", "fwd.pyc", "fwd.pyk", "fwd.ta1", "fwd.ta2", "fwd.tk1", "fwd.tk2", "fwd.tk3", "fwd.tpi", "fwd.zwf", "rev.BM", "rev.CO2_in", "rev.Glc_in_1", "rev.Glc_in_U", "rev.aceA", "rev.aceB", "rev.akgdh", "rev.ald", "rev.bs_accoa", "rev.bs_akg", "rev.bs_e4p", "rev.bs_fru6P", "rev.bs_ga3p", "rev.bs_glc6P", "rev.bs_oaa", "rev.bs_pep", "rev.bs_pga", "rev.bs_pyr", "rev.bs_rib5p", "rev.bsp_accoa", "rev.bsp_akg", "rev.bsp_e4p", "rev.bsp_oaa", "rev.bsp_pep", "rev.bsp_pga", "rev.bsp_pyr", "rev.bsp_rib5p", "rev.citsynth", "rev.eda", "rev.edd", "rev.eno", "rev.fba", "rev.fum_a", "rev.fum_b", "rev.gad", "rev.gcd", "rev.glk", "rev.gnd", "rev.gntk", "rev.idh", "rev.kdgk", "rev.kgud", "rev.mae", "rev.maldh", "rev.out_Gnt", "rev.out_Kdg", "rev.out_co2", "rev.pdh", "rev.pgi", "rev.pgk", "rev.ppc", "rev.prot", "rev.pyc", "rev.pyk", "rev.ta1", "rev.ta2", "rev.tk1", "rev.tk2", "rev.tk3", "rev.tpi", "rev.zwf")

# edge to netflux name translator
edge2fl=c("f.n.Glc_in_1", "d.n.Glc_in_U", "f.n.CO2_in", "d.n.gcd", "d.n.gad", "f.n.glk", "d.n.gntk", "f.n.kdgk", "d.n.kgud", "d.n.pgi", "d.n.fba", "d.n.ald", "d.n.ald", "d.n.ald", "d.n.tpi", "d.n.pgk", "d.n.eno", "f.n.pyk", "f.n.zwf", "f.n.gnd", "f.n.gnd", "f.n.gnd", "d.n.tk1", "d.n.tk1", "d.n.tk1", "d.n.tk2", "d.n.tk2", "d.n.tk2", "d.n.tk3", "d.n.tk3", "d.n.tk3", "d.n.ta1", "d.n.ta1", "d.n.ta1", "d.n.ta2", "d.n.ta2", "d.n.ta2", "d.n.edd", "d.n.eda", "d.n.eda", "d.n.eda", "f.n.pdh", "f.n.pdh", "f.n.pdh", "d.n.citsynth", "d.n.citsynth", "d.n.citsynth", "d.n.idh", "d.n.idh", "d.n.idh", "d.n.akgdh", "d.n.akgdh", "d.n.akgdh", "d.n.fum_a", "d.n.fum_b", "d.n.maldh", "d.n.aceA", "d.n.aceA", "d.n.aceA", "d.n.aceB", "d.n.aceB", "d.n.aceB", "d.n.ppc", "d.n.ppc", "d.n.ppc", "d.n.mae", "d.n.mae", "d.n.mae", "f.n.pyc", "f.n.pyc", "f.n.pyc", "d.n.bs_glc6P", "d.n.bs_fru6P", "d.n.bs_ga3p", "d.n.bs_pga", "d.n.bs_pyr", "d.n.bs_e4p", "d.n.bs_rib5p", "d.n.bs_pep", "d.n.bs_accoa", "d.n.bs_akg", "d.n.bs_oaa", "d.n.bsp_rib5p", "d.n.bsp_e4p", "d.n.bsp_pga", "d.n.bsp_pep", "d.n.bsp_pyr", "d.n.bsp_accoa", "d.n.bsp_oaa", "d.n.bsp_akg", "d.n.out_Gnt", "f.n.out_Kdg", "d.n.out_co2")
names(edge2fl)=c("Glc_1 (Glc_in_1) Glc", "Glc_U (Glc_in_U) Glc", "CO2_ext (CO2_in) CO2", "Glc (gcd) Gnt", "Gnt (gad) Kdg", "Glc (glk) Glc6P", "Gnt (gntk) Gnt6P", "Kdg (kdgk) K26pg", "K26pg (kgud) Gnt6P", "Fru6P (pgi) Glc6P", "FruBP (fba) Fru6P", "DHAP (ald) ald", "GA3P (ald) ald", "ald (ald) FruBP", "GA3P (tpi) DHAP", "GA3P (pgk) PGA", "PGA (eno) PEP", "PEP (pyk) Pyr", "Glc6P (zwf) Gnt6P", "Gnt6P (gnd) gnd", "gnd (gnd) CO2", "gnd (gnd) Rib5P", "Rib5P (tk1) tk1", "tk1 (tk1) GA3P", "tk1 (tk1) E2", "Ery4P (tk2) tk2", "E2 (tk2) tk2", "tk2 (tk2) Fru6P", "Rib5P (tk3) tk3", "E2 (tk3) tk3", "tk3 (tk3) Sed7P", "GA3P (ta1) ta1", "E3 (ta1) ta1", "ta1 (ta1) Fru6P", "Sed7P (ta2) ta2", "ta2 (ta2) Ery4P", "ta2 (ta2) E3", "Gnt6P (edd) Kdpg", "Kdpg (eda) eda", "eda (eda) Pyr", "eda (eda) GA3P", "Pyr (pdh) pdh", "pdh (pdh) AcCoA", "pdh (pdh) CO2", "AcCoA (citsynth) citsynth", "OAA (citsynth) citsynth", "citsynth (citsynth) ICit", "ICit (idh) idh", "idh (idh) AKG", "idh (idh) CO2", "AKG (akgdh) akgdh", "akgdh (akgdh) Suc", "akgdh (akgdh) CO2", "Suc (fum_a) Mal", "Suc (fum_b) Mal", "Mal (maldh) OAA", "ICit (aceA) aceA", "aceA (aceA) GlyOx", "aceA (aceA) Suc", "GlyOx (aceB) aceB", "AcCoA (aceB) aceB", "aceB (aceB) OAA", "OAA (ppc) ppc", "ppc (ppc) PEP", "ppc (ppc) CO2", "Mal (mae) mae", "mae (mae) Pyr", "mae (mae) CO2", "Pyr (pyc) pyc", "CO2 (pyc) pyc", "pyc (pyc) OAA", "Glc6P (bs_glc6P) BM_Glc6P", "Fru6P (bs_fru6P) BM_Fru6P", "GA3P (bs_ga3p) BM_GA3P", "PGA (bs_pga) BM_PGA", "Pyr (bs_pyr) BM_Pyr", "Ery4P (bs_e4p) BM_Ery4P", "Rib5P (bs_rib5p) BM_Rib5P", "PEP (bs_pep) BM_PEP", "AcCoA (bs_accoa) BM_AcCoA", "AKG (bs_akg) BM_AKG", "OAA (bs_oaa) BM_OAA", "Rib5P (bsp_rib5p) prot_Rib5P", "Ery4P (bsp_e4p) prot_Ery4P", "PGA (bsp_pga) prot_PGA", "PEP (bsp_pep) prot_PEP", "Pyr (bsp_pyr) prot_Pyr", "AcCoA (bsp_accoa) prot_AcCoA", "OAA (bsp_oaa) prot_OAA", "AKG (bsp_akg) prot_AKG", "Gnt (out_Gnt) Gnt_out", "Kdg (out_Kdg) Kdg_out", "CO2 (out_co2) CO2_out")

# initialize the linear system Afl*flnx=bfl (0-weight cumomers)
# unknown net flux names
nm_fln=c("d.n.Glc_in_U", "d.n.aceA", "d.n.aceB", "d.n.akgdh", "d.n.ald", "d.n.bs_accoa", "d.n.bs_akg", "d.n.bs_e4p", "d.n.bs_fru6P", "d.n.bs_ga3p", "d.n.bs_glc6P", "d.n.bs_oaa", "d.n.bs_pep", "d.n.bs_pga", "d.n.bs_pyr", "d.n.bs_rib5p", "d.n.bsp_accoa", "d.n.bsp_akg", "d.n.bsp_e4p", "d.n.bsp_oaa", "d.n.bsp_pep", "d.n.bsp_pga", "d.n.bsp_pyr", "d.n.bsp_rib5p", "d.n.citsynth", "d.n.eda", "d.n.edd", "d.n.eno", "d.n.fba", "d.n.fum_a", "d.n.fum_b", "d.n.gad", "d.n.gcd", "d.n.gntk", "d.n.idh", "d.n.kgud", "d.n.mae", "d.n.maldh", "d.n.out_Gnt", "d.n.out_co2", "d.n.pgi", "d.n.pgk", "d.n.ppc", "d.n.ta1", "d.n.ta2", "d.n.tk1", "d.n.tk2", "d.n.tk3", "d.n.tpi")
nb_fln=length(nm_fln)
fln=c(0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.1, 0.7, 0.0, 0.0, 0.0, 0.0, 0.0, 0.05, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0)
names(fln)=nm_fln
# unknown xch flux names
nm_flx=c("d.x.fum_b")
nb_flx=length(nm_flx)
flx=c(0.0)
names(flx)=nm_flx
nm_fl=c(nm_fln, nm_flx)
nb_fl=nb_fln+nb_flx
fl=c(fln, flx)
# gather flux names in a list
nm_list$flnx=nm_fl
nm_list$fwrv=nm_fwrv

# carbon length of metabolites
clen=c(6,6,6,1,1,6,6,6,6,6,6,6,3,3,3,3,3,5,2,4,7,3,6,2,4,6,5,4,4,2,6,6,3,3,3,4,5,3,2,5,4,5,4,3,3,3,2,4,5,6,6,1)
names(clen)=c("Glc_1","Glc","Glc_U","CO2_ext","CO2","Gnt","Kdg","Glc6P","Gnt6P","K26pg","Fru6P","FruBP","DHAP","GA3P","PGA","PEP","Pyr","Rib5P","E2","Ery4P","Sed7P","E3","Kdpg","AcCoA","OAA","ICit","AKG","Suc","Mal","GlyOx","BM_Glc6P","BM_Fru6P","BM_GA3P","BM_PGA","BM_Pyr","BM_Ery4P","BM_Rib5P","BM_PEP","BM_AcCoA","BM_AKG","BM_OAA","prot_Rib5P","prot_Ery4P","prot_PGA","prot_PEP","prot_Pyr","prot_AcCoA","prot_OAA","prot_AKG","Gnt_out","Kdg_out","CO2_out")

# metabolite pools are : all (poolall) which is divided in free (poolf) and
# constrained (poolc)

# constrained pool
poolc=c()
nm_poolc=c()
if (length(nm_poolc)) {
   names(nm_poolc)=substring(nm_poolc, 4)
}
names(poolc)=nm_poolc

# starting values for free pool (the same number and the same alphabetic order than free growth fluxes, if present)
poolf=c()
nm_poolf=c()
if (length(nm_poolf)) {
   names(nm_poolf)=substring(nm_poolf, 4)
}
names(poolf)=nm_poolf
nb_poolf=length(poolf)
nb_f$nb_poolf=nb_poolf

nm_poolall=c(nm_poolf, nm_poolc)
poolall=as.numeric(c(poolf, poolc))
names(poolall)=nm_poolall
pool=poolall
nm_list$poolf=nm_poolf
nm_list$poolc=nm_poolc
nm_list$poolall=nm_poolall

# flux matrix
nb_flr=50
if (nb_fl) {
   Afl=matrix(0, nrow=nb_flr, ncol=nb_fl)
   Afl[1, c(1, 33)]=c(1.0, -1.0)
   Afl[2, c(4, 35, 37, 40, 43)]=c(1.0, 1.0, 1.0, -1.0, 1.0)
   Afl[3, c(32, 33, 34, 39)]=c(-1.0, 1.0, -1.0, -1.0)
   Afl[4, c(32)]=c(1.0)
   Afl[5, c(11, 41)]=c(-1.0, 1.0)
   Afl[6, c(27, 34, 36)]=c(-1.0, 1.0, 1.0)
   Afl[7, c(36)]=c(-1.0)
   Afl[8, c(9, 29, 41, 44, 47)]=c(-1.0, 1.0, -1.0, 1.0, 1.0)
   Afl[9, c(5, 29)]=c(1.0, -1.0)
   Afl[10, c(5, 49)]=c(-1.0, 1.0)
   Afl[11, c(5, 10, 26, 42, 44, 46, 49)]=c(-1.0, -1.0, 1.0, -1.0, -1.0, 1.0, -1.0)
   Afl[12, c(14, 22, 28, 42)]=c(-1.0, -1.0, -1.0, 1.0)
   Afl[13, c(13, 21, 28, 43)]=c(-1.0, -1.0, 1.0, 1.0)
   Afl[14, c(15, 23, 26, 37)]=c(-1.0, -1.0, 1.0, 1.0)
   Afl[15, c(16, 24, 46, 48)]=c(-1.0, -1.0, -1.0, -1.0)
   Afl[16, c(46, 47, 48)]=c(1.0, -1.0, -1.0)
   Afl[17, c(8, 19, 45, 47)]=c(-1.0, -1.0, 1.0, -1.0)
   Afl[18, c(45, 48)]=c(-1.0, 1.0)
   Afl[19, c(44, 45)]=c(-1.0, 1.0)
   Afl[20, c(26, 27)]=c(-1.0, 1.0)
   Afl[21, c(3, 6, 17, 25)]=c(-1.0, -1.0, -1.0, -1.0)
   Afl[22, c(3, 12, 20, 25, 38, 43)]=c(1.0, -1.0, -1.0, -1.0, 1.0, -1.0)
   Afl[23, c(2, 25, 35)]=c(-1.0, 1.0, -1.0)
   Afl[24, c(4, 7, 18, 35)]=c(-1.0, -1.0, -1.0, 1.0)
   Afl[25, c(2, 4, 30, 31)]=c(1.0, 1.0, -1.0, -1.0)
   Afl[26, c(30, 31, 37, 38)]=c(1.0, 1.0, -1.0, -1.0)
   Afl[27, c(2, 3)]=c(1.0, -1.0)
   Afl[28, c(1)]=c(1.0)
   Afl[29, c(30, 31)]=c(1.0, -1.0)
   Afl[30, c(11)]=c(1.0)
   Afl[31, c(9)]=c(1.0)
   Afl[32, c(10)]=c(1.0)
   Afl[33, c(14)]=c(1.0)
   Afl[34, c(15)]=c(1.0)
   Afl[35, c(8)]=c(1.0)
   Afl[36, c(16)]=c(1.0)
   Afl[37, c(13)]=c(1.0)
   Afl[38, c(6)]=c(1.0)
   Afl[39, c(7)]=c(1.0)
   Afl[40, c(12)]=c(1.0)
   Afl[41, c(34)]=c(1.0)
   Afl[42, c(24)]=c(1.0)
   Afl[43, c(19)]=c(1.0)
   Afl[44, c(22)]=c(1.0)
   Afl[45, c(21)]=c(1.0)
   Afl[46, c(23)]=c(1.0)
   Afl[47, c(17)]=c(1.0)
   Afl[48, c(20)]=c(1.0)
   Afl[49, c(18)]=c(1.0)
   Afl[50, c(50)]=c(-1.0)
} else {
   Afl=matrix(0., nb_fl, nb_fl)
}
dimnames(Afl)=list(c("Glc", "CO2", "Gnt", "Kdg", "Glc6P", "Gnt6P", "K26pg", "Fru6P", "FruBP", "DHAP", "GA3P", "PGA", "PEP", "Pyr", "Rib5P", "E2", "Ery4P", "Sed7P", "E3", "Kdpg", "AcCoA", "OAA", "ICit", "AKG", "Suc", "Mal", "GlyOx", "eq net: Glc_in_1+Glc_in_U=1: 391", "eq net: fum_a-fum_b=0: 392", "eq net: bs_glc6P-0.17556*BM=0: 396", "eq net: bs_fru6P-0.06924*BM=0: 397", "eq net: bs_ga3p-0.67629*BM=0: 398", "eq net: bs_pga-0.34247*BM=0: 399", "eq net: bs_pyr-0.1088*BM=0: 400", "eq net: bs_e4p-1.09542*BM=0: 401", "eq net: bs_rib5p-0.72204*BM=0: 402", "eq net: bs_pep-1.77418*BM=0: 403", "eq net: bs_accoa-2.53331*BM=0: 404", "eq net: bs_akg-0.96807*BM=0: 405", "eq net: bs_oaa-1.36495*BM=0: 406", "eq net: gntk-20.3*kdgk=0: 407", "eq net: bsp_rib5p-0.4025*prot=0: 411", "eq net: bsp_e4p-0.8913*prot=0: 412", "eq net: bsp_pga-1.1644*prot=0: 413", "eq net: bsp_pep-1.6532*prot=0: 414", "eq net: bsp_pyr-4.6576*prot=0: 415", "eq net: bsp_accoa-0.7331*prot=0: 416", "eq net: bsp_oaa-3.1338*prot=0: 417", "eq net: bsp_akg-1.5094*prot=0: 418", "eq xch: fum_a-fum_b=0: 424"), nm_fl)
#browser()
# prepare param (\Theta) vector
# order: free flux net, free flux xch, scale label, scale mass, scale peak
param=numeric(0)
nm_par=c()
# free net fluxes
nb_ffn=12
nm_ffn=c("f.n.BM", "f.n.CO2_in", "f.n.Glc_in_1", "f.n.glk", "f.n.gnd", "f.n.kdgk", "f.n.out_Kdg", "f.n.pdh", "f.n.prot", "f.n.pyc", "f.n.pyk", "f.n.zwf")
# starting values for iterations
param=c(param, c(0.0742194, 1.0, 0.8, 0.3, 0.1, 0.1, 0.05, 1.4, 0.0026994, 0.4, 0.4, 0.5))
if (nb_ffn) {
   nm_par=c(nm_par, nm_ffn)
}
# free xch fluxes
nb_ffx=12
nm_ffx=c("f.x.ald", "f.x.eno", "f.x.fum_a", "f.x.maldh", "f.x.pgi", "f.x.pgk", "f.x.ta1", "f.x.ta2", "f.x.tk1", "f.x.tk2", "f.x.tk3", "f.x.tpi")
# starting values for iterations
param=c(param, c(0.5, 0.99, 0.259945, 0.727373, 0.8, 0.99, 0.1, 0.1, 0.1, 0.1, 0.1, 0.5))
if (nb_ffx) {
   nm_par=c(nm_par, nm_ffx)
}
names(param)=nm_par
ff=param
nm_ff=c(nm_ffn, nm_ffx)
nm_list$ff=nm_ff
nb_param=length(param)
# scaling factors are added to param later

nb_ff=nb_ffn+nb_ffx

# constrained fluxes
# net
nb_fcn=0
nm_fcn=c()
fcn=c()
# xch
nb_fcx=48
nm_fcx=c("c.x.BM", "c.x.CO2_in", "c.x.Glc_in_1", "c.x.Glc_in_U", "c.x.aceA", "c.x.aceB", "c.x.akgdh", "c.x.bs_accoa", "c.x.bs_akg", "c.x.bs_e4p", "c.x.bs_fru6P", "c.x.bs_ga3p", "c.x.bs_glc6P", "c.x.bs_oaa", "c.x.bs_pep", "c.x.bs_pga", "c.x.bs_pyr", "c.x.bs_rib5p", "c.x.bsp_accoa", "c.x.bsp_akg", "c.x.bsp_e4p", "c.x.bsp_oaa", "c.x.bsp_pep", "c.x.bsp_pga", "c.x.bsp_pyr", "c.x.bsp_rib5p", "c.x.citsynth", "c.x.eda", "c.x.edd", "c.x.fba", "c.x.gad", "c.x.gcd", "c.x.glk", "c.x.gnd", "c.x.gntk", "c.x.idh", "c.x.kdgk", "c.x.kgud", "c.x.mae", "c.x.out_Gnt", "c.x.out_Kdg", "c.x.out_co2", "c.x.pdh", "c.x.ppc", "c.x.prot", "c.x.pyc", "c.x.pyk", "c.x.zwf")
fcx=c(0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0)
fc=c(fcn, fcx)
nm_fc=c(nm_fcn, nm_fcx)
names(fc)=nm_fc
nb_fc=nb_fcn+nb_fcx

# variable growth fluxes (constant are already accounted in constrained fluxes)
nb_fgr=0
nm_fgr=c()
fgr=c()
nm_list$fgr=nm_fgr
nb_f$nb_fgr=nb_fgr

# total flux vector fallnx dimension
nb_fallnx=nb_fl+nb_ff+nb_fc+nb_fgr+nb_fgr
nb_fwrv=nb_fallnx

# net dependent and free fluxes
nm_dfn=c(nm_fln, nm_ffn)
names(nm_dfn)=substring(nm_dfn, 5)

# all flux cardinals
nb_f=append(nb_f, list(nb_fln=nb_fln, nb_flx=nb_flx, nb_fl=nb_fl,
   nb_ffn=nb_ffn, nb_ffx=nb_ffx, nb_ff=nb_ff,
   nb_fcn=nb_fcn, nb_fcx=nb_fcx, nb_fc=nb_fc,
   nb_fallnx=nb_fallnx, nb_fwrv=nb_fwrv,
   nb_fgr=nb_fgr,
   include_growth_flux=FALSE,
   mu=NULL))

# prepare p2bfl, c2bfl, g2bfl, cnst2bfl matrices such that p2bfl%*%param[1:nb_ff]+
# c2bfl%*%fc+g2bfl%*%fgr+cnst2bfl=bfl
# replace f.[nx].flx by corresponding param coefficient
p2bfl=simple_triplet_zero_matrix(nrow=nb_flr, ncol=nb_ff)
# replace c.[nx].flx by corresponding fc coefficient
c2bfl=simple_triplet_zero_matrix(nrow=nb_flr, ncol=nb_fc)
# variable growth fluxes
g2bfl=simple_triplet_zero_matrix(nrow=nb_flr, ncol=nb_fgr)
cnst2bfl=numeric(nb_flr); # may be coming from equalities
colnames(p2bfl)=nm_par
colnames(c2bfl)=nm_fc
colnames(g2bfl)=nm_fgr

p2bfl[1, pmatch(c("f.n.glk", "f.n.Glc_in_1"), nm_par)]=c(1.0, -1.0);

p2bfl[2, pmatch(c("f.n.pyc", "f.n.CO2_in", "f.n.gnd", "f.n.pdh"), nm_par)]=c(1.0, -1.0, -1.0, -1.0);

p2bfl[4, pmatch(c("f.n.kdgk", "f.n.out_Kdg"), nm_par)]=c(1.0, 1.0);

p2bfl[5, pmatch(c("f.n.zwf", "f.n.glk"), nm_par)]=c(1.0, -1.0);

p2bfl[6, pmatch(c("f.n.gnd", "f.n.zwf"), nm_par)]=c(1.0, -1.0);

p2bfl[7, pmatch(c("f.n.kdgk"), nm_par)]=c(-1.0);

p2bfl[13, pmatch(c("f.n.pyk"), nm_par)]=c(1.0);

p2bfl[14, pmatch(c("f.n.pdh", "f.n.pyc", "f.n.pyk"), nm_par)]=c(1.0, 1.0, -1.0);

p2bfl[15, pmatch(c("f.n.gnd"), nm_par)]=c(-1.0);

p2bfl[21, pmatch(c("f.n.pdh"), nm_par)]=c(-1.0);

p2bfl[22, pmatch(c("f.n.pyc"), nm_par)]=c(-1.0);

p2bfl[28, pmatch(c("f.n.Glc_in_1"), nm_par)]=c(-1.0);
cnst2bfl[28]=1;


p2bfl[30, pmatch(c("f.n.BM"), nm_par)]=c(0.17556);

p2bfl[31, pmatch(c("f.n.BM"), nm_par)]=c(0.06924);

p2bfl[32, pmatch(c("f.n.BM"), nm_par)]=c(0.67629);

p2bfl[33, pmatch(c("f.n.BM"), nm_par)]=c(0.34247);

p2bfl[34, pmatch(c("f.n.BM"), nm_par)]=c(0.1088);

p2bfl[35, pmatch(c("f.n.BM"), nm_par)]=c(1.09542);

p2bfl[36, pmatch(c("f.n.BM"), nm_par)]=c(0.72204);

p2bfl[37, pmatch(c("f.n.BM"), nm_par)]=c(1.77418);

p2bfl[38, pmatch(c("f.n.BM"), nm_par)]=c(2.53331);

p2bfl[39, pmatch(c("f.n.BM"), nm_par)]=c(0.96807);

p2bfl[40, pmatch(c("f.n.BM"), nm_par)]=c(1.36495);

p2bfl[41, pmatch(c("f.n.kdgk"), nm_par)]=c(20.3);

p2bfl[42, pmatch(c("f.n.prot"), nm_par)]=c(0.4025);

p2bfl[43, pmatch(c("f.n.prot"), nm_par)]=c(0.8913);

p2bfl[44, pmatch(c("f.n.prot"), nm_par)]=c(1.1644);

p2bfl[45, pmatch(c("f.n.prot"), nm_par)]=c(1.6532);

p2bfl[46, pmatch(c("f.n.prot"), nm_par)]=c(4.6576);

p2bfl[47, pmatch(c("f.n.prot"), nm_par)]=c(0.7331);

p2bfl[48, pmatch(c("f.n.prot"), nm_par)]=c(3.1338);

p2bfl[49, pmatch(c("f.n.prot"), nm_par)]=c(1.5094);

p2bfl[50, pmatch(c("f.x.fum_a"), nm_par)]=c(-1.0);

bp=as.numeric(c2bfl%stm%fc+cnst2bfl)

if (ffguess) {
   # make an automatic guess for free/dependent flux partition
   afd=as.matrix(cBind(Afl, -p2bfl))
   qafd=qr(afd, LAPACK=TRUE)
   d=abs(diag(qafd$qr))
   rank=sum(d > d[1]*1.e-10)
   qrow=qr(t(afd))
   rankr=qrow$rank
   if (rank != rankr)
      stop_mes("Weird error: column and row ranks are not equal.", file=fcerr)
   
   irows=qrow$pivot[seq_len(rankr)]
   if (rank==0) {
      stop_mes("Error: No free/dependent flux partition could be made. Stoichiometric matrix has rank=0.", file=fcerr)
   }
   Afl=afd[irows, qafd$pivot[1L:rank], drop=FALSE]
   ka=kappa(Afl)
   if (ka > 1.e7) {
      mes=sprintf("Error: No working free/dependent flux partition could be proposed. Stoichiometric matrix has condition number %g.\n", ka)
      stop_mes(mes, file=fcerr)
   }
   p2bfl=-as.simple_triplet_matrix(afd[irows, qafd$pivot[-seq_len(rank)], drop=FALSE])
   c2bfl=c2bfl[irows, , drop=FALSE]
   g2bfl=g2bfl[irows, , drop=FALSE]
   cnst2bfl=cnst2bfl[irows]
   bp=bp[irows]
   
   # replace names
   nm_fl=sub("f.", "d.", colnames(Afl), fixed=TRUE)
   colnames(Afl)=nm_fl # both net and xch
   nm_fln=sort(grep("^d.n.", nm_fl, v=TRUE))
   nm_flx=sort(grep("^d.x.", nm_fl, v=TRUE))
   nm_fl=c(nm_fln, nm_flx)
   Afl=Afl[, nm_fl, drop=FALSE]
   
   nm_ff=sub("d.", "f.", colnames(p2bfl), fixed=TRUE) # both net and xch
   colnames(p2bfl)=nm_ff
   nm_ffn=sort(grep("^f.n.", nm_ff, v=TRUE))
   nm_ffx=sort(grep("^f.x.", nm_ff, v=TRUE))
   nm_ff=c(nm_ffn, nm_ffx)
   p2bfl=p2bfl[, nm_ff, drop=FALSE]
   
   # remake param vector
   if (!fdfit)
      param=c(runif(length(nm_ff)), if (nb_ff == 0) param else param[-seq_len(nb_ff)])
   names(param)[seq(along=nm_ff)]=nm_ff
#browser()
}
nm_list$flnx=nm_fl
nm_fallnx=c(nm_fln, nm_ffn, nm_fcn, nm_fgr, nm_flx, nm_ffx, nm_fcx, sub(".n.", ".x.", nm_fgr, fixed=TRUE))
nm_list$fallnx=nm_fallnx
nm_net=c(nm_fln, nm_ffn, nm_fcn)
names(nm_net)=substring(nm_net, 5)
nm_xch=c(nm_flx, nm_ffx, nm_fcx)
names(nm_xch)=substring(nm_xch, 5)
edge2fl[]=nm_net[substring(edge2fl, 5)]
nm_list$ff=nm_ff

# accounting numbers
nb_flr=nrow(Afl)
nb_param=length(param)
nb_ffn=length(nm_ffn)
nb_ffx=length(nm_ffx)
nb_ff=nb_ffn+nb_ffx
nb_fln=length(nm_fln)
nb_flx=length(nm_flx)
nb_fl=nb_fln+nb_flx
nm_par=names(param)

for (item in c("nb_fln", "nb_flx", "nb_fl", "nb_ffn", "nb_ffx", "nb_ff")) {
   nb_f[item]=get(item)
}
# translation from n-x to fw-rv
sh_fwrv=substring(nm_fwrv[1:(nb_fwrv/2)], 5)
sh_nx=substring(nm_fallnx, 2)
nb_f$inet2ifwrv=pmatch(paste(".n.", sh_fwrv, sep=""), sh_nx)
nb_f$ixch2ifwrv=pmatch(paste(".x.", sh_fwrv, sep=""), sh_nx)
#nb_f$inet2ifwrv=sapply(nm_fwrv[1:(nb_fwrv/2)], function(f) grep(sprintf("^.\\.n\\.%s$", substring(f, 5)), nm_fallnx))
#nb_f$ixch2ifwrv=sapply(nm_fwrv[1:(nb_fwrv/2)], function(f) grep(sprintf("^.\\.x\\.%s$", substring(f, 5)), nm_fallnx))

if (TIMEIT) {
   cat("Afl qr(): ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
}

qrAfl=qr(Afl, LAPACK=TRUE)
d=abs(diag(qrAfl$qr))
qrAfl$rank=sum(d > d[1]*1.e-10)
rank=qrAfl$rank
aful=as.matrix(cBind(Afl, -p2bfl, -c2bfl))
qrow=qr(t(aful))
rankr=qrow$rank
#browser()
# first check the presence of lindep rows
if (nrow(Afl) > rankr) {
   prop=sprintf("Error: Among %d equations (rows), %d are redundant and must be eliminated by hand.\n", nrow(Afl), nrow(Afl)-rankr)
   prop=paste(prop, "Candidate(s) for elimination is (are):\n",
      paste(rownames(Afl)[qrow$pivot[-(1:rankr)]], sep="", collapse="\n"),
               "\n", sep="")
   stop_mes(prop, file=fcerr)
}
if (nrow(Afl) != rank || nrow(Afl) != ncol(Afl)) {
   #write.table(Afl)
   mes=NULL
   if (nrow(Afl) <= rank) {
      mes=paste("Candidate(s) for free or constrained flux(es):\n",
         paste(colnames(Afl)[-qrAfl$pivot[1L:nrow(Afl)]], collapse="\n"),
         "\nFor this choice, condition number of stoichiometric matrix will be ",
         kappa(Afl[,qrAfl$pivot[1L:nrow(Afl)],drop=FALSE]), "\n", sep="")
   } else if (nrow(Afl) > rank) {
      nextra=nrow(Afl)-rank
      comb=combn(c(nm_ffn, colnames(Afl)[-qrAfl$pivot[1L:rank]]), nextra)
      aextra=cBind(Afl[,-qrAfl$pivot[1L:rank],drop=FALSE], -p2bfl)
      colnames(aextra)=c(colnames(Afl)[-qrAfl$pivot[1L:rank]], colnames(p2bfl))
      ara=Afl[,qrAfl$pivot[1L:rank],drop=FALSE]
      i=which.min(apply(comb, 2, function(i) kappa(cBind(ara, aextra[,i]))))[1L]
      nm_tmp=comb[,i]
      ka=kappa(cBind(ara, aextra[,nm_tmp]))
      if (ka < 1.e7) {
         prop=paste("Proposal to declare dependent flux(es) is:\n",
            paste(nm_tmp, collapse="\n"), "\n", sep="")
         if (rank < ncol(Afl)) {
            prop=prop%s+%"While the following dependent flux(es) should be declared free or constrained:\n"%s+%join("\n", colnames(Afl)[-qrAfl$pivot[1L:rank]])%s+%"\n"
         }
         prop=paste(prop, "For this choice, condition number of stoichiometric matrix will be ", ka, "\n", sep="")
      } else {
         # add constraint fluxes to candidate list
         if (nb_fcn > 0) {
            aextra=as.matrix(cBind(Afl[,-qrAfl$pivot[1L:rank],drop=FALSE], -p2bfl, -c2bfl))
            colnames(aextra)=c(colnames(Afl)[-qrAfl$pivot[1L:rank]], colnames(p2bfl), colnames(c2bfl))
         }
         aextended=aful
         qae=qr(aextended, LAPACK=TRUE)
         d=abs(diag(qae$qr))
         ranke=sum(d > d[1L]*1.e-10)
         if (ranke == nrow(Afl)) {
            prop=paste("Proposal to declare dependent flux(es) is:\n",
            join("\n", colnames(aextended)[qae$pivot[1L:ranke]]), "\n",
            "while free and constrained fluxes should be:\n",
            join("\n", colnames(aextended)[-qae$pivot[1L:ranke]]), "\n",
            sep="")
            ka=kappa(aextended[,qae$pivot[1L:ranke]])
            prop=paste(prop, "For this choice, condition number of stoichiometric matrix will be ", ka, "\n", sep="")
         } else {
            prop="No proposal for partition dependent/free fluxes could be made.\n"
         }
      }
      mes=paste("There is (are) probably ", nextra,
         " extra free flux(es) among the following:\n",
         paste(nm_ffn, collapse="\n"), "\n",
         prop,
         sep="")
   }
   stop_mes("Flux matrix is not square or is singular: (", nrow(Afl), "eq x ", ncol(Afl), "unk)\n",
      "You have to change your choice of free fluxes in the 'FTBL33B_condition2_G6Pcommenté_v2.ftbl' file.\n",
      mes, file=fcerr)
}

# make sure that free params choice leads to not singular matrix
if (qrAfl$rank != nb_fl) {
   #write.table(Afl)
   # make a suggestion of new free fluxes
   A=cBind(Afl, -p2bfl, -c2bfl)
   colnames(A)=c(colnames(Afl), nm_ff, nm_fc)
   qa=qr(A, LAPACK=TRUE)
   d=diag(qa$qr)
   qa$rank=sum(abs(d)>=abs(d[1]*1.e-10))
   
   mes=paste("Error: Dependent flux matrix is singular.\n",
      "Change your partition on free/dependent/constrained fluxes in the 'FTBL33B_condition2_G6Pcommenté_v2.ftbl' file.\n",
      "Can not resolve dependent fluxe(s):\n",
      paste(colnames(Afl)[-qrAfl$pivot[(1:qrAfl$rank)]], collapse="\n"),
      sep="")
   if (qa$rank==nb_fl) {
      mes=paste(mes,
      "\n\nSuggested dependent fluxes:\n",
      paste(colnames(A)[qa$pivot[(1:qa$rank)]], collapse="\n"),
      "\n\nWhich would give the following free and constrained fluxes:\n",
      paste(colnames(A)[-qa$pivot[(1:qa$rank)]], collapse="\n"), "\n",
      sep="")
   } else {
      mes=paste(mes, "\nNo suggested free fluxes could be found", sep="")
   }
   stop_mes(mes, file=fcerr)
}

# inverse flux matrix
invAfl=solve(qrAfl)

if (fdfit) {
#browser()
   # choose free fluxe values such that they fit starting values from ftbl
   #dep=invAfl%*%(p2bfl%*%ff+bp)
   #ff=ff
   ff=qr.solve(rbind(invAfl%stm%p2bfl, diag(ncol(p2bfl))), c(fl-invAfl%*%bp, param))
}
# intermediate jacobian
if (TIMEIT) {
   cat("dfl_dffg: ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
}

dfl_dffg=invAfl%stm%p2bfl
if (nb_fgr > 0L) {
   dfl_dffg=cBind(dfl_dffg, invAfl%stm%g2bfl)
}
dimnames(dfl_dffg)=list(nm_fl, c(nm_ff, nm_fgr))
dfl_dffg[abs(dfl_dffg) < 1.e-14]=0.
nb_f$dfl_dffg=as.simple_triplet_matrix(dfl_dffg)

# prepare mf, md, mc and mg matrices
# such that mf%*%ff+md%*%fl+mc%*%fc+mg%*%fgr gives fallnx
# here ff free fluxes (param), fl are dependent fluxes, fc are constrained
# fluxes and fgr are variable growth fluxes
mf=matrix(0., nb_fallnx, nb_ff)
dimnames(mf)=list(nm_fallnx, nm_ff)
md=matrix(0., nb_fallnx, nb_fl)
dimnames(md)=list(nm_fallnx, nm_fl)
mc=matrix(0., nb_fallnx, nb_fc)
dimnames(mc)=list(nm_fallnx, nm_fc)
mg=matrix(0., nb_fallnx, nb_fgr)
dimnames(mg)=list(nm_fallnx, nm_fgr)

if (nb_ff > 0) {
   mf[nm_ff, nm_ff]=diag(1., nb_ff)
}
if (nb_fl > 0) {
   md[nm_fl, nm_fl]=diag(1., nb_fl)
}
if (nb_fc > 0) {
   mc[nm_fc, nm_fc]=diag(1., nb_fc)
}
if (nb_fgr > 0) {
   mg[nm_fgr, nm_fgr]=diag(1., nb_fgr)
}

# sparse matrix static parts
# $varname fields:
#  ind_fa - flux index in a_pre$vfwrv[ind_fa]
#  a_pre - sparse matrix whose colsum() gives the a$v vector
#  prodx - dense matrix whose colprod() will give x[ind_x1]*x[ind_x2]*...
#  ind_fb - flux index in b_pre$v=fwrv[ind_fb1]*colprod(prodx)
#  ind_b - dense matrix of indexes for  b_pre$v=f[ind_b[,"indf"]*x[ind_b[,2+1]]*x[ind_b[,2+2]], ...]
#  b_pre - sparse matrix whose colsum gives b@x

#  a - unsigned sparse cumomer A matrix (off-diagonal part)
#  b - unsigned sparse vector of right hand side

if (TIMEIT) {
   cat("spAbr   : ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
}

nb_fwrv=122
nb_w=7
spAbr=list()

if (TIMEIT) {
   cat("weight 1: ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
}
w=1
nb_c=118
ba_x=128; # base of cumomer indexes in incu vector
l=new.env()
l$w=w
l$nb_c=nb_c
l$nb_fwrv=nb_fwrv
l$nb_cl=0 # number of lighter cumomers
maxprod=1
if (nb_c > 0) {
   # matrix a
   ind_a=matrix(as.integer(c(50, 0, 0, 92, 0, 0, 50, 0, 53, 92, 0, 36, 50, 1, 1, 92, 1, 1, 50, 1, 54, 92, 1, 37, 50, 2, 2, 92, 2, 2, 50, 2, 55, 92, 2, 38, 39, 3, 3, 42, 3, 3, 61, 3, 3, 39, 3, 73, 42, 3, 74, 61, 3, 75, 39, 4, 4, 42, 4, 4, 61, 4, 4, 39, 4, 76, 42, 4, 77, 61, 4, 78, 39, 5, 5, 42, 5, 5, 61, 5, 5, 39, 5, 79, 42, 5, 80, 61, 5, 81, 39, 6, 6, 42, 6, 6, 61, 6, 6, 39, 6, 82, 42, 6, 83, 61, 6, 84, 39, 7, 7, 42, 7, 7, 61, 7, 7, 39, 7, 85, 42, 7, 86, 61, 7, 87, 39, 8, 8, 42, 8, 8, 61, 8, 8, 39, 8, 88, 42, 8, 89, 61, 8, 90, 28, 9, 9, 28, 9, 48, 28, 10, 10, 28, 10, 49, 28, 11, 11, 28, 11, 64, 28, 12, 12, 28, 12, 65, 28, 13, 13, 28, 13, 66, 28, 14, 14, 28, 14, 67, 32, 15, 15, 58, 15, 15, 55, 15, 15, 110, 15, 15, 32, 15, 21, 58, 15, 59, 55, 15, 53, 110, 15, 75, 32, 16, 16, 58, 16, 16, 55, 16, 16, 110, 16, 16, 32, 16, 22, 58, 16, 60, 55, 16, 54, 110, 16, 78, 32, 17, 17, 58, 17, 17, 55, 17, 17, 110, 17, 17, 32, 17, 23, 58, 17, 61, 55, 17, 55, 110, 17, 81, 32, 18, 18, 58, 18, 18, 55, 18, 18, 110, 18, 18, 32, 18, 24, 58, 18, 62, 55, 18, 50, 110, 18, 84, 32, 19, 19, 58, 19, 19, 55, 19, 19, 110, 19, 19, 32, 19, 25, 58, 19, 46, 55, 19, 51, 110, 19, 87, 32, 20, 20, 58, 20, 20, 55, 20, 20, 110, 20, 20, 32, 20, 26, 58, 20, 47, 55, 20, 52, 110, 20, 90, 8, 21, 21, 8, 21, 53, 8, 22, 22, 8, 22, 54, 8, 23, 23, 8, 23, 55, 8, 24, 24, 8, 24, 56, 8, 25, 25, 8, 25, 57, 8, 26, 26, 8, 26, 58, 33, 27, 27, 34, 27, 27, 105, 27, 27, 33, 27, 91, 34, 27, 92, 105, 27, 67, 33, 28, 28, 34, 28, 28, 105, 28, 28, 33, 28, 93, 34, 28, 94, 105, 28, 66, 33, 29, 29, 34, 29, 29, 105, 29, 29, 33, 29, 94, 34, 29, 93, 105, 29, 65, 33, 30, 30, 34, 30, 30, 105, 30, 30, 33, 30, 92, 34, 30, 91, 105, 30, 64, 38, 31, 31, 118, 31, 31, 120, 31, 31, 38, 31, 3, 118, 31, 53, 120, 31, 39, 38, 32, 32, 118, 32, 32, 120, 32, 32, 38, 32, 4, 118, 32, 54, 120, 32, 40, 38, 33, 33, 118, 33, 33, 120, 33, 33, 38, 33, 5, 118, 33, 55, 120, 33, 41, 38, 34, 34, 118, 34, 34, 120, 34, 34, 38, 34, 6, 118, 34, 46, 120, 34, 42, 38, 35, 35, 118, 35, 35, 120, 35, 35, 38, 35, 7, 118, 35, 47, 120, 35, 43, 31, 36, 36, 51, 36, 36, 31, 36, 0, 51, 36, 66, 31, 37, 37, 51, 37, 37, 31, 37, 1, 51, 37, 65, 31, 38, 38, 51, 38, 38, 31, 38, 2, 51, 38, 64, 59, 39, 39, 117, 39, 39, 59, 39, 31, 117, 39, 59, 59, 40, 40, 117, 40, 40, 59, 40, 32, 117, 40, 60, 59, 41, 41, 117, 41, 41, 59, 41, 33, 117, 41, 61, 59, 42, 42, 117, 42, 42, 59, 42, 34, 117, 42, 62, 59, 43, 43, 117, 43, 43, 59, 43, 35, 117, 43, 50, 59, 44, 44, 117, 44, 44, 59, 44, 46, 117, 44, 51, 59, 45, 45, 117, 45, 45, 59, 45, 47, 117, 45, 52, 57, 46, 46, 119, 46, 46, 120, 46, 46, 57, 46, 34, 119, 46, 19, 120, 46, 44, 57, 47, 47, 119, 47, 47, 120, 47, 47, 57, 47, 35, 119, 47, 20, 120, 47, 45, 48, 48, 48, 48, 48, 71, 48, 49, 49, 48, 49, 72, 56, 50, 50, 116, 50, 50, 56, 50, 43, 116, 50, 18, 56, 51, 51, 116, 51, 51, 56, 51, 44, 116, 51, 19, 56, 52, 52, 116, 52, 52, 56, 52, 45, 116, 52, 20, 57, 53, 53, 29, 53, 53, 69, 53, 53, 121, 53, 53, 111, 53, 53, 116, 53, 53, 57, 53, 31, 29, 53, 95, 69, 53, 21, 121, 53, 58, 111, 53, 0, 116, 53, 15, 57, 54, 54, 29, 54, 54, 69, 54, 54, 121, 54, 54, 111, 54, 54, 116, 54, 54, 57, 54, 32, 29, 54, 96, 69, 54, 22, 121, 54, 57, 111, 54, 1, 116, 54, 16, 57, 55, 55, 29, 55, 55, 69, 55, 55, 121, 55, 55, 111, 55, 55, 116, 55, 55, 57, 55, 33, 29, 55, 97, 69, 55, 23, 121, 55, 56, 111, 55, 2, 116, 55, 17, 60, 56, 56, 69, 56, 56, 60, 56, 55, 69, 56, 24, 60, 57, 57, 69, 57, 57, 60, 57, 54, 69, 57, 25, 60, 58, 58, 69, 58, 58, 60, 58, 53, 69, 58, 26, 56, 59, 59, 119, 59, 59, 56, 59, 39, 119, 59, 15, 56, 60, 60, 119, 60, 60, 56, 60, 40, 119, 60, 16, 56, 61, 61, 119, 61, 61, 56, 61, 41, 119, 61, 17, 56, 62, 62, 119, 62, 62, 56, 62, 42, 119, 62, 18, 38, 63, 63, 48, 63, 63, 40, 63, 63, 7, 63, 63, 51, 63, 63, 43, 63, 63, 2, 63, 63, 38, 63, 8, 48, 63, 70, 40, 63, 11, 7, 63, 98, 51, 63, 67, 43, 63, 27, 44, 64, 64, 6, 64, 64, 53, 64, 64, 44, 64, 30, 6, 64, 68, 53, 64, 70, 44, 65, 65, 6, 65, 65, 53, 65, 65, 44, 65, 29, 6, 65, 69, 53, 65, 71, 44, 66, 66, 6, 66, 66, 53, 66, 66, 44, 66, 28, 6, 66, 49, 53, 66, 72, 44, 67, 67, 6, 67, 67, 53, 67, 67, 44, 67, 27, 6, 67, 48, 53, 67, 63, 5, 68, 68, 5, 68, 14, 5, 69, 69, 5, 69, 13, 54, 70, 70, 29, 70, 70, 43, 70, 70, 54, 70, 38, 29, 70, 99, 43, 70, 30, 54, 71, 71, 29, 71, 71, 43, 71, 71, 54, 71, 37, 29, 71, 100, 43, 71, 29, 54, 72, 72, 29, 72, 72, 43, 72, 72, 54, 72, 36, 29, 72, 101, 43, 72, 28, 36, 73, 73, 36, 73, 102, 41, 74, 74, 41, 74, 103, 37, 75, 75, 49, 75, 75, 37, 75, 102, 49, 75, 15, 36, 76, 76, 36, 76, 104, 41, 77, 77, 41, 77, 105, 37, 78, 78, 49, 78, 78, 37, 78, 104, 49, 78, 16, 36, 79, 79, 36, 79, 106, 41, 80, 80, 41, 80, 107, 37, 81, 81, 49, 81, 81, 37, 81, 106, 49, 81, 17, 36, 82, 82, 36, 82, 108, 41, 83, 83, 41, 83, 109, 37, 84, 84, 49, 84, 84, 37, 84, 108, 49, 84, 18, 36, 85, 85, 36, 85, 110, 41, 86, 86, 41, 86, 111, 37, 87, 87, 49, 87, 87, 37, 87, 110, 49, 87, 19, 36, 88, 88, 36, 88, 112, 41, 89, 89, 41, 89, 113, 37, 90, 90, 49, 90, 90, 37, 90, 112, 49, 90, 20, 7, 91, 91, 5, 91, 91, 94, 91, 91, 95, 91, 91, 7, 91, 114, 5, 91, 9, 94, 91, 27, 95, 91, 30, 7, 92, 92, 5, 92, 92, 94, 92, 92, 95, 92, 92, 7, 92, 115, 5, 92, 11, 94, 92, 30, 95, 92, 27, 7, 93, 93, 5, 93, 93, 94, 93, 93, 95, 93, 93, 7, 93, 116, 5, 93, 10, 94, 93, 28, 95, 93, 29, 7, 94, 94, 5, 94, 94, 94, 94, 94, 95, 94, 94, 7, 94, 117, 5, 94, 12, 94, 94, 29, 95, 94, 28, 30, 95, 95, 30, 95, 3, 30, 96, 96, 30, 96, 4, 30, 97, 97, 30, 97, 5, 40, 98, 98, 40, 98, 14, 30, 99, 99, 30, 99, 8, 30, 100, 100, 30, 100, 7, 30, 101, 101, 30, 101, 6, 3, 102, 102, 4, 102, 102, 35, 103, 103, 35, 103, 73, 3, 104, 104, 4, 104, 104, 35, 105, 105, 35, 105, 76, 3, 106, 106, 4, 106, 106, 35, 107, 107, 35, 107, 79, 3, 108, 108, 4, 108, 108, 35, 109, 109, 35, 109, 82, 3, 110, 110, 4, 110, 110, 35, 111, 111, 35, 111, 85, 3, 112, 112, 4, 112, 112, 35, 113, 113, 35, 113, 88, 40, 114, 114, 40, 114, 9, 40, 115, 115, 40, 115, 13, 40, 116, 116, 40, 116, 10, 40, 117, 117, 40, 117, 12)), ncol=3, byrow=TRUE)
   colnames(ind_a)=c("indf", "ir0", "ic0")
   l$ind_a=ind_a
   
   # vector b
   ind_b=matrix(as.integer(c(2, 64, 116, 3, 103, 117, 4, 103, 118, 3, 105, 119, 4, 105, 120, 3, 107, 121, 4, 107, 122, 3, 109, 123, 4, 109, 124, 3, 111, 125, 4, 111, 126, 3, 113, 127, 4, 113, 128)), ncol=2+1, byrow=TRUE)
   colnames(ind_b)=c("indf", "irow", paste("indx", seq_len(1), sep=""))
   l$ind_b=ind_b
   
   # jacobian b_x
   imaxprod=seq_len(maxprod)
   ind_bx=c()
   for (ix in imaxprod) {
      i=ind_b[,2+ix]>ba_x # exclude from differentiation plain input entries
      tmp=ind_b[i,,drop=FALSE]
      ind_bx=rbind(ind_bx, tmp[,c(1,2,ix+2,2+imaxprod[-ix])]) # move diff var to ic1 place
   }
   if (length(ind_bx)) {
      colnames(ind_bx)=c("indf", "irow", "ic1", sprintf("indx%d", seq_len(maxprod-1)))
      ind_bx[,"ic1"]=ind_bx[,"ic1"]-ba_x
   }
   l$ind_bx=ind_bx
}
spAbr[[w]]=l

if (TIMEIT) {
   cat("weight 2: ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
}
w=2
nb_c=223
ba_x=128; # base of cumomer indexes in incu vector
l=new.env()
l$w=w
l$nb_c=nb_c
l$nb_fwrv=nb_fwrv
l$nb_cl=118 # number of lighter cumomers
maxprod=2
if (nb_c > 0) {
   # matrix a
   ind_a=matrix(as.integer(c(50, 0, 0, 92, 0, 0, 50, 0, 108, 92, 0, 79, 50, 1, 1, 92, 1, 1, 50, 1, 109, 92, 1, 80, 50, 2, 2, 92, 2, 2, 50, 2, 110, 92, 2, 81, 39, 3, 3, 42, 3, 3, 61, 3, 3, 39, 3, 130, 42, 3, 131, 61, 3, 132, 39, 4, 4, 42, 4, 4, 61, 4, 4, 39, 4, 133, 42, 4, 134, 61, 4, 135, 39, 5, 5, 42, 5, 5, 61, 5, 5, 39, 5, 136, 42, 5, 137, 61, 5, 138, 39, 6, 6, 42, 6, 6, 61, 6, 6, 39, 6, 139, 42, 6, 140, 61, 6, 141, 39, 7, 7, 42, 7, 7, 61, 7, 7, 39, 7, 142, 42, 7, 143, 61, 7, 144, 39, 8, 8, 42, 8, 8, 61, 8, 8, 39, 8, 145, 42, 8, 146, 61, 8, 147, 39, 9, 9, 42, 9, 9, 61, 9, 9, 39, 9, 148, 42, 9, 149, 61, 9, 150, 39, 10, 10, 42, 10, 10, 61, 10, 10, 39, 10, 151, 42, 10, 152, 61, 10, 153, 39, 11, 11, 42, 11, 11, 61, 11, 11, 39, 11, 154, 42, 11, 155, 61, 11, 156, 39, 12, 12, 42, 12, 12, 61, 12, 12, 39, 12, 157, 42, 12, 158, 61, 12, 159, 39, 13, 13, 42, 13, 13, 61, 13, 13, 39, 13, 160, 42, 13, 161, 61, 13, 162, 39, 14, 14, 42, 14, 14, 61, 14, 14, 39, 14, 163, 42, 14, 164, 61, 14, 165, 39, 15, 15, 42, 15, 15, 61, 15, 15, 39, 15, 166, 42, 15, 167, 61, 15, 168, 39, 16, 16, 42, 16, 16, 61, 16, 16, 39, 16, 169, 42, 16, 170, 61, 16, 171, 39, 17, 17, 42, 17, 17, 61, 17, 17, 39, 17, 172, 42, 17, 173, 61, 17, 174, 28, 18, 18, 28, 18, 104, 28, 19, 19, 28, 20, 20, 28, 21, 21, 28, 22, 22, 28, 23, 23, 28, 24, 24, 28, 25, 25, 28, 26, 26, 28, 27, 27, 28, 27, 120, 28, 28, 28, 28, 28, 121, 28, 29, 29, 28, 29, 123, 28, 30, 30, 28, 30, 122, 28, 31, 31, 28, 31, 124, 28, 32, 32, 28, 32, 125, 32, 33, 33, 58, 33, 33, 55, 33, 33, 110, 33, 33, 32, 33, 48, 58, 33, 114, 55, 33, 108, 110, 33, 132, 32, 34, 34, 58, 34, 34, 55, 34, 34, 110, 34, 34, 32, 34, 49, 58, 34, 115, 55, 34, 109, 110, 34, 135, 32, 35, 35, 58, 35, 35, 55, 35, 35, 110, 35, 35, 32, 35, 50, 58, 35, 116, 55, 35, 110, 110, 35, 138, 32, 36, 36, 58, 36, 36, 110, 36, 36, 55, 36, 36, 32, 36, 51, 58, 36, 117, 110, 36, 141, 32, 37, 37, 58, 37, 37, 110, 37, 37, 55, 37, 37, 32, 37, 52, 58, 37, 118, 110, 37, 144, 32, 38, 38, 58, 38, 38, 110, 38, 38, 55, 38, 38, 32, 38, 53, 58, 38, 119, 110, 38, 147, 32, 39, 39, 110, 39, 39, 58, 39, 39, 55, 39, 39, 32, 39, 54, 110, 39, 150, 32, 40, 40, 110, 40, 40, 58, 40, 40, 55, 40, 40, 32, 40, 55, 110, 40, 153, 32, 41, 41, 110, 41, 41, 58, 41, 41, 55, 41, 41, 32, 41, 56, 110, 41, 156, 32, 42, 42, 55, 42, 42, 110, 42, 42, 58, 42, 42, 32, 42, 57, 55, 42, 105, 110, 42, 159, 32, 43, 43, 110, 43, 43, 58, 43, 43, 55, 43, 43, 32, 43, 58, 110, 43, 162, 32, 44, 44, 110, 44, 44, 58, 44, 44, 55, 44, 44, 32, 44, 59, 110, 44, 165, 32, 45, 45, 110, 45, 45, 58, 45, 45, 55, 45, 45, 32, 45, 60, 110, 45, 168, 32, 46, 46, 55, 46, 46, 110, 46, 46, 58, 46, 46, 32, 46, 61, 55, 46, 106, 110, 46, 171, 32, 47, 47, 58, 47, 47, 55, 47, 47, 110, 47, 47, 32, 47, 62, 58, 47, 103, 55, 47, 107, 110, 47, 174, 8, 48, 48, 8, 48, 108, 8, 49, 49, 8, 49, 109, 8, 50, 50, 8, 50, 110, 8, 51, 51, 8, 52, 52, 8, 53, 53, 8, 54, 54, 8, 55, 55, 8, 56, 56, 8, 57, 57, 8, 57, 111, 8, 58, 58, 8, 59, 59, 8, 60, 60, 8, 61, 61, 8, 61, 112, 8, 62, 62, 8, 62, 113, 33, 63, 63, 34, 63, 63, 105, 63, 63, 33, 63, 175, 34, 63, 176, 105, 63, 125, 33, 64, 64, 34, 64, 64, 105, 64, 64, 33, 64, 177, 34, 64, 178, 105, 64, 124, 33, 65, 65, 34, 65, 65, 105, 65, 65, 33, 65, 179, 34, 65, 179, 105, 65, 122, 33, 66, 66, 34, 66, 66, 105, 66, 66, 33, 66, 180, 34, 66, 180, 105, 66, 123, 33, 67, 67, 34, 67, 67, 105, 67, 67, 33, 67, 178, 34, 67, 177, 105, 67, 121, 33, 68, 68, 34, 68, 68, 105, 68, 68, 33, 68, 176, 34, 68, 175, 105, 68, 120, 38, 69, 69, 118, 69, 69, 120, 69, 69, 38, 69, 3, 118, 69, 108, 120, 69, 82, 38, 70, 70, 118, 70, 70, 120, 70, 70, 38, 70, 4, 118, 70, 109, 120, 70, 83, 38, 71, 71, 118, 71, 71, 120, 71, 71, 38, 71, 5, 118, 71, 110, 120, 71, 84, 38, 72, 72, 120, 72, 72, 118, 72, 72, 38, 72, 6, 120, 72, 85, 38, 73, 73, 120, 73, 73, 118, 73, 73, 38, 73, 7, 120, 73, 86, 38, 74, 74, 120, 74, 74, 118, 74, 74, 38, 74, 8, 120, 74, 87, 38, 75, 75, 120, 75, 75, 118, 75, 75, 38, 75, 9, 120, 75, 88, 38, 76, 76, 120, 76, 76, 118, 76, 76, 38, 76, 10, 120, 76, 89, 38, 77, 77, 120, 77, 77, 118, 77, 77, 38, 77, 11, 120, 77, 90, 38, 78, 78, 118, 78, 78, 120, 78, 78, 38, 78, 12, 118, 78, 103, 120, 78, 91, 31, 79, 79, 51, 79, 79, 31, 79, 0, 51, 79, 122, 31, 80, 80, 51, 80, 80, 31, 80, 1, 51, 80, 121, 31, 81, 81, 51, 81, 81, 31, 81, 2, 51, 81, 120, 59, 82, 82, 117, 82, 82, 59, 82, 69, 117, 82, 114, 59, 83, 83, 117, 83, 83, 59, 83, 70, 117, 83, 115, 59, 84, 84, 117, 84, 84, 59, 84, 71, 117, 84, 116, 59, 85, 85, 117, 85, 85, 59, 85, 72, 117, 85, 117, 59, 86, 86, 117, 86, 86, 59, 86, 73, 117, 86, 118, 59, 87, 87, 117, 87, 87, 59, 87, 74, 117, 87, 119, 59, 88, 88, 117, 88, 88, 59, 88, 75, 59, 89, 89, 117, 89, 89, 59, 89, 76, 59, 90, 90, 117, 90, 90, 59, 90, 77, 59, 91, 91, 117, 91, 91, 59, 91, 78, 59, 92, 92, 117, 92, 92, 59, 93, 93, 117, 93, 93, 59, 94, 94, 117, 94, 94, 59, 95, 95, 117, 95, 95, 117, 96, 96, 59, 96, 96, 117, 96, 105, 59, 97, 97, 117, 97, 97, 59, 98, 98, 117, 98, 98, 59, 99, 99, 117, 99, 99, 59, 100, 100, 117, 100, 100, 117, 101, 101, 59, 101, 101, 117, 101, 106, 59, 102, 102, 117, 102, 102, 59, 102, 103, 117, 102, 107, 57, 103, 103, 119, 103, 103, 120, 103, 103, 57, 103, 78, 119, 103, 47, 120, 103, 102, 48, 104, 104, 48, 104, 129, 56, 105, 105, 116, 105, 105, 56, 105, 96, 116, 105, 42, 56, 106, 106, 116, 106, 106, 56, 106, 101, 116, 106, 46, 56, 107, 107, 116, 107, 107, 56, 107, 102, 116, 107, 47, 57, 108, 108, 29, 108, 108, 69, 108, 108, 121, 108, 108, 111, 108, 108, 116, 108, 108, 57, 108, 69, 29, 108, 181, 69, 108, 48, 121, 108, 113, 111, 108, 0, 116, 108, 33, 57, 109, 109, 29, 109, 109, 69, 109, 109, 121, 109, 109, 111, 109, 109, 116, 109, 109, 57, 109, 70, 29, 109, 182, 69, 109, 49, 121, 109, 112, 111, 109, 1, 116, 109, 34, 57, 110, 110, 29, 110, 110, 69, 110, 110, 121, 110, 110, 111, 110, 110, 116, 110, 110, 57, 110, 71, 29, 110, 183, 69, 110, 50, 121, 110, 111, 111, 110, 2, 116, 110, 35, 60, 111, 111, 69, 111, 111, 60, 111, 110, 69, 111, 57, 60, 112, 112, 69, 112, 112, 60, 112, 109, 69, 112, 61, 60, 113, 113, 69, 113, 113, 60, 113, 108, 69, 113, 62, 56, 114, 114, 119, 114, 114, 56, 114, 82, 119, 114, 33, 56, 115, 115, 119, 115, 115, 56, 115, 83, 119, 115, 34, 56, 116, 116, 119, 116, 116, 56, 116, 84, 119, 116, 35, 56, 117, 117, 119, 117, 117, 56, 117, 85, 119, 117, 36, 56, 118, 118, 119, 118, 118, 56, 118, 86, 119, 118, 37, 56, 119, 119, 119, 119, 119, 56, 119, 87, 119, 119, 38, 44, 120, 120, 6, 120, 120, 53, 120, 120, 44, 120, 68, 6, 120, 126, 53, 120, 127, 44, 121, 121, 53, 121, 121, 6, 121, 121, 44, 121, 67, 53, 121, 128, 44, 122, 122, 53, 122, 122, 6, 122, 122, 44, 122, 65, 53, 122, 129, 44, 123, 123, 6, 123, 123, 53, 123, 123, 44, 123, 66, 44, 124, 124, 6, 124, 124, 53, 124, 124, 44, 124, 64, 44, 125, 125, 6, 125, 125, 53, 125, 125, 44, 125, 63, 6, 125, 104, 5, 126, 126, 5, 126, 32, 54, 127, 127, 29, 127, 127, 43, 127, 127, 54, 127, 81, 29, 127, 184, 43, 127, 68, 54, 128, 128, 29, 128, 128, 43, 128, 128, 54, 128, 80, 29, 128, 185, 43, 128, 67, 54, 129, 129, 29, 129, 129, 43, 129, 129, 54, 129, 79, 29, 129, 186, 43, 129, 65, 36, 130, 130, 36, 130, 187, 41, 131, 131, 41, 131, 188, 37, 132, 132, 49, 132, 132, 37, 132, 187, 49, 132, 33, 36, 133, 133, 36, 133, 189, 41, 134, 134, 41, 134, 190, 37, 135, 135, 49, 135, 135, 37, 135, 189, 49, 135, 34, 36, 136, 136, 36, 136, 191, 41, 137, 137, 41, 137, 192, 37, 138, 138, 49, 138, 138, 37, 138, 191, 49, 138, 35, 36, 139, 139, 36, 139, 193, 41, 140, 140, 41, 140, 194, 37, 141, 141, 49, 141, 141, 37, 141, 193, 49, 141, 36, 36, 142, 142, 36, 142, 195, 41, 143, 143, 41, 143, 196, 37, 144, 144, 49, 144, 144, 37, 144, 195, 49, 144, 37, 36, 145, 145, 36, 145, 197, 41, 146, 146, 41, 146, 198, 37, 147, 147, 49, 147, 147, 37, 147, 197, 49, 147, 38, 36, 148, 148, 36, 148, 199, 41, 149, 149, 41, 149, 200, 37, 150, 150, 49, 150, 150, 37, 150, 199, 49, 150, 39, 36, 151, 151, 36, 151, 201, 41, 152, 152, 41, 152, 202, 37, 153, 153, 49, 153, 153, 37, 153, 201, 49, 153, 40, 36, 154, 154, 36, 154, 203, 41, 155, 155, 41, 155, 204, 37, 156, 156, 49, 156, 156, 37, 156, 203, 49, 156, 41, 36, 157, 157, 36, 157, 205, 41, 158, 158, 41, 158, 206, 37, 159, 159, 49, 159, 159, 37, 159, 205, 49, 159, 42, 36, 160, 160, 36, 160, 207, 41, 161, 161, 41, 161, 208, 37, 162, 162, 49, 162, 162, 37, 162, 207, 49, 162, 43, 36, 163, 163, 36, 163, 209, 41, 164, 164, 41, 164, 210, 37, 165, 165, 49, 165, 165, 37, 165, 209, 49, 165, 44, 36, 166, 166, 36, 166, 211, 41, 167, 167, 41, 167, 212, 37, 168, 168, 49, 168, 168, 37, 168, 211, 49, 168, 45, 36, 169, 169, 36, 169, 213, 41, 170, 170, 41, 170, 214, 37, 171, 171, 49, 171, 171, 37, 171, 213, 49, 171, 46, 36, 172, 172, 36, 172, 215, 41, 173, 173, 41, 173, 216, 37, 174, 174, 49, 174, 174, 37, 174, 215, 49, 174, 47, 7, 175, 175, 5, 175, 175, 94, 175, 175, 95, 175, 175, 7, 175, 217, 5, 175, 18, 94, 175, 63, 95, 175, 68, 7, 176, 176, 5, 176, 176, 94, 176, 176, 95, 176, 176, 7, 176, 218, 5, 176, 27, 94, 176, 68, 95, 176, 63, 7, 177, 177, 5, 177, 177, 94, 177, 177, 95, 177, 177, 7, 177, 219, 5, 177, 20, 94, 177, 64, 95, 177, 67, 7, 178, 178, 5, 178, 178, 94, 178, 178, 95, 178, 178, 7, 178, 220, 5, 178, 23, 94, 178, 67, 95, 178, 64, 7, 179, 179, 5, 179, 179, 94, 179, 179, 95, 179, 179, 7, 179, 221, 5, 179, 24, 94, 179, 65, 95, 179, 65, 7, 180, 180, 5, 180, 180, 94, 180, 180, 95, 180, 180, 7, 180, 222, 5, 180, 19, 94, 180, 66, 95, 180, 66, 30, 181, 181, 30, 181, 3, 30, 182, 182, 30, 182, 4, 30, 183, 183, 30, 183, 5, 30, 184, 184, 30, 184, 17, 30, 185, 185, 30, 185, 16, 30, 186, 186, 30, 186, 12, 3, 187, 187, 4, 187, 187, 35, 188, 188, 35, 188, 130, 3, 189, 189, 4, 189, 189, 35, 190, 190, 35, 190, 133, 3, 191, 191, 4, 191, 191, 35, 192, 192, 35, 192, 136, 3, 193, 193, 4, 193, 193, 35, 194, 194, 35, 194, 139, 3, 195, 195, 4, 195, 195, 35, 196, 196, 35, 196, 142, 3, 197, 197, 4, 197, 197, 35, 198, 198, 35, 198, 145, 3, 199, 199, 4, 199, 199, 35, 200, 200, 35, 200, 148, 3, 201, 201, 4, 201, 201, 35, 202, 202, 35, 202, 151, 3, 203, 203, 4, 203, 203, 35, 204, 204, 35, 204, 154, 3, 205, 205, 4, 205, 205, 35, 206, 206, 35, 206, 157, 3, 207, 207, 4, 207, 207, 35, 208, 208, 35, 208, 160, 3, 209, 209, 4, 209, 209, 35, 210, 210, 35, 210, 163, 3, 211, 211, 4, 211, 211, 35, 212, 212, 35, 212, 166, 3, 213, 213, 4, 213, 213, 35, 214, 214, 35, 214, 169, 3, 215, 215, 4, 215, 215, 35, 216, 216, 35, 216, 172, 40, 217, 217, 40, 217, 18, 40, 218, 218, 40, 218, 30, 40, 219, 219, 40, 219, 20, 40, 220, 220, 40, 220, 25, 40, 221, 221, 40, 221, 24, 40, 222, 222, 40, 222, 21)), ncol=3, byrow=TRUE)
   colnames(ind_a)=c("indf", "ir0", "ic0")
   l$ind_a=ind_a
   
   # vector b
   ind_b=matrix(as.integer(c(28, 20, 177, 193, 28, 21, 177, 194, 28, 22, 177, 195, 28, 23, 177, 196, 28, 24, 178, 193, 28, 25, 178, 194, 28, 26, 178, 195, 28, 27, 178, 196, 55, 37, 182, 179, 55, 38, 183, 179, 55, 39, 184, 179, 58, 40, 188, 175, 55, 40, 182, 180, 58, 41, 189, 175, 55, 41, 183, 180, 58, 42, 190, 175, 55, 42, 184, 180, 58, 43, 191, 175, 58, 44, 188, 176, 55, 44, 182, 181, 58, 45, 189, 176, 55, 45, 183, 181, 58, 46, 190, 176, 55, 46, 184, 181, 58, 47, 191, 176, 8, 52, 185, 182, 8, 53, 185, 183, 8, 54, 185, 184, 8, 55, 186, 182, 8, 56, 186, 183, 8, 57, 186, 184, 8, 59, 187, 182, 8, 60, 187, 183, 8, 61, 187, 184, 118, 73, 182, 175, 118, 74, 183, 175, 118, 75, 184, 175, 118, 76, 182, 176, 118, 77, 183, 176, 118, 78, 184, 176, 117, 89, 188, 179, 117, 90, 189, 179, 117, 91, 190, 179, 117, 92, 191, 179, 59, 93, 160, 175, 117, 93, 188, 180, 59, 94, 161, 175, 117, 94, 189, 180, 59, 95, 162, 175, 117, 95, 190, 180, 59, 96, 163, 175, 117, 96, 191, 180, 59, 97, 164, 175, 59, 98, 160, 176, 117, 98, 188, 181, 59, 99, 161, 176, 117, 99, 189, 181, 59, 100, 162, 176, 117, 100, 190, 181, 59, 101, 163, 176, 117, 101, 191, 181, 59, 102, 164, 176, 6, 122, 197, 178, 6, 123, 198, 178, 6, 124, 197, 177, 53, 124, 199, 192, 6, 125, 198, 177, 53, 125, 200, 192, 53, 126, 201, 192, 3, 188, 86, 1, 4, 188, 87, 1, 3, 190, 88, 1, 4, 190, 89, 1, 3, 192, 90, 1, 4, 192, 91, 1, 3, 194, 92, 1, 4, 194, 93, 1, 3, 196, 94, 1, 4, 196, 95, 1, 3, 198, 96, 1, 4, 198, 97, 1, 3, 200, 98, 1, 4, 200, 99, 1, 3, 202, 100, 1, 4, 202, 101, 1, 3, 204, 102, 1, 4, 204, 103, 1, 3, 206, 104, 1, 4, 206, 105, 1, 3, 208, 106, 1, 4, 208, 107, 1, 3, 210, 108, 1, 4, 210, 109, 1, 3, 212, 110, 1, 4, 212, 111, 1, 3, 214, 112, 1, 4, 214, 113, 1, 3, 216, 114, 1, 4, 216, 115, 1)), ncol=2+2, byrow=TRUE)
   colnames(ind_b)=c("indf", "irow", paste("indx", seq_len(2), sep=""))
   l$ind_b=ind_b
   
   # jacobian b_x
   imaxprod=seq_len(maxprod)
   ind_bx=c()
   for (ix in imaxprod) {
      i=ind_b[,2+ix]>ba_x # exclude from differentiation plain input entries
      tmp=ind_b[i,,drop=FALSE]
      ind_bx=rbind(ind_bx, tmp[,c(1,2,ix+2,2+imaxprod[-ix])]) # move diff var to ic1 place
   }
   if (length(ind_bx)) {
      colnames(ind_bx)=c("indf", "irow", "ic1", sprintf("indx%d", seq_len(maxprod-1)))
      ind_bx[,"ic1"]=ind_bx[,"ic1"]-ba_x
   }
   l$ind_bx=ind_bx
}
spAbr[[w]]=l

if (TIMEIT) {
   cat("weight 3: ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
}
w=3
nb_c=253
ba_x=128; # base of cumomer indexes in incu vector
l=new.env()
l$w=w
l$nb_c=nb_c
l$nb_fwrv=nb_fwrv
l$nb_cl=341 # number of lighter cumomers
maxprod=2
if (nb_c > 0) {
   # matrix a
   ind_a=matrix(as.integer(c(50, 0, 0, 92, 0, 0, 50, 0, 132, 92, 0, 95, 39, 1, 1, 42, 1, 1, 61, 1, 1, 39, 1, 143, 42, 1, 144, 61, 1, 145, 39, 2, 2, 42, 2, 2, 61, 2, 2, 39, 2, 146, 42, 2, 147, 61, 2, 148, 39, 3, 3, 42, 3, 3, 61, 3, 3, 39, 3, 149, 42, 3, 150, 61, 3, 151, 39, 4, 4, 42, 4, 4, 61, 4, 4, 39, 4, 152, 42, 4, 153, 61, 4, 154, 39, 5, 5, 42, 5, 5, 61, 5, 5, 39, 5, 155, 42, 5, 156, 61, 5, 157, 39, 6, 6, 42, 6, 6, 61, 6, 6, 39, 6, 158, 42, 6, 159, 61, 6, 160, 39, 7, 7, 42, 7, 7, 61, 7, 7, 39, 7, 161, 42, 7, 162, 61, 7, 163, 39, 8, 8, 42, 8, 8, 61, 8, 8, 39, 8, 164, 42, 8, 165, 61, 8, 166, 39, 9, 9, 42, 9, 9, 61, 9, 9, 39, 9, 167, 42, 9, 168, 61, 9, 169, 39, 10, 10, 42, 10, 10, 61, 10, 10, 39, 10, 170, 42, 10, 171, 61, 10, 172, 39, 11, 11, 42, 11, 11, 61, 11, 11, 39, 11, 173, 42, 11, 174, 61, 11, 175, 39, 12, 12, 42, 12, 12, 61, 12, 12, 39, 12, 176, 42, 12, 177, 61, 12, 178, 39, 13, 13, 42, 13, 13, 61, 13, 13, 39, 13, 179, 42, 13, 180, 61, 13, 181, 39, 14, 14, 42, 14, 14, 61, 14, 14, 39, 14, 182, 42, 14, 183, 61, 14, 184, 39, 15, 15, 42, 15, 15, 61, 15, 15, 39, 15, 185, 42, 15, 186, 61, 15, 187, 39, 16, 16, 42, 16, 16, 61, 16, 16, 39, 16, 188, 42, 16, 189, 61, 16, 190, 39, 17, 17, 42, 17, 17, 61, 17, 17, 39, 17, 191, 42, 17, 192, 61, 17, 193, 39, 18, 18, 42, 18, 18, 61, 18, 18, 39, 18, 194, 42, 18, 195, 61, 18, 196, 39, 19, 19, 42, 19, 19, 61, 19, 19, 39, 19, 197, 42, 19, 198, 61, 19, 199, 39, 20, 20, 42, 20, 20, 61, 20, 20, 39, 20, 200, 42, 20, 201, 61, 20, 202, 28, 21, 21, 28, 22, 22, 28, 23, 23, 28, 24, 24, 28, 25, 25, 28, 26, 26, 28, 27, 27, 28, 28, 28, 28, 29, 29, 28, 30, 30, 28, 31, 31, 28, 32, 32, 28, 33, 33, 28, 34, 34, 28, 35, 35, 28, 36, 36, 28, 37, 37, 28, 37, 138, 28, 38, 38, 28, 38, 139, 28, 39, 39, 28, 39, 140, 28, 40, 40, 28, 40, 141, 32, 41, 41, 58, 41, 41, 55, 41, 41, 110, 41, 41, 32, 41, 61, 58, 41, 134, 55, 41, 132, 110, 41, 145, 32, 42, 42, 58, 42, 42, 110, 42, 42, 55, 42, 42, 32, 42, 62, 58, 42, 135, 110, 42, 148, 32, 43, 43, 58, 43, 43, 110, 43, 43, 55, 43, 43, 32, 43, 63, 58, 43, 136, 110, 43, 151, 32, 44, 44, 58, 44, 44, 110, 44, 44, 55, 44, 44, 32, 44, 64, 58, 44, 137, 110, 44, 154, 32, 45, 45, 110, 45, 45, 58, 45, 45, 55, 45, 45, 32, 45, 65, 110, 45, 157, 32, 46, 46, 110, 46, 46, 58, 46, 46, 55, 46, 46, 32, 46, 66, 110, 46, 160, 32, 47, 47, 110, 47, 47, 58, 47, 47, 55, 47, 47, 32, 47, 67, 110, 47, 163, 32, 48, 48, 110, 48, 48, 58, 48, 48, 55, 48, 48, 32, 48, 68, 110, 48, 166, 32, 49, 49, 110, 49, 49, 58, 49, 49, 55, 49, 49, 32, 49, 69, 110, 49, 169, 32, 50, 50, 110, 50, 50, 58, 50, 50, 55, 50, 50, 32, 50, 70, 110, 50, 172, 32, 51, 51, 110, 51, 51, 58, 51, 51, 55, 51, 51, 32, 51, 71, 110, 51, 175, 32, 52, 52, 110, 52, 52, 58, 52, 52, 55, 52, 52, 32, 52, 72, 110, 52, 178, 32, 53, 53, 110, 53, 53, 58, 53, 53, 55, 53, 53, 32, 53, 73, 110, 53, 181, 32, 54, 54, 110, 54, 54, 58, 54, 54, 55, 54, 54, 32, 54, 74, 110, 54, 184, 32, 55, 55, 110, 55, 55, 58, 55, 55, 55, 55, 55, 32, 55, 75, 110, 55, 187, 32, 56, 56, 110, 56, 56, 58, 56, 56, 55, 56, 56, 32, 56, 76, 110, 56, 190, 32, 57, 57, 110, 57, 57, 58, 57, 57, 55, 57, 57, 32, 57, 77, 110, 57, 193, 32, 58, 58, 110, 58, 58, 58, 58, 58, 55, 58, 58, 32, 58, 78, 110, 58, 196, 32, 59, 59, 110, 59, 59, 58, 59, 59, 55, 59, 59, 32, 59, 79, 110, 59, 199, 32, 60, 60, 55, 60, 60, 110, 60, 60, 58, 60, 60, 32, 60, 80, 55, 60, 131, 110, 60, 202, 8, 61, 61, 8, 61, 132, 8, 62, 62, 8, 63, 63, 8, 64, 64, 8, 65, 65, 8, 66, 66, 8, 67, 67, 8, 68, 68, 8, 69, 69, 8, 70, 70, 8, 71, 71, 8, 72, 72, 8, 73, 73, 8, 74, 74, 8, 75, 75, 8, 76, 76, 8, 77, 77, 8, 78, 78, 8, 79, 79, 8, 80, 80, 8, 80, 133, 33, 81, 81, 34, 81, 81, 105, 81, 81, 33, 81, 203, 34, 81, 204, 105, 81, 141, 33, 82, 82, 34, 82, 82, 105, 82, 82, 33, 82, 205, 34, 82, 206, 105, 82, 140, 33, 83, 83, 34, 83, 83, 105, 83, 83, 33, 83, 206, 34, 83, 205, 105, 83, 139, 33, 84, 84, 34, 84, 84, 105, 84, 84, 33, 84, 204, 34, 84, 203, 105, 84, 138, 38, 85, 85, 118, 85, 85, 120, 85, 85, 38, 85, 1, 118, 85, 132, 120, 85, 96, 38, 86, 86, 120, 86, 86, 118, 86, 86, 38, 86, 2, 120, 86, 97, 38, 87, 87, 120, 87, 87, 118, 87, 87, 38, 87, 3, 120, 87, 98, 38, 88, 88, 120, 88, 88, 118, 88, 88, 38, 88, 4, 120, 88, 99, 38, 89, 89, 120, 89, 89, 118, 89, 89, 38, 89, 5, 120, 89, 100, 38, 90, 90, 120, 90, 90, 118, 90, 90, 38, 90, 6, 120, 90, 101, 38, 91, 91, 120, 91, 91, 118, 91, 91, 38, 91, 7, 120, 91, 102, 38, 92, 92, 120, 92, 92, 118, 92, 92, 38, 92, 8, 120, 92, 103, 38, 93, 93, 120, 93, 93, 118, 93, 93, 38, 93, 9, 120, 93, 104, 38, 94, 94, 120, 94, 94, 118, 94, 94, 38, 94, 10, 120, 94, 105, 31, 95, 95, 51, 95, 95, 31, 95, 0, 51, 95, 138, 59, 96, 96, 117, 96, 96, 59, 96, 85, 117, 96, 134, 59, 97, 97, 117, 97, 97, 59, 97, 86, 117, 97, 135, 59, 98, 98, 117, 98, 98, 59, 98, 87, 117, 98, 136, 59, 99, 99, 117, 99, 99, 59, 99, 88, 117, 99, 137, 59, 100, 100, 117, 100, 100, 59, 100, 89, 59, 101, 101, 117, 101, 101, 59, 101, 90, 59, 102, 102, 117, 102, 102, 59, 102, 91, 59, 103, 103, 117, 103, 103, 59, 103, 92, 59, 104, 104, 117, 104, 104, 59, 104, 93, 59, 105, 105, 117, 105, 105, 59, 105, 94, 59, 106, 106, 117, 106, 106, 59, 107, 107, 117, 107, 107, 59, 108, 108, 117, 108, 108, 59, 109, 109, 117, 109, 109, 59, 110, 110, 117, 110, 110, 59, 111, 111, 117, 111, 111, 59, 112, 112, 117, 112, 112, 59, 113, 113, 117, 113, 113, 59, 114, 114, 117, 114, 114, 59, 115, 115, 117, 115, 115, 59, 116, 116, 117, 116, 116, 59, 117, 117, 117, 117, 117, 59, 118, 118, 117, 118, 118, 59, 119, 119, 117, 119, 119, 59, 120, 120, 117, 120, 120, 59, 121, 121, 117, 121, 121, 59, 122, 122, 117, 122, 122, 59, 123, 123, 117, 123, 123, 59, 124, 124, 117, 124, 124, 59, 125, 125, 117, 125, 125, 59, 126, 126, 117, 126, 126, 59, 127, 127, 117, 127, 127, 59, 128, 128, 117, 128, 128, 59, 129, 129, 117, 129, 129, 117, 130, 130, 59, 130, 130, 117, 130, 131, 56, 131, 131, 116, 131, 131, 56, 131, 130, 116, 131, 60, 57, 132, 132, 29, 132, 132, 69, 132, 132, 121, 132, 132, 111, 132, 132, 116, 132, 132, 57, 132, 85, 29, 132, 207, 69, 132, 61, 121, 132, 133, 111, 132, 0, 116, 132, 41, 60, 133, 133, 69, 133, 133, 60, 133, 132, 69, 133, 80, 56, 134, 134, 119, 134, 134, 56, 134, 96, 119, 134, 41, 56, 135, 135, 119, 135, 135, 56, 135, 97, 119, 135, 42, 56, 136, 136, 119, 136, 136, 56, 136, 98, 119, 136, 43, 56, 137, 137, 119, 137, 137, 56, 137, 99, 119, 137, 44, 44, 138, 138, 53, 138, 138, 6, 138, 138, 44, 138, 84, 53, 138, 142, 44, 139, 139, 6, 139, 139, 53, 139, 139, 44, 139, 83, 44, 140, 140, 6, 140, 140, 53, 140, 140, 44, 140, 82, 44, 141, 141, 6, 141, 141, 53, 141, 141, 44, 141, 81, 54, 142, 142, 29, 142, 142, 43, 142, 142, 54, 142, 95, 29, 142, 208, 43, 142, 84, 36, 143, 143, 36, 143, 209, 41, 144, 144, 41, 144, 210, 37, 145, 145, 49, 145, 145, 37, 145, 209, 49, 145, 41, 36, 146, 146, 36, 146, 211, 41, 147, 147, 41, 147, 212, 37, 148, 148, 49, 148, 148, 37, 148, 211, 49, 148, 42, 36, 149, 149, 36, 149, 213, 41, 150, 150, 41, 150, 214, 37, 151, 151, 49, 151, 151, 37, 151, 213, 49, 151, 43, 36, 152, 152, 36, 152, 215, 41, 153, 153, 41, 153, 216, 37, 154, 154, 49, 154, 154, 37, 154, 215, 49, 154, 44, 36, 155, 155, 36, 155, 217, 41, 156, 156, 41, 156, 218, 37, 157, 157, 49, 157, 157, 37, 157, 217, 49, 157, 45, 36, 158, 158, 36, 158, 219, 41, 159, 159, 41, 159, 220, 37, 160, 160, 49, 160, 160, 37, 160, 219, 49, 160, 46, 36, 161, 161, 36, 161, 221, 41, 162, 162, 41, 162, 222, 37, 163, 163, 49, 163, 163, 37, 163, 221, 49, 163, 47, 36, 164, 164, 36, 164, 223, 41, 165, 165, 41, 165, 224, 37, 166, 166, 49, 166, 166, 37, 166, 223, 49, 166, 48, 36, 167, 167, 36, 167, 225, 41, 168, 168, 41, 168, 226, 37, 169, 169, 49, 169, 169, 37, 169, 225, 49, 169, 49, 36, 170, 170, 36, 170, 227, 41, 171, 171, 41, 171, 228, 37, 172, 172, 49, 172, 172, 37, 172, 227, 49, 172, 50, 36, 173, 173, 36, 173, 229, 41, 174, 174, 41, 174, 230, 37, 175, 175, 49, 175, 175, 37, 175, 229, 49, 175, 51, 36, 176, 176, 36, 176, 231, 41, 177, 177, 41, 177, 232, 37, 178, 178, 49, 178, 178, 37, 178, 231, 49, 178, 52, 36, 179, 179, 36, 179, 233, 41, 180, 180, 41, 180, 234, 37, 181, 181, 49, 181, 181, 37, 181, 233, 49, 181, 53, 36, 182, 182, 36, 182, 235, 41, 183, 183, 41, 183, 236, 37, 184, 184, 49, 184, 184, 37, 184, 235, 49, 184, 54, 36, 185, 185, 36, 185, 237, 41, 186, 186, 41, 186, 238, 37, 187, 187, 49, 187, 187, 37, 187, 237, 49, 187, 55, 36, 188, 188, 36, 188, 239, 41, 189, 189, 41, 189, 240, 37, 190, 190, 49, 190, 190, 37, 190, 239, 49, 190, 56, 36, 191, 191, 36, 191, 241, 41, 192, 192, 41, 192, 242, 37, 193, 193, 49, 193, 193, 37, 193, 241, 49, 193, 57, 36, 194, 194, 36, 194, 243, 41, 195, 195, 41, 195, 244, 37, 196, 196, 49, 196, 196, 37, 196, 243, 49, 196, 58, 36, 197, 197, 36, 197, 245, 41, 198, 198, 41, 198, 246, 37, 199, 199, 49, 199, 199, 37, 199, 245, 49, 199, 59, 36, 200, 200, 36, 200, 247, 41, 201, 201, 41, 201, 248, 37, 202, 202, 49, 202, 202, 37, 202, 247, 49, 202, 60, 7, 203, 203, 5, 203, 203, 94, 203, 203, 95, 203, 203, 7, 203, 249, 5, 203, 22, 94, 203, 81, 95, 203, 84, 7, 204, 204, 5, 204, 204, 94, 204, 204, 95, 204, 204, 7, 204, 250, 5, 204, 31, 94, 204, 84, 95, 204, 81, 7, 205, 205, 5, 205, 205, 94, 205, 205, 95, 205, 205, 7, 205, 251, 5, 205, 21, 94, 205, 82, 95, 205, 83, 7, 206, 206, 5, 206, 206, 94, 206, 206, 95, 206, 206, 7, 206, 252, 5, 206, 23, 94, 206, 83, 95, 206, 82, 30, 207, 207, 30, 207, 1, 30, 208, 208, 30, 208, 20, 3, 209, 209, 4, 209, 209, 35, 210, 210, 35, 210, 143, 3, 211, 211, 4, 211, 211, 35, 212, 212, 35, 212, 146, 3, 213, 213, 4, 213, 213, 35, 214, 214, 35, 214, 149, 3, 215, 215, 4, 215, 215, 35, 216, 216, 35, 216, 152, 3, 217, 217, 4, 217, 217, 35, 218, 218, 35, 218, 155, 3, 219, 219, 4, 219, 219, 35, 220, 220, 35, 220, 158, 3, 221, 221, 4, 221, 221, 35, 222, 222, 35, 222, 161, 3, 223, 223, 4, 223, 223, 35, 224, 224, 35, 224, 164, 3, 225, 225, 4, 225, 225, 35, 226, 226, 35, 226, 167, 3, 227, 227, 4, 227, 227, 35, 228, 228, 35, 228, 170, 3, 229, 229, 4, 229, 229, 35, 230, 230, 35, 230, 173, 3, 231, 231, 4, 231, 231, 35, 232, 232, 35, 232, 176, 3, 233, 233, 4, 233, 233, 35, 234, 234, 35, 234, 179, 3, 235, 235, 4, 235, 235, 35, 236, 236, 35, 236, 182, 3, 237, 237, 4, 237, 237, 35, 238, 238, 35, 238, 185, 3, 239, 239, 4, 239, 239, 35, 240, 240, 35, 240, 188, 3, 241, 241, 4, 241, 241, 35, 242, 242, 35, 242, 191, 3, 243, 243, 4, 243, 243, 35, 244, 244, 35, 244, 194, 3, 245, 245, 4, 245, 245, 35, 246, 246, 35, 246, 197, 3, 247, 247, 4, 247, 247, 35, 248, 248, 35, 248, 200, 40, 249, 249, 40, 249, 22, 40, 250, 250, 40, 250, 33, 40, 251, 251, 40, 251, 24, 40, 252, 252, 40, 252, 26)), ncol=3, byrow=TRUE)
   colnames(ind_a)=c("indf", "ir0", "ic0")
   l$ind_a=ind_a
   
   # vector b
   ind_b=matrix(as.integer(c(28, 22, 351, 193, 28, 23, 351, 194, 28, 24, 177, 367, 28, 25, 351, 195, 28, 26, 177, 368, 28, 27, 177, 369, 28, 28, 351, 196, 28, 29, 177, 370, 28, 30, 177, 371, 28, 31, 177, 372, 28, 32, 178, 367, 28, 33, 178, 368, 28, 34, 178, 369, 28, 35, 178, 370, 28, 36, 178, 371, 28, 37, 178, 372, 55, 43, 355, 179, 55, 44, 356, 179, 55, 45, 357, 179, 58, 46, 361, 175, 55, 46, 355, 180, 58, 47, 362, 175, 55, 47, 356, 180, 58, 48, 363, 175, 55, 48, 357, 180, 58, 49, 364, 175, 55, 49, 182, 352, 58, 50, 365, 175, 55, 50, 183, 352, 58, 51, 366, 175, 55, 51, 184, 352, 58, 52, 361, 176, 55, 52, 355, 181, 58, 53, 362, 176, 55, 53, 356, 181, 58, 54, 363, 176, 55, 54, 357, 181, 58, 55, 364, 176, 55, 55, 182, 353, 58, 56, 365, 176, 55, 56, 183, 353, 58, 57, 366, 176, 55, 57, 184, 353, 58, 58, 188, 350, 55, 58, 182, 354, 58, 59, 189, 350, 55, 59, 183, 354, 58, 60, 190, 350, 55, 60, 184, 354, 58, 61, 191, 350, 8, 63, 185, 355, 8, 64, 185, 356, 8, 65, 185, 357, 8, 66, 186, 355, 8, 67, 186, 356, 8, 68, 186, 357, 8, 69, 358, 182, 8, 70, 358, 183, 8, 71, 358, 184, 8, 72, 187, 355, 8, 73, 187, 356, 8, 74, 187, 357, 8, 75, 359, 182, 8, 76, 359, 183, 8, 77, 359, 184, 8, 78, 360, 182, 8, 79, 360, 183, 8, 80, 360, 184, 118, 87, 355, 175, 118, 88, 356, 175, 118, 89, 357, 175, 118, 90, 355, 176, 118, 91, 356, 176, 118, 92, 357, 176, 118, 93, 182, 350, 118, 94, 183, 350, 118, 95, 184, 350, 117, 101, 361, 179, 117, 102, 362, 179, 117, 103, 363, 179, 117, 104, 364, 179, 117, 105, 365, 179, 117, 106, 366, 179, 59, 107, 316, 175, 117, 107, 361, 180, 59, 108, 317, 175, 117, 108, 362, 180, 59, 109, 318, 175, 117, 109, 363, 180, 59, 110, 319, 175, 117, 110, 364, 180, 59, 111, 320, 175, 117, 111, 365, 180, 59, 112, 321, 175, 117, 112, 366, 180, 59, 113, 322, 175, 117, 113, 188, 352, 59, 114, 323, 175, 117, 114, 189, 352, 59, 115, 324, 175, 117, 115, 190, 352, 59, 116, 325, 175, 117, 116, 191, 352, 59, 117, 316, 176, 117, 117, 361, 181, 59, 118, 317, 176, 117, 118, 362, 181, 59, 119, 318, 176, 117, 119, 363, 181, 59, 120, 319, 176, 117, 120, 364, 181, 59, 121, 320, 176, 117, 121, 365, 181, 59, 122, 321, 176, 117, 122, 366, 181, 59, 123, 322, 176, 117, 123, 188, 353, 59, 124, 323, 176, 117, 124, 189, 353, 59, 125, 324, 176, 117, 125, 190, 353, 59, 126, 325, 176, 117, 126, 191, 353, 59, 127, 160, 350, 117, 127, 188, 354, 59, 128, 161, 350, 117, 128, 189, 354, 59, 129, 162, 350, 117, 129, 190, 354, 59, 130, 163, 350, 117, 130, 191, 354, 59, 131, 164, 350, 6, 139, 373, 178, 6, 140, 373, 177, 53, 140, 374, 192, 6, 141, 197, 351, 53, 141, 375, 192, 6, 142, 198, 351, 53, 142, 376, 192, 3, 210, 46, 1, 4, 210, 47, 1, 3, 212, 48, 1, 4, 212, 49, 1, 3, 214, 50, 1, 4, 214, 51, 1, 3, 216, 52, 1, 4, 216, 53, 1, 3, 218, 54, 1, 4, 218, 55, 1, 3, 220, 56, 1, 4, 220, 57, 1, 3, 222, 58, 1, 4, 222, 59, 1, 3, 224, 60, 1, 4, 224, 61, 1, 3, 226, 62, 1, 4, 226, 63, 1, 3, 228, 64, 1, 4, 228, 65, 1, 3, 230, 66, 1, 4, 230, 67, 1, 3, 232, 68, 1, 4, 232, 69, 1, 3, 234, 70, 1, 4, 234, 71, 1, 3, 236, 72, 1, 4, 236, 73, 1, 3, 238, 74, 1, 4, 238, 75, 1, 3, 240, 76, 1, 4, 240, 77, 1, 3, 242, 78, 1, 4, 242, 79, 1, 3, 244, 80, 1, 4, 244, 81, 1, 3, 246, 82, 1, 4, 246, 83, 1, 3, 248, 84, 1, 4, 248, 85, 1)), ncol=2+2, byrow=TRUE)
   colnames(ind_b)=c("indf", "irow", paste("indx", seq_len(2), sep=""))
   l$ind_b=ind_b
   
   # jacobian b_x
   imaxprod=seq_len(maxprod)
   ind_bx=c()
   for (ix in imaxprod) {
      i=ind_b[,2+ix]>ba_x # exclude from differentiation plain input entries
      tmp=ind_b[i,,drop=FALSE]
      ind_bx=rbind(ind_bx, tmp[,c(1,2,ix+2,2+imaxprod[-ix])]) # move diff var to ic1 place
   }
   if (length(ind_bx)) {
      colnames(ind_bx)=c("indf", "irow", "ic1", sprintf("indx%d", seq_len(maxprod-1)))
      ind_bx[,"ic1"]=ind_bx[,"ic1"]-ba_x
   }
   l$ind_bx=ind_bx
}
spAbr[[w]]=l

if (TIMEIT) {
   cat("weight 4: ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
}
w=4
nb_c=180
ba_x=128; # base of cumomer indexes in incu vector
l=new.env()
l$w=w
l$nb_c=nb_c
l$nb_fwrv=nb_fwrv
l$nb_cl=594 # number of lighter cumomers
maxprod=2
if (nb_c > 0) {
   # matrix a
   ind_a=matrix(as.integer(c(39, 0, 0, 42, 0, 0, 61, 0, 0, 39, 0, 103, 42, 0, 104, 61, 0, 105, 39, 1, 1, 42, 1, 1, 61, 1, 1, 39, 1, 106, 42, 1, 107, 61, 1, 108, 39, 2, 2, 42, 2, 2, 61, 2, 2, 39, 2, 109, 42, 2, 110, 61, 2, 111, 39, 3, 3, 42, 3, 3, 61, 3, 3, 39, 3, 112, 42, 3, 113, 61, 3, 114, 39, 4, 4, 42, 4, 4, 61, 4, 4, 39, 4, 115, 42, 4, 116, 61, 4, 117, 39, 5, 5, 42, 5, 5, 61, 5, 5, 39, 5, 118, 42, 5, 119, 61, 5, 120, 39, 6, 6, 42, 6, 6, 61, 6, 6, 39, 6, 121, 42, 6, 122, 61, 6, 123, 39, 7, 7, 42, 7, 7, 61, 7, 7, 39, 7, 124, 42, 7, 125, 61, 7, 126, 39, 8, 8, 42, 8, 8, 61, 8, 8, 39, 8, 127, 42, 8, 128, 61, 8, 129, 39, 9, 9, 42, 9, 9, 61, 9, 9, 39, 9, 130, 42, 9, 131, 61, 9, 132, 39, 10, 10, 42, 10, 10, 61, 10, 10, 39, 10, 133, 42, 10, 134, 61, 10, 135, 39, 11, 11, 42, 11, 11, 61, 11, 11, 39, 11, 136, 42, 11, 137, 61, 11, 138, 39, 12, 12, 42, 12, 12, 61, 12, 12, 39, 12, 139, 42, 12, 140, 61, 12, 141, 39, 13, 13, 42, 13, 13, 61, 13, 13, 39, 13, 142, 42, 13, 143, 61, 13, 144, 39, 14, 14, 42, 14, 14, 61, 14, 14, 39, 14, 145, 42, 14, 146, 61, 14, 147, 28, 15, 15, 28, 16, 16, 28, 17, 17, 28, 18, 18, 28, 19, 19, 28, 20, 20, 28, 21, 21, 28, 22, 22, 28, 23, 23, 28, 24, 24, 28, 25, 25, 28, 26, 26, 28, 27, 27, 28, 28, 28, 28, 29, 29, 28, 29, 102, 32, 30, 30, 58, 30, 30, 110, 30, 30, 55, 30, 30, 32, 30, 45, 58, 30, 101, 110, 30, 105, 32, 31, 31, 110, 31, 31, 58, 31, 31, 55, 31, 31, 32, 31, 46, 110, 31, 108, 32, 32, 32, 110, 32, 32, 58, 32, 32, 55, 32, 32, 32, 32, 47, 110, 32, 111, 32, 33, 33, 110, 33, 33, 58, 33, 33, 55, 33, 33, 32, 33, 48, 110, 33, 114, 32, 34, 34, 110, 34, 34, 58, 34, 34, 55, 34, 34, 32, 34, 49, 110, 34, 117, 32, 35, 35, 110, 35, 35, 58, 35, 35, 55, 35, 35, 32, 35, 50, 110, 35, 120, 32, 36, 36, 110, 36, 36, 58, 36, 36, 55, 36, 36, 32, 36, 51, 110, 36, 123, 32, 37, 37, 110, 37, 37, 58, 37, 37, 55, 37, 37, 32, 37, 52, 110, 37, 126, 32, 38, 38, 110, 38, 38, 58, 38, 38, 55, 38, 38, 32, 38, 53, 110, 38, 129, 32, 39, 39, 110, 39, 39, 58, 39, 39, 55, 39, 39, 32, 39, 54, 110, 39, 132, 32, 40, 40, 110, 40, 40, 58, 40, 40, 55, 40, 40, 32, 40, 55, 110, 40, 135, 32, 41, 41, 110, 41, 41, 58, 41, 41, 55, 41, 41, 32, 41, 56, 110, 41, 138, 32, 42, 42, 110, 42, 42, 58, 42, 42, 55, 42, 42, 32, 42, 57, 110, 42, 141, 32, 43, 43, 110, 43, 43, 58, 43, 43, 55, 43, 43, 32, 43, 58, 110, 43, 144, 32, 44, 44, 110, 44, 44, 58, 44, 44, 55, 44, 44, 32, 44, 59, 110, 44, 147, 8, 45, 45, 8, 46, 46, 8, 47, 47, 8, 48, 48, 8, 49, 49, 8, 50, 50, 8, 51, 51, 8, 52, 52, 8, 53, 53, 8, 54, 54, 8, 55, 55, 8, 56, 56, 8, 57, 57, 8, 58, 58, 8, 59, 59, 33, 60, 60, 34, 60, 60, 105, 60, 60, 33, 60, 148, 34, 60, 148, 105, 60, 102, 38, 61, 61, 120, 61, 61, 118, 61, 61, 38, 61, 0, 120, 61, 66, 38, 62, 62, 120, 62, 62, 118, 62, 62, 38, 62, 1, 120, 62, 67, 38, 63, 63, 120, 63, 63, 118, 63, 63, 38, 63, 2, 120, 63, 68, 38, 64, 64, 120, 64, 64, 118, 64, 64, 38, 64, 3, 120, 64, 69, 38, 65, 65, 120, 65, 65, 118, 65, 65, 38, 65, 4, 120, 65, 70, 59, 66, 66, 117, 66, 66, 59, 66, 61, 117, 66, 101, 59, 67, 67, 117, 67, 67, 59, 67, 62, 59, 68, 68, 117, 68, 68, 59, 68, 63, 59, 69, 69, 117, 69, 69, 59, 69, 64, 59, 70, 70, 117, 70, 70, 59, 70, 65, 59, 71, 71, 117, 71, 71, 59, 72, 72, 117, 72, 72, 59, 73, 73, 117, 73, 73, 59, 74, 74, 117, 74, 74, 59, 75, 75, 117, 75, 75, 59, 76, 76, 117, 76, 76, 59, 77, 77, 117, 77, 77, 59, 78, 78, 117, 78, 78, 59, 79, 79, 117, 79, 79, 59, 80, 80, 117, 80, 80, 59, 81, 81, 117, 81, 81, 59, 82, 82, 117, 82, 82, 59, 83, 83, 117, 83, 83, 59, 84, 84, 117, 84, 84, 59, 85, 85, 117, 85, 85, 59, 86, 86, 117, 86, 86, 59, 87, 87, 117, 87, 87, 59, 88, 88, 117, 88, 88, 59, 89, 89, 117, 89, 89, 59, 90, 90, 117, 90, 90, 59, 91, 91, 117, 91, 91, 59, 92, 92, 117, 92, 92, 59, 93, 93, 117, 93, 93, 59, 94, 94, 117, 94, 94, 59, 95, 95, 117, 95, 95, 59, 96, 96, 117, 96, 96, 59, 97, 97, 117, 97, 97, 59, 98, 98, 117, 98, 98, 59, 99, 99, 117, 99, 99, 59, 100, 100, 117, 100, 100, 56, 101, 101, 119, 101, 101, 56, 101, 66, 119, 101, 30, 44, 102, 102, 6, 102, 102, 53, 102, 102, 44, 102, 60, 36, 103, 103, 36, 103, 149, 41, 104, 104, 41, 104, 150, 37, 105, 105, 49, 105, 105, 37, 105, 149, 49, 105, 30, 36, 106, 106, 36, 106, 151, 41, 107, 107, 41, 107, 152, 37, 108, 108, 49, 108, 108, 37, 108, 151, 49, 108, 31, 36, 109, 109, 36, 109, 153, 41, 110, 110, 41, 110, 154, 37, 111, 111, 49, 111, 111, 37, 111, 153, 49, 111, 32, 36, 112, 112, 36, 112, 155, 41, 113, 113, 41, 113, 156, 37, 114, 114, 49, 114, 114, 37, 114, 155, 49, 114, 33, 36, 115, 115, 36, 115, 157, 41, 116, 116, 41, 116, 158, 37, 117, 117, 49, 117, 117, 37, 117, 157, 49, 117, 34, 36, 118, 118, 36, 118, 159, 41, 119, 119, 41, 119, 160, 37, 120, 120, 49, 120, 120, 37, 120, 159, 49, 120, 35, 36, 121, 121, 36, 121, 161, 41, 122, 122, 41, 122, 162, 37, 123, 123, 49, 123, 123, 37, 123, 161, 49, 123, 36, 36, 124, 124, 36, 124, 163, 41, 125, 125, 41, 125, 164, 37, 126, 126, 49, 126, 126, 37, 126, 163, 49, 126, 37, 36, 127, 127, 36, 127, 165, 41, 128, 128, 41, 128, 166, 37, 129, 129, 49, 129, 129, 37, 129, 165, 49, 129, 38, 36, 130, 130, 36, 130, 167, 41, 131, 131, 41, 131, 168, 37, 132, 132, 49, 132, 132, 37, 132, 167, 49, 132, 39, 36, 133, 133, 36, 133, 169, 41, 134, 134, 41, 134, 170, 37, 135, 135, 49, 135, 135, 37, 135, 169, 49, 135, 40, 36, 136, 136, 36, 136, 171, 41, 137, 137, 41, 137, 172, 37, 138, 138, 49, 138, 138, 37, 138, 171, 49, 138, 41, 36, 139, 139, 36, 139, 173, 41, 140, 140, 41, 140, 174, 37, 141, 141, 49, 141, 141, 37, 141, 173, 49, 141, 42, 36, 142, 142, 36, 142, 175, 41, 143, 143, 41, 143, 176, 37, 144, 144, 49, 144, 144, 37, 144, 175, 49, 144, 43, 36, 145, 145, 36, 145, 177, 41, 146, 146, 41, 146, 178, 37, 147, 147, 49, 147, 147, 37, 147, 177, 49, 147, 44, 7, 148, 148, 5, 148, 148, 94, 148, 148, 95, 148, 148, 7, 148, 179, 5, 148, 15, 94, 148, 60, 95, 148, 60, 3, 149, 149, 4, 149, 149, 35, 150, 150, 35, 150, 103, 3, 151, 151, 4, 151, 151, 35, 152, 152, 35, 152, 106, 3, 153, 153, 4, 153, 153, 35, 154, 154, 35, 154, 109, 3, 155, 155, 4, 155, 155, 35, 156, 156, 35, 156, 112, 3, 157, 157, 4, 157, 157, 35, 158, 158, 35, 158, 115, 3, 159, 159, 4, 159, 159, 35, 160, 160, 35, 160, 118, 3, 161, 161, 4, 161, 161, 35, 162, 162, 35, 162, 121, 3, 163, 163, 4, 163, 163, 35, 164, 164, 35, 164, 124, 3, 165, 165, 4, 165, 165, 35, 166, 166, 35, 166, 127, 3, 167, 167, 4, 167, 167, 35, 168, 168, 35, 168, 130, 3, 169, 169, 4, 169, 169, 35, 170, 170, 35, 170, 133, 3, 171, 171, 4, 171, 171, 35, 172, 172, 35, 172, 136, 3, 173, 173, 4, 173, 173, 35, 174, 174, 35, 174, 139, 3, 175, 175, 4, 175, 175, 35, 176, 176, 35, 176, 142, 3, 177, 177, 4, 177, 177, 35, 178, 178, 35, 178, 145, 40, 179, 179, 40, 179, 17)), ncol=3, byrow=TRUE)
   colnames(ind_a)=c("indf", "ir0", "ic0")
   l$ind_a=ind_a
   
   # vector b
   ind_b=matrix(as.integer(c(28, 16, 351, 367, 28, 17, 351, 368, 28, 18, 351, 369, 28, 19, 177, 608, 28, 20, 351, 370, 28, 21, 351, 371, 28, 22, 177, 609, 28, 23, 351, 372, 28, 24, 177, 610, 28, 25, 177, 611, 28, 26, 178, 608, 28, 27, 178, 609, 28, 28, 178, 610, 28, 29, 178, 611, 55, 31, 602, 179, 58, 32, 604, 175, 55, 32, 602, 180, 58, 33, 605, 175, 55, 33, 355, 352, 58, 34, 606, 175, 55, 34, 356, 352, 58, 35, 607, 175, 55, 35, 357, 352, 58, 36, 604, 176, 55, 36, 602, 181, 58, 37, 605, 176, 55, 37, 355, 353, 58, 38, 606, 176, 55, 38, 356, 353, 58, 39, 607, 176, 55, 39, 357, 353, 58, 40, 361, 350, 55, 40, 355, 354, 58, 41, 362, 350, 55, 41, 356, 354, 58, 42, 363, 350, 55, 42, 357, 354, 58, 43, 364, 350, 55, 43, 182, 601, 58, 44, 365, 350, 55, 44, 183, 601, 58, 45, 366, 350, 55, 45, 184, 601, 8, 46, 185, 602, 8, 47, 186, 602, 8, 48, 358, 355, 8, 49, 358, 356, 8, 50, 358, 357, 8, 51, 187, 602, 8, 52, 359, 355, 8, 53, 359, 356, 8, 54, 359, 357, 8, 55, 360, 355, 8, 56, 360, 356, 8, 57, 360, 357, 8, 58, 603, 182, 8, 59, 603, 183, 8, 60, 603, 184, 118, 62, 602, 175, 118, 63, 602, 176, 118, 64, 355, 350, 118, 65, 356, 350, 118, 66, 357, 350, 117, 68, 604, 179, 117, 69, 605, 179, 117, 70, 606, 179, 117, 71, 607, 179, 59, 72, 555, 175, 117, 72, 604, 180, 59, 73, 556, 175, 117, 73, 605, 180, 59, 74, 557, 175, 117, 74, 606, 180, 59, 75, 558, 175, 117, 75, 607, 180, 59, 76, 559, 175, 117, 76, 361, 352, 59, 77, 560, 175, 117, 77, 362, 352, 59, 78, 561, 175, 117, 78, 363, 352, 59, 79, 562, 175, 117, 79, 364, 352, 59, 80, 563, 175, 117, 80, 365, 352, 59, 81, 564, 175, 117, 81, 366, 352, 59, 82, 555, 176, 117, 82, 604, 181, 59, 83, 556, 176, 117, 83, 605, 181, 59, 84, 557, 176, 117, 84, 606, 181, 59, 85, 558, 176, 117, 85, 607, 181, 59, 86, 559, 176, 117, 86, 361, 353, 59, 87, 560, 176, 117, 87, 362, 353, 59, 88, 561, 176, 117, 88, 363, 353, 59, 89, 562, 176, 117, 89, 364, 353, 59, 90, 563, 176, 117, 90, 365, 353, 59, 91, 564, 176, 117, 91, 366, 353, 59, 92, 316, 350, 117, 92, 361, 354, 59, 93, 317, 350, 117, 93, 362, 354, 59, 94, 318, 350, 117, 94, 363, 354, 59, 95, 319, 350, 117, 95, 364, 354, 59, 96, 320, 350, 117, 96, 365, 354, 59, 97, 321, 350, 117, 97, 366, 354, 59, 98, 322, 350, 117, 98, 188, 601, 59, 99, 323, 350, 117, 99, 189, 601, 59, 100, 324, 350, 117, 100, 190, 601, 59, 101, 325, 350, 117, 101, 191, 601, 6, 103, 373, 351, 53, 103, 612, 192, 3, 150, 16, 1, 4, 150, 17, 1, 3, 152, 18, 1, 4, 152, 19, 1, 3, 154, 20, 1, 4, 154, 21, 1, 3, 156, 22, 1, 4, 156, 23, 1, 3, 158, 24, 1, 4, 158, 25, 1, 3, 160, 26, 1, 4, 160, 27, 1, 3, 162, 28, 1, 4, 162, 29, 1, 3, 164, 30, 1, 4, 164, 31, 1, 3, 166, 32, 1, 4, 166, 33, 1, 3, 168, 34, 1, 4, 168, 35, 1, 3, 170, 36, 1, 4, 170, 37, 1, 3, 172, 38, 1, 4, 172, 39, 1, 3, 174, 40, 1, 4, 174, 41, 1, 3, 176, 42, 1, 4, 176, 43, 1, 3, 178, 44, 1, 4, 178, 45, 1)), ncol=2+2, byrow=TRUE)
   colnames(ind_b)=c("indf", "irow", paste("indx", seq_len(2), sep=""))
   l$ind_b=ind_b
   
   # jacobian b_x
   imaxprod=seq_len(maxprod)
   ind_bx=c()
   for (ix in imaxprod) {
      i=ind_b[,2+ix]>ba_x # exclude from differentiation plain input entries
      tmp=ind_b[i,,drop=FALSE]
      ind_bx=rbind(ind_bx, tmp[,c(1,2,ix+2,2+imaxprod[-ix])]) # move diff var to ic1 place
   }
   if (length(ind_bx)) {
      colnames(ind_bx)=c("indf", "irow", "ic1", sprintf("indx%d", seq_len(maxprod-1)))
      ind_bx[,"ic1"]=ind_bx[,"ic1"]-ba_x
   }
   l$ind_bx=ind_bx
}
spAbr[[w]]=l

if (TIMEIT) {
   cat("weight 5: ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
}
w=5
nb_c=76
ba_x=128; # base of cumomer indexes in incu vector
l=new.env()
l$w=w
l$nb_c=nb_c
l$nb_fwrv=nb_fwrv
l$nb_cl=774 # number of lighter cumomers
maxprod=2
if (nb_c > 0) {
   # matrix a
   ind_a=matrix(as.integer(c(39, 0, 0, 42, 0, 0, 61, 0, 0, 39, 0, 46, 42, 0, 47, 61, 0, 48, 39, 1, 1, 42, 1, 1, 61, 1, 1, 39, 1, 49, 42, 1, 50, 61, 1, 51, 39, 2, 2, 42, 2, 2, 61, 2, 2, 39, 2, 52, 42, 2, 53, 61, 2, 54, 39, 3, 3, 42, 3, 3, 61, 3, 3, 39, 3, 55, 42, 3, 56, 61, 3, 57, 39, 4, 4, 42, 4, 4, 61, 4, 4, 39, 4, 58, 42, 4, 59, 61, 4, 60, 39, 5, 5, 42, 5, 5, 61, 5, 5, 39, 5, 61, 42, 5, 62, 61, 5, 63, 28, 6, 6, 28, 7, 7, 28, 8, 8, 28, 9, 9, 28, 10, 10, 28, 11, 11, 32, 12, 12, 110, 12, 12, 58, 12, 12, 55, 12, 12, 32, 12, 18, 110, 12, 48, 32, 13, 13, 110, 13, 13, 58, 13, 13, 55, 13, 13, 32, 13, 19, 110, 13, 51, 32, 14, 14, 110, 14, 14, 58, 14, 14, 55, 14, 14, 32, 14, 20, 110, 14, 54, 32, 15, 15, 110, 15, 15, 58, 15, 15, 55, 15, 15, 32, 15, 21, 110, 15, 57, 32, 16, 16, 110, 16, 16, 58, 16, 16, 55, 16, 16, 32, 16, 22, 110, 16, 60, 32, 17, 17, 110, 17, 17, 58, 17, 17, 55, 17, 17, 32, 17, 23, 110, 17, 63, 8, 18, 18, 8, 19, 19, 8, 20, 20, 8, 21, 21, 8, 22, 22, 8, 23, 23, 38, 24, 24, 120, 24, 24, 118, 24, 24, 38, 24, 0, 120, 24, 25, 59, 25, 25, 117, 25, 25, 59, 25, 24, 59, 26, 26, 117, 26, 26, 59, 27, 27, 117, 27, 27, 59, 28, 28, 117, 28, 28, 59, 29, 29, 117, 29, 29, 59, 30, 30, 117, 30, 30, 59, 31, 31, 117, 31, 31, 59, 32, 32, 117, 32, 32, 59, 33, 33, 117, 33, 33, 59, 34, 34, 117, 34, 34, 59, 35, 35, 117, 35, 35, 59, 36, 36, 117, 36, 36, 59, 37, 37, 117, 37, 37, 59, 38, 38, 117, 38, 38, 59, 39, 39, 117, 39, 39, 59, 40, 40, 117, 40, 40, 59, 41, 41, 117, 41, 41, 59, 42, 42, 117, 42, 42, 59, 43, 43, 117, 43, 43, 59, 44, 44, 117, 44, 44, 59, 45, 45, 117, 45, 45, 36, 46, 46, 36, 46, 64, 41, 47, 47, 41, 47, 65, 37, 48, 48, 49, 48, 48, 37, 48, 64, 49, 48, 12, 36, 49, 49, 36, 49, 66, 41, 50, 50, 41, 50, 67, 37, 51, 51, 49, 51, 51, 37, 51, 66, 49, 51, 13, 36, 52, 52, 36, 52, 68, 41, 53, 53, 41, 53, 69, 37, 54, 54, 49, 54, 54, 37, 54, 68, 49, 54, 14, 36, 55, 55, 36, 55, 70, 41, 56, 56, 41, 56, 71, 37, 57, 57, 49, 57, 57, 37, 57, 70, 49, 57, 15, 36, 58, 58, 36, 58, 72, 41, 59, 59, 41, 59, 73, 37, 60, 60, 49, 60, 60, 37, 60, 72, 49, 60, 16, 36, 61, 61, 36, 61, 74, 41, 62, 62, 41, 62, 75, 37, 63, 63, 49, 63, 63, 37, 63, 74, 49, 63, 17, 3, 64, 64, 4, 64, 64, 35, 65, 65, 35, 65, 46, 3, 66, 66, 4, 66, 66, 35, 67, 67, 35, 67, 49, 3, 68, 68, 4, 68, 68, 35, 69, 69, 35, 69, 52, 3, 70, 70, 4, 70, 70, 35, 71, 71, 35, 71, 55, 3, 72, 72, 4, 72, 72, 35, 73, 73, 35, 73, 58, 3, 74, 74, 4, 74, 74, 35, 75, 75, 35, 75, 61)), ncol=3, byrow=TRUE)
   colnames(ind_a)=c("indf", "ir0", "ic0")
   l$ind_a=ind_a
   
   # vector b
   ind_b=matrix(as.integer(c(28, 7, 351, 608, 28, 8, 351, 609, 28, 9, 351, 610, 28, 10, 351, 611, 28, 11, 177, 825, 28, 12, 178, 825, 58, 13, 824, 175, 55, 13, 602, 352, 58, 14, 824, 176, 55, 14, 602, 353, 58, 15, 604, 350, 55, 15, 602, 354, 58, 16, 605, 350, 55, 16, 355, 601, 58, 17, 606, 350, 55, 17, 356, 601, 58, 18, 607, 350, 55, 18, 357, 601, 8, 19, 358, 602, 8, 20, 359, 602, 8, 21, 360, 602, 8, 22, 603, 355, 8, 23, 603, 356, 8, 24, 603, 357, 118, 25, 602, 350, 117, 26, 824, 179, 59, 27, 784, 175, 117, 27, 824, 180, 59, 28, 785, 175, 117, 28, 604, 352, 59, 29, 786, 175, 117, 29, 605, 352, 59, 30, 787, 175, 117, 30, 606, 352, 59, 31, 788, 175, 117, 31, 607, 352, 59, 32, 784, 176, 117, 32, 824, 181, 59, 33, 785, 176, 117, 33, 604, 353, 59, 34, 786, 176, 117, 34, 605, 353, 59, 35, 787, 176, 117, 35, 606, 353, 59, 36, 788, 176, 117, 36, 607, 353, 59, 37, 555, 350, 117, 37, 604, 354, 59, 38, 556, 350, 117, 38, 605, 354, 59, 39, 557, 350, 117, 39, 606, 354, 59, 40, 558, 350, 117, 40, 607, 354, 59, 41, 559, 350, 117, 41, 361, 601, 59, 42, 560, 350, 117, 42, 362, 601, 59, 43, 561, 350, 117, 43, 363, 601, 59, 44, 562, 350, 117, 44, 364, 601, 59, 45, 563, 350, 117, 45, 365, 601, 59, 46, 564, 350, 117, 46, 366, 601, 3, 65, 4, 1, 4, 65, 5, 1, 3, 67, 6, 1, 4, 67, 7, 1, 3, 69, 8, 1, 4, 69, 9, 1, 3, 71, 10, 1, 4, 71, 11, 1, 3, 73, 12, 1, 4, 73, 13, 1, 3, 75, 14, 1, 4, 75, 15, 1)), ncol=2+2, byrow=TRUE)
   colnames(ind_b)=c("indf", "irow", paste("indx", seq_len(2), sep=""))
   l$ind_b=ind_b
   
   # jacobian b_x
   imaxprod=seq_len(maxprod)
   ind_bx=c()
   for (ix in imaxprod) {
      i=ind_b[,2+ix]>ba_x # exclude from differentiation plain input entries
      tmp=ind_b[i,,drop=FALSE]
      ind_bx=rbind(ind_bx, tmp[,c(1,2,ix+2,2+imaxprod[-ix])]) # move diff var to ic1 place
   }
   if (length(ind_bx)) {
      colnames(ind_bx)=c("indf", "irow", "ic1", sprintf("indx%d", seq_len(maxprod-1)))
      ind_bx[,"ic1"]=ind_bx[,"ic1"]-ba_x
   }
   l$ind_bx=ind_bx
}
spAbr[[w]]=l

if (TIMEIT) {
   cat("weight 6: ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
}
w=6
nb_c=16
ba_x=128; # base of cumomer indexes in incu vector
l=new.env()
l$w=w
l$nb_c=nb_c
l$nb_fwrv=nb_fwrv
l$nb_cl=850 # number of lighter cumomers
maxprod=2
if (nb_c > 0) {
   # matrix a
   ind_a=matrix(as.integer(c(39, 0, 0, 42, 0, 0, 61, 0, 0, 39, 0, 11, 42, 0, 12, 61, 0, 13, 28, 1, 1, 32, 2, 2, 110, 2, 2, 58, 2, 2, 55, 2, 2, 32, 2, 3, 110, 2, 13, 8, 3, 3, 59, 4, 4, 117, 4, 4, 59, 5, 5, 117, 5, 5, 59, 6, 6, 117, 6, 6, 59, 7, 7, 117, 7, 7, 59, 8, 8, 117, 8, 8, 59, 9, 9, 117, 9, 9, 59, 10, 10, 117, 10, 10, 36, 11, 11, 36, 11, 14, 41, 12, 12, 41, 12, 15, 37, 13, 13, 49, 13, 13, 37, 13, 14, 49, 13, 2, 3, 14, 14, 4, 14, 14, 35, 15, 15, 35, 15, 11)), ncol=3, byrow=TRUE)
   colnames(ind_a)=c("indf", "ir0", "ic0")
   l$ind_a=ind_a
   
   # vector b
   ind_b=matrix(as.integer(c(28, 2, 351, 825, 58, 3, 824, 350, 55, 3, 602, 601, 8, 4, 603, 602, 59, 5, 927, 175, 117, 5, 824, 352, 59, 6, 927, 176, 117, 6, 824, 353, 59, 7, 784, 350, 117, 7, 824, 354, 59, 8, 785, 350, 117, 8, 604, 601, 59, 9, 786, 350, 117, 9, 605, 601, 59, 10, 787, 350, 117, 10, 606, 601, 59, 11, 788, 350, 117, 11, 607, 601, 3, 15, 2, 1, 4, 15, 3, 1)), ncol=2+2, byrow=TRUE)
   colnames(ind_b)=c("indf", "irow", paste("indx", seq_len(2), sep=""))
   l$ind_b=ind_b
   
   # jacobian b_x
   imaxprod=seq_len(maxprod)
   ind_bx=c()
   for (ix in imaxprod) {
      i=ind_b[,2+ix]>ba_x # exclude from differentiation plain input entries
      tmp=ind_b[i,,drop=FALSE]
      ind_bx=rbind(ind_bx, tmp[,c(1,2,ix+2,2+imaxprod[-ix])]) # move diff var to ic1 place
   }
   if (length(ind_bx)) {
      colnames(ind_bx)=c("indf", "irow", "ic1", sprintf("indx%d", seq_len(maxprod-1)))
      ind_bx[,"ic1"]=ind_bx[,"ic1"]-ba_x
   }
   l$ind_bx=ind_bx
}
spAbr[[w]]=l

if (TIMEIT) {
   cat("weight 7: ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
}
w=7
nb_c=1
ba_x=128; # base of cumomer indexes in incu vector
l=new.env()
l$w=w
l$nb_c=nb_c
l$nb_fwrv=nb_fwrv
l$nb_cl=866 # number of lighter cumomers
maxprod=2
if (nb_c > 0) {
   # matrix a
   ind_a=matrix(as.integer(c(59, 0, 0, 117, 0, 0)), ncol=3, byrow=TRUE)
   colnames(ind_a)=c("indf", "ir0", "ic0")
   l$ind_a=ind_a
   
   # vector b
   ind_b=matrix(as.integer(c(59, 1, 927, 350, 117, 1, 824, 601)), ncol=2+2, byrow=TRUE)
   colnames(ind_b)=c("indf", "irow", paste("indx", seq_len(2), sep=""))
   l$ind_b=ind_b
   
   # jacobian b_x
   imaxprod=seq_len(maxprod)
   ind_bx=c()
   for (ix in imaxprod) {
      i=ind_b[,2+ix]>ba_x # exclude from differentiation plain input entries
      tmp=ind_b[i,,drop=FALSE]
      ind_bx=rbind(ind_bx, tmp[,c(1,2,ix+2,2+imaxprod[-ix])]) # move diff var to ic1 place
   }
   if (length(ind_bx)) {
      colnames(ind_bx)=c("indf", "irow", "ic1", sprintf("indx%d", seq_len(maxprod-1)))
      ind_bx[,"ic1"]=ind_bx[,"ic1"]-ba_x
   }
   l$ind_bx=ind_bx
}
spAbr[[w]]=l

# weight count
nb_rw=7
# cumomer count by weight
nb_rcumos=c(118, 223, 253, 180, 76, 16, 1)
nbc_cumos=c(0, cumsum(nb_rcumos))
# cumo names
nm_rcumo=c("PGA:1", "PGA:2", "PGA:4", "Gnt6P:1", "Gnt6P:2", "Gnt6P:4", "Gnt6P:8", "Gnt6P:16", "Gnt6P:32", "ICit:1", "ICit:2", "ICit:4", "ICit:8", "ICit:16", "ICit:32", "Fru6P:1", "Fru6P:2", "Fru6P:4", "Fru6P:8", "Fru6P:16", "Fru6P:32", "FruBP:1", "FruBP:2", "FruBP:4", "FruBP:8", "FruBP:16", "FruBP:32", "Mal:1", "Mal:2", "Mal:4", "Mal:8", "Rib5P:1", "Rib5P:2", "Rib5P:4", "Rib5P:8", "Rib5P:16", "PEP:1", "PEP:2", "PEP:4", "Sed7P:1", "Sed7P:2", "Sed7P:4", "Sed7P:8", "Sed7P:16", "Sed7P:32", "Sed7P:64", "E2:1", "E2:2", "AcCoA:2", "AcCoA:1", "E3:1", "E3:2", "E3:4", "GA3P:1", "GA3P:2", "GA3P:4", "DHAP:4", "DHAP:2", "DHAP:1", "Ery4P:1", "Ery4P:2", "Ery4P:4", "Ery4P:8", "CO2:1", "OAA:8", "OAA:4", "OAA:2", "OAA:1", "GlyOx:2", "GlyOx:1", "Pyr:4", "Pyr:2", "Pyr:1", "Gnt:1", "K26pg:1", "Glc6P:1", "Gnt:2", "K26pg:2", "Glc6P:2", "Gnt:4", "K26pg:4", "Glc6P:4", "Gnt:8", "K26pg:8", "Glc6P:8", "Gnt:16", "K26pg:16", "Glc6P:16", "Gnt:32", "K26pg:32", "Glc6P:32", "Suc:1", "Suc:8", "Suc:2", "Suc:4", "Kdpg:1", "Kdpg:2", "Kdpg:4", "AKG:16", "Kdpg:32", "Kdpg:16", "Kdpg:8", "Glc:1", "Kdg:1", "Glc:2", "Kdg:2", "Glc:4", "Kdg:4", "Glc:8", "Kdg:8", "Glc:16", "Kdg:16", "Glc:32", "Kdg:32", "AKG:1", "AKG:8", "AKG:2", "AKG:4", "PGA:3", "PGA:5", "PGA:6", "Gnt6P:3", "Gnt6P:5", "Gnt6P:6", "Gnt6P:9", "Gnt6P:10", "Gnt6P:12", "Gnt6P:17", "Gnt6P:18", "Gnt6P:20", "Gnt6P:24", "Gnt6P:33", "Gnt6P:34", "Gnt6P:36", "Gnt6P:40", "Gnt6P:48", "ICit:3", "ICit:5", "ICit:9", "ICit:17", "ICit:33", "ICit:6", "ICit:10", "ICit:18", "ICit:34", "ICit:12", "ICit:20", "ICit:36", "ICit:24", "ICit:40", "ICit:48", "Fru6P:3", "Fru6P:5", "Fru6P:6", "Fru6P:9", "Fru6P:10", "Fru6P:12", "Fru6P:17", "Fru6P:18", "Fru6P:20", "Fru6P:24", "Fru6P:33", "Fru6P:34", "Fru6P:36", "Fru6P:40", "Fru6P:48", "FruBP:3", "FruBP:5", "FruBP:6", "FruBP:9", "FruBP:10", "FruBP:12", "FruBP:17", "FruBP:18", "FruBP:20", "FruBP:24", "FruBP:33", "FruBP:34", "FruBP:36", "FruBP:40", "FruBP:48", "Mal:3", "Mal:5", "Mal:6", "Mal:9", "Mal:10", "Mal:12", "Rib5P:3", "Rib5P:5", "Rib5P:6", "Rib5P:9", "Rib5P:10", "Rib5P:12", "Rib5P:17", "Rib5P:18", "Rib5P:20", "Rib5P:24", "PEP:3", "PEP:5", "PEP:6", "Sed7P:3", "Sed7P:5", "Sed7P:6", "Sed7P:9", "Sed7P:10", "Sed7P:12", "Sed7P:17", "Sed7P:18", "Sed7P:20", "Sed7P:24", "Sed7P:33", "Sed7P:34", "Sed7P:36", "Sed7P:40", "Sed7P:48", "Sed7P:65", "Sed7P:66", "Sed7P:68", "Sed7P:72", "Sed7P:80", "Sed7P:96", "E2:3", "AcCoA:3", "E3:3", "E3:5", "E3:6", "GA3P:3", "GA3P:5", "GA3P:6", "DHAP:6", "DHAP:5", "DHAP:3", "Ery4P:3", "Ery4P:5", "Ery4P:6", "Ery4P:9", "Ery4P:10", "Ery4P:12", "OAA:12", "OAA:10", "OAA:6", "OAA:9", "OAA:5", "OAA:3", "GlyOx:3", "Pyr:6", "Pyr:5", "Pyr:3", "Gnt:3", "K26pg:3", "Glc6P:3", "Gnt:5", "K26pg:5", "Glc6P:5", "Gnt:6", "K26pg:6", "Glc6P:6", "Gnt:9", "K26pg:9", "Glc6P:9", "Gnt:10", "K26pg:10", "Glc6P:10", "Gnt:12", "K26pg:12", "Glc6P:12", "Gnt:17", "K26pg:17", "Glc6P:17", "Gnt:18", "K26pg:18", "Glc6P:18", "Gnt:20", "K26pg:20", "Glc6P:20", "Gnt:24", "K26pg:24", "Glc6P:24", "Gnt:33", "K26pg:33", "Glc6P:33", "Gnt:34", "K26pg:34", "Glc6P:34", "Gnt:36", "K26pg:36", "Glc6P:36", "Gnt:40", "K26pg:40", "Glc6P:40", "Gnt:48", "K26pg:48", "Glc6P:48", "Suc:3", "Suc:12", "Suc:5", "Suc:10", "Suc:6", "Suc:9", "Kdpg:3", "Kdpg:5", "Kdpg:6", "Kdpg:48", "Kdpg:40", "Kdpg:24", "Glc:3", "Kdg:3", "Glc:5", "Kdg:5", "Glc:6", "Kdg:6", "Glc:9", "Kdg:9", "Glc:10", "Kdg:10", "Glc:12", "Kdg:12", "Glc:17", "Kdg:17", "Glc:18", "Kdg:18", "Glc:20", "Kdg:20", "Glc:24", "Kdg:24", "Glc:33", "Kdg:33", "Glc:34", "Kdg:34", "Glc:36", "Kdg:36", "Glc:40", "Kdg:40", "Glc:48", "Kdg:48", "AKG:3", "AKG:12", "AKG:5", "AKG:10", "AKG:6", "AKG:9", "PGA:7", "Gnt6P:7", "Gnt6P:11", "Gnt6P:13", "Gnt6P:14", "Gnt6P:19", "Gnt6P:21", "Gnt6P:22", "Gnt6P:25", "Gnt6P:26", "Gnt6P:28", "Gnt6P:35", "Gnt6P:37", "Gnt6P:38", "Gnt6P:41", "Gnt6P:42", "Gnt6P:44", "Gnt6P:49", "Gnt6P:50", "Gnt6P:52", "Gnt6P:56", "ICit:7", "ICit:11", "ICit:13", "ICit:19", "ICit:21", "ICit:25", "ICit:35", "ICit:37", "ICit:41", "ICit:49", "ICit:14", "ICit:22", "ICit:26", "ICit:38", "ICit:42", "ICit:50", "ICit:28", "ICit:44", "ICit:52", "ICit:56", "Fru6P:7", "Fru6P:11", "Fru6P:13", "Fru6P:14", "Fru6P:19", "Fru6P:21", "Fru6P:22", "Fru6P:25", "Fru6P:26", "Fru6P:28", "Fru6P:35", "Fru6P:37", "Fru6P:38", "Fru6P:41", "Fru6P:42", "Fru6P:44", "Fru6P:49", "Fru6P:50", "Fru6P:52", "Fru6P:56", "FruBP:7", "FruBP:11", "FruBP:13", "FruBP:14", "FruBP:19", "FruBP:21", "FruBP:22", "FruBP:25", "FruBP:26", "FruBP:28", "FruBP:35", "FruBP:37", "FruBP:38", "FruBP:41", "FruBP:42", "FruBP:44", "FruBP:49", "FruBP:50", "FruBP:52", "FruBP:56", "Mal:7", "Mal:11", "Mal:13", "Mal:14", "Rib5P:7", "Rib5P:11", "Rib5P:13", "Rib5P:14", "Rib5P:19", "Rib5P:21", "Rib5P:22", "Rib5P:25", "Rib5P:26", "Rib5P:28", "PEP:7", "Sed7P:7", "Sed7P:11", "Sed7P:13", "Sed7P:14", "Sed7P:19", "Sed7P:21", "Sed7P:22", "Sed7P:25", "Sed7P:26", "Sed7P:28", "Sed7P:35", "Sed7P:37", "Sed7P:38", "Sed7P:41", "Sed7P:42", "Sed7P:44", "Sed7P:49", "Sed7P:50", "Sed7P:52", "Sed7P:56", "Sed7P:67", "Sed7P:69", "Sed7P:70", "Sed7P:73", "Sed7P:74", "Sed7P:76", "Sed7P:81", "Sed7P:82", "Sed7P:84", "Sed7P:88", "Sed7P:97", "Sed7P:98", "Sed7P:100", "Sed7P:104", "Sed7P:112", "E3:7", "GA3P:7", "DHAP:7", "Ery4P:7", "Ery4P:11", "Ery4P:13", "Ery4P:14", "OAA:14", "OAA:13", "OAA:11", "OAA:7", "Pyr:7", "Gnt:7", "K26pg:7", "Glc6P:7", "Gnt:11", "K26pg:11", "Glc6P:11", "Gnt:13", "K26pg:13", "Glc6P:13", "Gnt:14", "K26pg:14", "Glc6P:14", "Gnt:19", "K26pg:19", "Glc6P:19", "Gnt:21", "K26pg:21", "Glc6P:21", "Gnt:22", "K26pg:22", "Glc6P:22", "Gnt:25", "K26pg:25", "Glc6P:25", "Gnt:26", "K26pg:26", "Glc6P:26", "Gnt:28", "K26pg:28", "Glc6P:28", "Gnt:35", "K26pg:35", "Glc6P:35", "Gnt:37", "K26pg:37", "Glc6P:37", "Gnt:38", "K26pg:38", "Glc6P:38", "Gnt:41", "K26pg:41", "Glc6P:41", "Gnt:42", "K26pg:42", "Glc6P:42", "Gnt:44", "K26pg:44", "Glc6P:44", "Gnt:49", "K26pg:49", "Glc6P:49", "Gnt:50", "K26pg:50", "Glc6P:50", "Gnt:52", "K26pg:52", "Glc6P:52", "Gnt:56", "K26pg:56", "Glc6P:56", "Suc:7", "Suc:14", "Suc:11", "Suc:13", "Kdpg:7", "Kdpg:56", "Glc:7", "Kdg:7", "Glc:11", "Kdg:11", "Glc:13", "Kdg:13", "Glc:14", "Kdg:14", "Glc:19", "Kdg:19", "Glc:21", "Kdg:21", "Glc:22", "Kdg:22", "Glc:25", "Kdg:25", "Glc:26", "Kdg:26", "Glc:28", "Kdg:28", "Glc:35", "Kdg:35", "Glc:37", "Kdg:37", "Glc:38", "Kdg:38", "Glc:41", "Kdg:41", "Glc:42", "Kdg:42", "Glc:44", "Kdg:44", "Glc:49", "Kdg:49", "Glc:50", "Kdg:50", "Glc:52", "Kdg:52", "Glc:56", "Kdg:56", "AKG:7", "AKG:14", "AKG:11", "AKG:13", "Gnt6P:15", "Gnt6P:23", "Gnt6P:27", "Gnt6P:29", "Gnt6P:30", "Gnt6P:39", "Gnt6P:43", "Gnt6P:45", "Gnt6P:46", "Gnt6P:51", "Gnt6P:53", "Gnt6P:54", "Gnt6P:57", "Gnt6P:58", "Gnt6P:60", "ICit:15", "ICit:23", "ICit:27", "ICit:29", "ICit:39", "ICit:43", "ICit:45", "ICit:51", "ICit:53", "ICit:57", "ICit:30", "ICit:46", "ICit:54", "ICit:58", "ICit:60", "Fru6P:15", "Fru6P:23", "Fru6P:27", "Fru6P:29", "Fru6P:30", "Fru6P:39", "Fru6P:43", "Fru6P:45", "Fru6P:46", "Fru6P:51", "Fru6P:53", "Fru6P:54", "Fru6P:57", "Fru6P:58", "Fru6P:60", "FruBP:15", "FruBP:23", "FruBP:27", "FruBP:29", "FruBP:30", "FruBP:39", "FruBP:43", "FruBP:45", "FruBP:46", "FruBP:51", "FruBP:53", "FruBP:54", "FruBP:57", "FruBP:58", "FruBP:60", "Mal:15", "Rib5P:15", "Rib5P:23", "Rib5P:27", "Rib5P:29", "Rib5P:30", "Sed7P:15", "Sed7P:23", "Sed7P:27", "Sed7P:29", "Sed7P:30", "Sed7P:39", "Sed7P:43", "Sed7P:45", "Sed7P:46", "Sed7P:51", "Sed7P:53", "Sed7P:54", "Sed7P:57", "Sed7P:58", "Sed7P:60", "Sed7P:71", "Sed7P:75", "Sed7P:77", "Sed7P:78", "Sed7P:83", "Sed7P:85", "Sed7P:86", "Sed7P:89", "Sed7P:90", "Sed7P:92", "Sed7P:99", "Sed7P:101", "Sed7P:102", "Sed7P:105", "Sed7P:106", "Sed7P:108", "Sed7P:113", "Sed7P:114", "Sed7P:116", "Sed7P:120", "Ery4P:15", "OAA:15", "Gnt:15", "K26pg:15", "Glc6P:15", "Gnt:23", "K26pg:23", "Glc6P:23", "Gnt:27", "K26pg:27", "Glc6P:27", "Gnt:29", "K26pg:29", "Glc6P:29", "Gnt:30", "K26pg:30", "Glc6P:30", "Gnt:39", "K26pg:39", "Glc6P:39", "Gnt:43", "K26pg:43", "Glc6P:43", "Gnt:45", "K26pg:45", "Glc6P:45", "Gnt:46", "K26pg:46", "Glc6P:46", "Gnt:51", "K26pg:51", "Glc6P:51", "Gnt:53", "K26pg:53", "Glc6P:53", "Gnt:54", "K26pg:54", "Glc6P:54", "Gnt:57", "K26pg:57", "Glc6P:57", "Gnt:58", "K26pg:58", "Glc6P:58", "Gnt:60", "K26pg:60", "Glc6P:60", "Suc:15", "Glc:15", "Kdg:15", "Glc:23", "Kdg:23", "Glc:27", "Kdg:27", "Glc:29", "Kdg:29", "Glc:30", "Kdg:30", "Glc:39", "Kdg:39", "Glc:43", "Kdg:43", "Glc:45", "Kdg:45", "Glc:46", "Kdg:46", "Glc:51", "Kdg:51", "Glc:53", "Kdg:53", "Glc:54", "Kdg:54", "Glc:57", "Kdg:57", "Glc:58", "Kdg:58", "Glc:60", "Kdg:60", "AKG:15", "Gnt6P:31", "Gnt6P:47", "Gnt6P:55", "Gnt6P:59", "Gnt6P:61", "Gnt6P:62", "ICit:31", "ICit:47", "ICit:55", "ICit:59", "ICit:61", "ICit:62", "Fru6P:31", "Fru6P:47", "Fru6P:55", "Fru6P:59", "Fru6P:61", "Fru6P:62", "FruBP:31", "FruBP:47", "FruBP:55", "FruBP:59", "FruBP:61", "FruBP:62", "Rib5P:31", "Sed7P:31", "Sed7P:47", "Sed7P:55", "Sed7P:59", "Sed7P:61", "Sed7P:62", "Sed7P:79", "Sed7P:87", "Sed7P:91", "Sed7P:93", "Sed7P:94", "Sed7P:103", "Sed7P:107", "Sed7P:109", "Sed7P:110", "Sed7P:115", "Sed7P:117", "Sed7P:118", "Sed7P:121", "Sed7P:122", "Sed7P:124", "Gnt:31", "K26pg:31", "Glc6P:31", "Gnt:47", "K26pg:47", "Glc6P:47", "Gnt:55", "K26pg:55", "Glc6P:55", "Gnt:59", "K26pg:59", "Glc6P:59", "Gnt:61", "K26pg:61", "Glc6P:61", "Gnt:62", "K26pg:62", "Glc6P:62", "Glc:31", "Kdg:31", "Glc:47", "Kdg:47", "Glc:55", "Kdg:55", "Glc:59", "Kdg:59", "Glc:61", "Kdg:61", "Glc:62", "Kdg:62", "Gnt6P:63", "ICit:63", "Fru6P:63", "FruBP:63", "Sed7P:63", "Sed7P:95", "Sed7P:111", "Sed7P:119", "Sed7P:123", "Sed7P:125", "Sed7P:126", "Gnt:63", "K26pg:63", "Glc6P:63", "Glc:63", "Kdg:63", "Sed7P:127")
nm_list$rcumo=nm_rcumo

if (case_i) {
   # check the coherence of metabolites/cumomers
   met_net=unique(matrix(unlist(strsplit(nm_rcumo, ":", fixed=TRUE)), nrow=2)[1,])
   net_pool=sort(setdiff(met_net, names(nm_poolall)))
   if (length(net_pool) > 0) {
      stop_mes("The following metabolites are internal in NETWORK section but not in METABOLITE_POOLS one:\n", paste(net_pool, collapse="\n"), file=fcerr)
   }
}

nb_exp=1
nm_exp=c("FTBL33B_condition2_G6Pcommenté_v2")
nm_list$nm_exp=nm_exp
# input cumomer vectors
xi=c(0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 1, 1)
if (length(xi)) {
   dim(xi)=c(length(xi)/nb_exp, nb_exp)
} else {
   stop_mes("No reduced label entry is defined (may be because no measurement defined in FTBL). Cannot continue.", file=fcerr)
}
nm_xi=c("Glc_1:63", "Glc_U:63", "Glc_1:31", "Glc_U:31", "Glc_1:47", "Glc_U:47", "Glc_1:55", "Glc_U:55", "Glc_1:59", "Glc_U:59", "Glc_1:61", "Glc_U:61", "Glc_1:62", "Glc_U:62", "Glc_1:15", "Glc_U:15", "Glc_1:23", "Glc_U:23", "Glc_1:27", "Glc_U:27", "Glc_1:29", "Glc_U:29", "Glc_1:30", "Glc_U:30", "Glc_1:39", "Glc_U:39", "Glc_1:43", "Glc_U:43", "Glc_1:45", "Glc_U:45", "Glc_1:46", "Glc_U:46", "Glc_1:51", "Glc_U:51", "Glc_1:53", "Glc_U:53", "Glc_1:54", "Glc_U:54", "Glc_1:57", "Glc_U:57", "Glc_1:58", "Glc_U:58", "Glc_1:60", "Glc_U:60", "Glc_1:7", "Glc_U:7", "Glc_1:11", "Glc_U:11", "Glc_1:13", "Glc_U:13", "Glc_1:14", "Glc_U:14", "Glc_1:19", "Glc_U:19", "Glc_1:21", "Glc_U:21", "Glc_1:22", "Glc_U:22", "Glc_1:25", "Glc_U:25", "Glc_1:26", "Glc_U:26", "Glc_1:28", "Glc_U:28", "Glc_1:35", "Glc_U:35", "Glc_1:37", "Glc_U:37", "Glc_1:38", "Glc_U:38", "Glc_1:41", "Glc_U:41", "Glc_1:42", "Glc_U:42", "Glc_1:44", "Glc_U:44", "Glc_1:49", "Glc_U:49", "Glc_1:50", "Glc_U:50", "Glc_1:52", "Glc_U:52", "Glc_1:56", "Glc_U:56", "Glc_1:3", "Glc_U:3", "Glc_1:5", "Glc_U:5", "Glc_1:6", "Glc_U:6", "Glc_1:9", "Glc_U:9", "Glc_1:10", "Glc_U:10", "Glc_1:12", "Glc_U:12", "Glc_1:17", "Glc_U:17", "Glc_1:18", "Glc_U:18", "Glc_1:20", "Glc_U:20", "Glc_1:24", "Glc_U:24", "Glc_1:33", "Glc_U:33", "Glc_1:34", "Glc_U:34", "Glc_1:36", "Glc_U:36", "Glc_1:40", "Glc_U:40", "Glc_1:48", "Glc_U:48", "CO2_ext:1", "Glc_1:1", "Glc_U:1", "Glc_1:2", "Glc_U:2", "Glc_1:4", "Glc_U:4", "Glc_1:8", "Glc_U:8", "Glc_1:16", "Glc_U:16", "Glc_1:32", "Glc_U:32")
rownames(xi)=nm_xi
nm_list$xi=nm_xi
nb_xi=length(nm_xi)
nb_f$xi=nb_xi
nb_cumoi=nb_xi
nm_inp=nm_xi
nm_incu=c("one", nm_xi, nm_rcumo)
nm_inlab=nm_incu
spa=spAbr
nm_x=nm_rcumo
nb_x=nb_rcumos
nb_f$rcumos=nb_rcumos
nb_f$cumoi=nb_cumoi
if (emu) {
   nm_emu=c()
   nb_emus=nb_rcumos*(seq_len(nb_rw)+1)
   nb_f$emus=nb_emus
   nm_list$emu=nm_emu
   nm_x=nm_emu
   nb_x=nb_emus
   xiemu=matrix(c(), ncol=nb_exp)
   nm_xiemu=c()
   nm_list$xiemu=nm_xiemu
   rownames(xiemu)=nm_xiemu
   nb_xiemu=length(nm_xiemu)
   nb_f$xiemu=nb_xiemu
   nb_f$xi=nb_xiemu
   nb_xi=nb_xiemu
   nm_inp=nm_xiemu
   xi=xiemu
   nm_inemu=c("one", nm_xiemu, nm_emu)
   nm_inlab=nm_inemu
   spa=spr2emu(spAbr, nm_incu, nm_inemu, nb_f)
}
# reorder indexes to accelerate sparse matrix construction
spa=sparse2spa(spa)
#browser()
# composite labeling vector incu c(1, xi, xc) names
nm_inlab=c("one", nm_inp, nm_x); # the constant 1 has name "one"
nm_list$x=nm_x
nm_list$inp=nm_inp
nb_f$x=nb_x
nm_cumo=NULL

if (TIMEIT) {
   cat("measure : ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
}
if (!noscale) {
   # make place for scaling factors
   nb_sc=vector("integer", 1)
# experiment: 1

   # mass
   # initial values for scales are set later
   param=c(param,1, 1, 1, 1, 1, 1, 1, 1, 1)
   nm_par=c(nm_par,c("1:mass;Fru6P;111111;502", "1:mass;FruBP;111111;509", "1:mass;Gnt6P;111111;482", "1:mass;ICit;111111;496", "1:mass;Mal;1111;523", "1:mass;PEP;111;534", "1:mass;PGA;111;478", "1:mass;Rib5P;11111;528", "1:mass;Sed7P;1111111;538"))
   names(param)=nm_par

   nb_param=length(param)
   nb_sc[1]=nb_param-nb_ff # at this moment it is cumulated sum. diff() is taken later

   # indices mapping from scaling to measure matrix row
   # c(1,par)[ir2isc[[iexp]]] replicates scale parameters
   # for corresponding rows of measure matrix
   ir2isc=vector("list", 1)

   # 1:mass
   ir2isc[[1]]=c(ir2isc[[1]],c(8, 8, 8, 8, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 6, 6, 6, 6, 6, 9, 9, 9, 9, 9, 9, 7, 7, 7, 7, 10, 10, 10, 10, 10, 10, 10, 10))

   isc=ir2isc[[1]] != 1
   ir2isc[[1]][isc]=ir2isc[[1]][isc]+nb_ff

   # cumulated base for nb_sc
   nb_sc_base=c(0, nb_sc[-nb_exp])
   nb_sc=diff(c(0, nb_sc))
   nb_sc_tot=sum(nb_sc)
   nb_f$nb_sc=nb_sc
   nb_f$nb_sc_tot=nb_sc_tot
   nb_f$nb_sc_base=nb_sc_base
#browser()
} else {
   # no scaling
   ir2isc=list()
   nb_sc=integer(nb_exp)
   nb_sc_tot=0
}
nb_f$nb_sc=nb_sc
nb_f$nb_sc_tot=nb_sc_tot
nm_list$par=nm_par

# make a list of sparse measurement matrices
# measmat*xr+memaone gives a vector of simulated not-yet-pooled and not-yet-scaled measurements
# all but 0. Coefficients of 0-cumomers (by defenition equal to 1)
# are all regrouped in the memaone.
nm_measmat=nm_meas=nb_meas=nb_measmat=measmat=memaone=measvec=measdev=ipooled=vector("list", 1)

nm_measmat[[1]]=c("m:PGA:1,2,3:0:478", "m:PGA:1,2,3:1:479", "m:PGA:1,2,3:2:480", "m:PGA:1,2,3:3:481", "m:Gnt6P:1,2,3,4,5,6:0:482", "m:Gnt6P:1,2,3,4,5,6:1:483", "m:Gnt6P:1,2,3,4,5,6:2:484", "m:Gnt6P:1,2,3,4,5,6:3:485", "m:Gnt6P:1,2,3,4,5,6:4:486", "m:Gnt6P:1,2,3,4,5,6:5:487", "m:Gnt6P:1,2,3,4,5,6:6:488", "m:ICit:1,2,3,4,5,6:1:496", "m:ICit:1,2,3,4,5,6:2:497", "m:ICit:1,2,3,4,5,6:3:498", "m:ICit:1,2,3,4,5,6:4:499", "m:ICit:1,2,3,4,5,6:5:500", "m:ICit:1,2,3,4,5,6:6:501", "m:Fru6P:1,2,3,4,5,6:0:502", "m:Fru6P:1,2,3,4,5,6:1:503", "m:Fru6P:1,2,3,4,5,6:2:504", "m:Fru6P:1,2,3,4,5,6:3:505", "m:Fru6P:1,2,3,4,5,6:4:506", "m:Fru6P:1,2,3,4,5,6:5:507", "m:Fru6P:1,2,3,4,5,6:6:508", "m:FruBP:1,2,3,4,5,6:0:509", "m:FruBP:1,2,3,4,5,6:1:510", "m:FruBP:1,2,3,4,5,6:2:511", "m:FruBP:1,2,3,4,5,6:3:512", "m:FruBP:1,2,3,4,5,6:4:513", "m:FruBP:1,2,3,4,5,6:5:514", "m:FruBP:1,2,3,4,5,6:6:515", "m:Mal:1,2,3,4:0:523", "m:Mal:1,2,3,4:1:524", "m:Mal:1,2,3,4:2:525", "m:Mal:1,2,3,4:3:526", "m:Mal:1,2,3,4:4:527", "m:Rib5P:1,2,3,4,5:0:528", "m:Rib5P:1,2,3,4,5:1:529", "m:Rib5P:1,2,3,4,5:2:530", "m:Rib5P:1,2,3,4,5:3:531", "m:Rib5P:1,2,3,4,5:4:532", "m:Rib5P:1,2,3,4,5:5:533", "m:PEP:1,2,3:0:534", "m:PEP:1,2,3:1:535", "m:PEP:1,2,3:2:536", "m:PEP:1,2,3:3:537", "m:Sed7P:1,2,3,4,5,6,7:0:538", "m:Sed7P:1,2,3,4,5,6,7:1:547", "m:Sed7P:1,2,3,4,5,6,7:2:548", "m:Sed7P:1,2,3,4,5,6,7:3:549", "m:Sed7P:1,2,3,4,5,6,7:4:550", "m:Sed7P:1,2,3,4,5,6,7:5:543", "m:Sed7P:1,2,3,4,5,6,7:6:544", "m:Sed7P:1,2,3,4,5,6,7:7:545")
nm_meas[[1]]=c("m:PGA:1,2,3:0:478", "m:PGA:1,2,3:1:479", "m:PGA:1,2,3:2:480", "m:PGA:1,2,3:3:481", "m:Gnt6P:1,2,3,4,5,6:0:482", "m:Gnt6P:1,2,3,4,5,6:1:483", "m:Gnt6P:1,2,3,4,5,6:2:484", "m:Gnt6P:1,2,3,4,5,6:3:485", "m:Gnt6P:1,2,3,4,5,6:4:486", "m:Gnt6P:1,2,3,4,5,6:5:487", "m:Gnt6P:1,2,3,4,5,6:6:488", "m:ICit:1,2,3,4,5,6:1:496", "m:ICit:1,2,3,4,5,6:2:497", "m:ICit:1,2,3,4,5,6:3:498", "m:ICit:1,2,3,4,5,6:4:499", "m:ICit:1,2,3,4,5,6:5:500", "m:ICit:1,2,3,4,5,6:6:501", "m:Fru6P:1,2,3,4,5,6:0:502", "m:Fru6P:1,2,3,4,5,6:1:503", "m:Fru6P:1,2,3,4,5,6:2:504", "m:Fru6P:1,2,3,4,5,6:3:505", "m:Fru6P:1,2,3,4,5,6:4:506", "m:Fru6P:1,2,3,4,5,6:5:507", "m:Fru6P:1,2,3,4,5,6:6:508", "m:FruBP:1,2,3,4,5,6:0:509", "m:FruBP:1,2,3,4,5,6:1:510", "m:FruBP:1,2,3,4,5,6:2:511", "m:FruBP:1,2,3,4,5,6:3:512", "m:FruBP:1,2,3,4,5,6:4:513", "m:FruBP:1,2,3,4,5,6:5:514", "m:FruBP:1,2,3,4,5,6:6:515", "m:Mal:1,2,3,4:0:523", "m:Mal:1,2,3,4:1:524", "m:Mal:1,2,3,4:2:525", "m:Mal:1,2,3,4:3:526", "m:Mal:1,2,3,4:4:527", "m:Rib5P:1,2,3,4,5:0:528", "m:Rib5P:1,2,3,4,5:1:529", "m:Rib5P:1,2,3,4,5:2:530", "m:Rib5P:1,2,3,4,5:3:531", "m:Rib5P:1,2,3,4,5:4:532", "m:Rib5P:1,2,3,4,5:5:533", "m:PEP:1,2,3:0:534", "m:PEP:1,2,3:1:535", "m:PEP:1,2,3:2:536", "m:PEP:1,2,3:3:537", "m:Sed7P:1,2,3,4,5,6,7:0:538", "m:Sed7P:1,2,3,4,5,6,7:1:547", "m:Sed7P:1,2,3,4,5,6,7:2:548", "m:Sed7P:1,2,3,4,5,6,7:3:549", "m:Sed7P:1,2,3,4,5,6,7:4:550", "m:Sed7P:1,2,3,4,5,6,7:5:543", "m:Sed7P:1,2,3,4,5,6,7:6:544", "m:Sed7P:1,2,3,4,5,6,7:7:545")
nb_meas[[1]]=length(nm_meas[[1]])
nb_measmat[[1]]=length(nm_measmat[[1]])
measmat[[1]]=simple_triplet_zero_matrix(nrow=nb_measmat[[1]], ncol=867)
dimnames(measmat[[1]])=list(nm_measmat[[1]], nm_x)
memaone[[1]]=numeric(nb_measmat[[1]])
measvec[[1]]=c(0.787976946, 0.002261101, 0.0, 0.209761953, 0.011180166, 0.862747992, 0.0, 0.0, 0.0, 0.0, 0.126071842, 0.336568123, 0.209903061, 0.104235848, 0.036308803, 0.004882372, 0.002222785, 0.443499709, 0.33014788, 0.02359806, 0.143587388, 0.014488359, 0.003517501, 0.041161104, 0.65067569, 0.0, 0.0, 0.320130657, 0.0, 0.0, 0.029193653, 0.691682359, 0.177593884, 0.088641212, 0.02403827, 0.018044276, 0.733967049, 0.07364764, 0.080846462, 0.078689346, 0.006484218, 0.026365287, 0.777311833, 0.044775881, 0.0, 0.177912286, 0.46115058, 0.09698129, 0.111086399, 0.00876242, 0.002730096, 0.027968489, 0.009340138, 0.004251739)
measdev[[1]]=c(0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.025, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.05, 0.05, 0.05, 0.05, 0.05, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.02, 0.02, 0.02, 0.02, 0.02, 0.05, 0.05, 0.05, 0.05, 0.02, 0.02, 0.02)
names(measvec[[1]])=nm_meas[[1]]
names(measdev[[1]])=nm_meas[[1]]
ipooled[[1]]=list(ishort=pmatch(nm_meas[[1]], nm_measmat[[1]]))

nm_meas_tot=unlist(nm_meas)
nb_meas=unlist(nb_meas)
nb_meas_cumo=c(0., cumsum(nb_meas[-nb_exp]))
iexp_meas=lapply(seq_len(nb_exp), function(iexp) seq_len(nb_meas[iexp])+nb_meas_cumo[iexp])
nm_list$meas=nm_meas
nm_list$measmat=nm_measmat
nm_list$meas_tot=nm_meas_tot
nb_f$nb_meas=nb_meas

names(measvec)=names(measdev)=nm_exp

if (!noscale) {
   for (iexp in seq_len(nb_exp))
      ir2isc[[iexp]]=ir2isc[[iexp]][ipooled[[iexp]]$ishort]

   # prepare indexes of dispatching scale params in jacobian
   if (nb_sc_tot > 0) {
      nb_f$is2m=vector("list", nb_exp)
      for (iexp in seq_len(nb_exp)) {
         ipaire=matrix(0, nrow=0, ncol=2)
         tmp=lapply(seq_len(nb_sc[[iexp]]), function(isc) {
            i=which(ir2isc[[iexp]]==isc+nb_sc_base[iexp]+1+nb_ff)
            ipaire <<- rbind(ipaire, cbind(i, isc+nb_sc_base[iexp]))
            return(NULL)
         })
         nb_f$is2m[[iexp]]=ipaire
         # place holder for scale part of jacobian
         jx_f$dr_dsc[[iexp]]=simple_triplet_zero_matrix(nrow=length(ir2isc[[iexp]]), ncol=nb_sc_tot)
      }
   }
}
# prepare measmat indexes and values : ir, ic, val

ind_mema=matrix(c(
1, 119, 1, 1, 120, 1, 1, 121, 1, 1, 1, -1, 1, 2, -1, 1, 3, -1, 1, 342, -1,
2, 1, 1, 2, 342, 3, 2, 119, -2, 2, 120, -2, 2, 2, 1, 2, 121, -2, 2, 3, 1,
3, 119, 1, 3, 342, -3, 3, 120, 1, 3, 121, 1,
4, 342, 1,
5, 122, 1, 5, 123, 1, 5, 124, 1, 5, 125, 1, 5, 126, 1, 5, 127, 1, 5, 595, 1, 5, 128, 1, 5, 129, 1, 5, 130, 1, 5, 596, 1, 5, 131, 1, 5, 597, 1, 5, 598, 1, 5, 599, 1, 5, 132, 1, 5, 133, 1, 5, 134, 1, 5, 600, 1, 5, 135, 1, 5, 601, 1, 5, 602, 1, 5, 603, 1, 5, 136, 1, 5, 604, 1, 5, 605, 1, 5, 606, 1, 5, 607, 1, 5, 608, 1, 5, 609, 1, 5, 851, 1, 5, 4, -1, 5, 5, -1, 5, 6, -1, 5, 343, -1, 5, 7, -1, 5, 344, -1, 5, 345, -1, 5, 346, -1, 5, 8, -1, 5, 347, -1, 5, 348, -1, 5, 349, -1, 5, 350, -1, 5, 351, -1, 5, 352, -1, 5, 775, -1, 5, 9, -1, 5, 353, -1, 5, 354, -1, 5, 355, -1, 5, 356, -1, 5, 357, -1, 5, 358, -1, 5, 776, -1, 5, 359, -1, 5, 360, -1, 5, 361, -1, 5, 777, -1, 5, 362, -1, 5, 778, -1, 5, 779, -1, 5, 780, -1,
6, 4, 1, 6, 343, 3, 6, 344, 3, 6, 345, 3, 6, 347, 3, 6, 348, 3, 6, 350, 3, 6, 775, 5, 6, 353, 3, 6, 354, 3, 6, 356, 3, 6, 776, 5, 6, 359, 3, 6, 777, 5, 6, 778, 5, 6, 779, 5, 6, 122, -2, 6, 123, -2, 6, 125, -2, 6, 595, -4, 6, 128, -2, 6, 596, -4, 6, 597, -4, 6, 598, -4, 6, 132, -2, 6, 600, -4, 6, 601, -4, 6, 602, -4, 6, 604, -4, 6, 605, -4, 6, 607, -4, 6, 851, -6, 6, 5, 1, 6, 346, 3, 6, 349, 3, 6, 351, 3, 6, 355, 3, 6, 357, 3, 6, 360, 3, 6, 780, 5, 6, 124, -2, 6, 126, -2, 6, 129, -2, 6, 599, -4, 6, 133, -2, 6, 603, -4, 6, 606, -4, 6, 608, -4, 6, 6, 1, 6, 352, 3, 6, 358, 3, 6, 361, 3, 6, 127, -2, 6, 130, -2, 6, 134, -2, 6, 609, -4, 6, 7, 1, 6, 362, 3, 6, 131, -2, 6, 135, -2, 6, 8, 1, 6, 136, -2, 6, 9, 1,
7, 122, 1, 7, 595, 6, 7, 596, 6, 7, 597, 6, 7, 600, 6, 7, 601, 6, 7, 604, 6, 7, 851, 15, 7, 343, -3, 7, 344, -3, 7, 347, -3, 7, 775, -10, 7, 353, -3, 7, 776, -10, 7, 777, -10, 7, 778, -10, 7, 123, 1, 7, 598, 6, 7, 602, 6, 7, 605, 6, 7, 345, -3, 7, 348, -3, 7, 354, -3, 7, 779, -10, 7, 124, 1, 7, 599, 6, 7, 603, 6, 7, 606, 6, 7, 346, -3, 7, 349, -3, 7, 355, -3, 7, 780, -10, 7, 125, 1, 7, 607, 6, 7, 350, -3, 7, 356, -3, 7, 126, 1, 7, 608, 6, 7, 351, -3, 7, 357, -3, 7, 127, 1, 7, 609, 6, 7, 352, -3, 7, 358, -3, 7, 128, 1, 7, 359, -3, 7, 129, 1, 7, 360, -3, 7, 130, 1, 7, 361, -3, 7, 131, 1, 7, 362, -3, 7, 132, 1, 7, 133, 1, 7, 134, 1, 7, 135, 1, 7, 136, 1,
8, 343, 1, 8, 775, 10, 8, 776, 10, 8, 777, 10, 8, 595, -4, 8, 596, -4, 8, 600, -4, 8, 851, -20, 8, 344, 1, 8, 778, 10, 8, 597, -4, 8, 601, -4, 8, 345, 1, 8, 779, 10, 8, 598, -4, 8, 602, -4, 8, 346, 1, 8, 780, 10, 8, 599, -4, 8, 603, -4, 8, 347, 1, 8, 604, -4, 8, 348, 1, 8, 605, -4, 8, 349, 1, 8, 606, -4, 8, 350, 1, 8, 607, -4, 8, 351, 1, 8, 608, -4, 8, 352, 1, 8, 609, -4, 8, 353, 1, 8, 354, 1, 8, 355, 1, 8, 356, 1, 8, 357, 1, 8, 358, 1, 8, 359, 1, 8, 360, 1, 8, 361, 1, 8, 362, 1,
9, 595, 1, 9, 851, 15, 9, 775, -5, 9, 776, -5, 9, 596, 1, 9, 777, -5, 9, 597, 1, 9, 778, -5, 9, 598, 1, 9, 779, -5, 9, 599, 1, 9, 780, -5, 9, 600, 1, 9, 601, 1, 9, 602, 1, 9, 603, 1, 9, 604, 1, 9, 605, 1, 9, 606, 1, 9, 607, 1, 9, 608, 1, 9, 609, 1,
10, 775, 1, 10, 851, -6, 10, 776, 1, 10, 777, 1, 10, 778, 1, 10, 779, 1, 10, 780, 1,
11, 851, 1,
12, 10, 1, 12, 363, 3, 12, 364, 3, 12, 365, 3, 12, 366, 3, 12, 367, 3, 12, 368, 3, 12, 781, 5, 12, 369, 3, 12, 370, 3, 12, 371, 3, 12, 782, 5, 12, 372, 3, 12, 783, 5, 12, 784, 5, 12, 785, 5, 12, 137, -2, 12, 138, -2, 12, 139, -2, 12, 610, -4, 12, 140, -2, 12, 611, -4, 12, 612, -4, 12, 613, -4, 12, 141, -2, 12, 614, -4, 12, 615, -4, 12, 616, -4, 12, 617, -4, 12, 618, -4, 12, 619, -4, 12, 852, -6, 12, 11, 1, 12, 373, 3, 12, 374, 3, 12, 375, 3, 12, 376, 3, 12, 377, 3, 12, 378, 3, 12, 786, 5, 12, 142, -2, 12, 143, -2, 12, 144, -2, 12, 620, -4, 12, 145, -2, 12, 621, -4, 12, 622, -4, 12, 623, -4, 12, 12, 1, 12, 379, 3, 12, 380, 3, 12, 381, 3, 12, 146, -2, 12, 147, -2, 12, 148, -2, 12, 624, -4, 12, 13, 1, 12, 382, 3, 12, 149, -2, 12, 150, -2, 12, 14, 1, 12, 151, -2, 12, 15, 1,
13, 137, 1, 13, 610, 6, 13, 611, 6, 13, 612, 6, 13, 614, 6, 13, 615, 6, 13, 617, 6, 13, 852, 15, 13, 363, -3, 13, 364, -3, 13, 366, -3, 13, 781, -10, 13, 369, -3, 13, 782, -10, 13, 783, -10, 13, 784, -10, 13, 138, 1, 13, 613, 6, 13, 616, 6, 13, 618, 6, 13, 365, -3, 13, 367, -3, 13, 370, -3, 13, 785, -10, 13, 142, 1, 13, 620, 6, 13, 621, 6, 13, 622, 6, 13, 373, -3, 13, 374, -3, 13, 376, -3, 13, 786, -10, 13, 139, 1, 13, 619, 6, 13, 368, -3, 13, 371, -3, 13, 143, 1, 13, 623, 6, 13, 375, -3, 13, 377, -3, 13, 146, 1, 13, 624, 6, 13, 379, -3, 13, 380, -3, 13, 140, 1, 13, 372, -3, 13, 144, 1, 13, 378, -3, 13, 147, 1, 13, 381, -3, 13, 149, 1, 13, 382, -3, 13, 141, 1, 13, 145, 1, 13, 148, 1, 13, 150, 1, 13, 151, 1,
14, 363, 1, 14, 781, 10, 14, 782, 10, 14, 783, 10, 14, 610, -4, 14, 611, -4, 14, 614, -4, 14, 852, -20, 14, 364, 1, 14, 784, 10, 14, 612, -4, 14, 615, -4, 14, 365, 1, 14, 785, 10, 14, 613, -4, 14, 616, -4, 14, 373, 1, 14, 786, 10, 14, 620, -4, 14, 621, -4, 14, 366, 1, 14, 617, -4, 14, 367, 1, 14, 618, -4, 14, 374, 1, 14, 622, -4, 14, 368, 1, 14, 619, -4, 14, 375, 1, 14, 623, -4, 14, 379, 1, 14, 624, -4, 14, 369, 1, 14, 370, 1, 14, 376, 1, 14, 371, 1, 14, 377, 1, 14, 380, 1, 14, 372, 1, 14, 378, 1, 14, 381, 1, 14, 382, 1,
15, 610, 1, 15, 852, 15, 15, 781, -5, 15, 782, -5, 15, 611, 1, 15, 783, -5, 15, 612, 1, 15, 784, -5, 15, 613, 1, 15, 785, -5, 15, 620, 1, 15, 786, -5, 15, 614, 1, 15, 615, 1, 15, 616, 1, 15, 621, 1, 15, 617, 1, 15, 618, 1, 15, 622, 1, 15, 619, 1, 15, 623, 1, 15, 624, 1,
16, 781, 1, 16, 852, -6, 16, 782, 1, 16, 783, 1, 16, 784, 1, 16, 785, 1, 16, 786, 1,
17, 852, 1,
18, 152, 1, 18, 153, 1, 18, 154, 1, 18, 155, 1, 18, 156, 1, 18, 157, 1, 18, 625, 1, 18, 158, 1, 18, 159, 1, 18, 160, 1, 18, 626, 1, 18, 161, 1, 18, 627, 1, 18, 628, 1, 18, 629, 1, 18, 162, 1, 18, 163, 1, 18, 164, 1, 18, 630, 1, 18, 165, 1, 18, 631, 1, 18, 632, 1, 18, 633, 1, 18, 166, 1, 18, 634, 1, 18, 635, 1, 18, 636, 1, 18, 637, 1, 18, 638, 1, 18, 639, 1, 18, 853, 1, 18, 16, -1, 18, 17, -1, 18, 18, -1, 18, 383, -1, 18, 19, -1, 18, 384, -1, 18, 385, -1, 18, 386, -1, 18, 20, -1, 18, 387, -1, 18, 388, -1, 18, 389, -1, 18, 390, -1, 18, 391, -1, 18, 392, -1, 18, 787, -1, 18, 21, -1, 18, 393, -1, 18, 394, -1, 18, 395, -1, 18, 396, -1, 18, 397, -1, 18, 398, -1, 18, 788, -1, 18, 399, -1, 18, 400, -1, 18, 401, -1, 18, 789, -1, 18, 402, -1, 18, 790, -1, 18, 791, -1, 18, 792, -1,
19, 16, 1, 19, 383, 3, 19, 384, 3, 19, 385, 3, 19, 387, 3, 19, 388, 3, 19, 390, 3, 19, 787, 5, 19, 393, 3, 19, 394, 3, 19, 396, 3, 19, 788, 5, 19, 399, 3, 19, 789, 5, 19, 790, 5, 19, 791, 5, 19, 152, -2, 19, 153, -2, 19, 155, -2, 19, 625, -4, 19, 158, -2, 19, 626, -4, 19, 627, -4, 19, 628, -4, 19, 162, -2, 19, 630, -4, 19, 631, -4, 19, 632, -4, 19, 634, -4, 19, 635, -4, 19, 637, -4, 19, 853, -6, 19, 17, 1, 19, 386, 3, 19, 389, 3, 19, 391, 3, 19, 395, 3, 19, 397, 3, 19, 400, 3, 19, 792, 5, 19, 154, -2, 19, 156, -2, 19, 159, -2, 19, 629, -4, 19, 163, -2, 19, 633, -4, 19, 636, -4, 19, 638, -4, 19, 18, 1, 19, 392, 3, 19, 398, 3, 19, 401, 3, 19, 157, -2, 19, 160, -2, 19, 164, -2, 19, 639, -4, 19, 19, 1, 19, 402, 3, 19, 161, -2, 19, 165, -2, 19, 20, 1, 19, 166, -2, 19, 21, 1,
20, 152, 1, 20, 625, 6, 20, 626, 6, 20, 627, 6, 20, 630, 6, 20, 631, 6, 20, 634, 6, 20, 853, 15, 20, 383, -3, 20, 384, -3, 20, 387, -3, 20, 787, -10, 20, 393, -3, 20, 788, -10, 20, 789, -10, 20, 790, -10, 20, 153, 1, 20, 628, 6, 20, 632, 6, 20, 635, 6, 20, 385, -3, 20, 388, -3, 20, 394, -3, 20, 791, -10, 20, 154, 1, 20, 629, 6, 20, 633, 6, 20, 636, 6, 20, 386, -3, 20, 389, -3, 20, 395, -3, 20, 792, -10, 20, 155, 1, 20, 637, 6, 20, 390, -3, 20, 396, -3, 20, 156, 1, 20, 638, 6, 20, 391, -3, 20, 397, -3, 20, 157, 1, 20, 639, 6, 20, 392, -3, 20, 398, -3, 20, 158, 1, 20, 399, -3, 20, 159, 1, 20, 400, -3, 20, 160, 1, 20, 401, -3, 20, 161, 1, 20, 402, -3, 20, 162, 1, 20, 163, 1, 20, 164, 1, 20, 165, 1, 20, 166, 1,
21, 383, 1, 21, 787, 10, 21, 788, 10, 21, 789, 10, 21, 625, -4, 21, 626, -4, 21, 630, -4, 21, 853, -20, 21, 384, 1, 21, 790, 10, 21, 627, -4, 21, 631, -4, 21, 385, 1, 21, 791, 10, 21, 628, -4, 21, 632, -4, 21, 386, 1, 21, 792, 10, 21, 629, -4, 21, 633, -4, 21, 387, 1, 21, 634, -4, 21, 388, 1, 21, 635, -4, 21, 389, 1, 21, 636, -4, 21, 390, 1, 21, 637, -4, 21, 391, 1, 21, 638, -4, 21, 392, 1, 21, 639, -4, 21, 393, 1, 21, 394, 1, 21, 395, 1, 21, 396, 1, 21, 397, 1, 21, 398, 1, 21, 399, 1, 21, 400, 1, 21, 401, 1, 21, 402, 1,
22, 625, 1, 22, 853, 15, 22, 787, -5, 22, 788, -5, 22, 626, 1, 22, 789, -5, 22, 627, 1, 22, 790, -5, 22, 628, 1, 22, 791, -5, 22, 629, 1, 22, 792, -5, 22, 630, 1, 22, 631, 1, 22, 632, 1, 22, 633, 1, 22, 634, 1, 22, 635, 1, 22, 636, 1, 22, 637, 1, 22, 638, 1, 22, 639, 1,
23, 787, 1, 23, 853, -6, 23, 788, 1, 23, 789, 1, 23, 790, 1, 23, 791, 1, 23, 792, 1,
24, 853, 1,
25, 167, 1, 25, 168, 1, 25, 169, 1, 25, 170, 1, 25, 171, 1, 25, 172, 1, 25, 640, 1, 25, 173, 1, 25, 174, 1, 25, 175, 1, 25, 641, 1, 25, 176, 1, 25, 642, 1, 25, 643, 1, 25, 644, 1, 25, 177, 1, 25, 178, 1, 25, 179, 1, 25, 645, 1, 25, 180, 1, 25, 646, 1, 25, 647, 1, 25, 648, 1, 25, 181, 1, 25, 649, 1, 25, 650, 1, 25, 651, 1, 25, 652, 1, 25, 653, 1, 25, 654, 1, 25, 854, 1, 25, 22, -1, 25, 23, -1, 25, 24, -1, 25, 403, -1, 25, 25, -1, 25, 404, -1, 25, 405, -1, 25, 406, -1, 25, 26, -1, 25, 407, -1, 25, 408, -1, 25, 409, -1, 25, 410, -1, 25, 411, -1, 25, 412, -1, 25, 793, -1, 25, 27, -1, 25, 413, -1, 25, 414, -1, 25, 415, -1, 25, 416, -1, 25, 417, -1, 25, 418, -1, 25, 794, -1, 25, 419, -1, 25, 420, -1, 25, 421, -1, 25, 795, -1, 25, 422, -1, 25, 796, -1, 25, 797, -1, 25, 798, -1,
26, 22, 1, 26, 403, 3, 26, 404, 3, 26, 405, 3, 26, 407, 3, 26, 408, 3, 26, 410, 3, 26, 793, 5, 26, 413, 3, 26, 414, 3, 26, 416, 3, 26, 794, 5, 26, 419, 3, 26, 795, 5, 26, 796, 5, 26, 797, 5, 26, 167, -2, 26, 168, -2, 26, 170, -2, 26, 640, -4, 26, 173, -2, 26, 641, -4, 26, 642, -4, 26, 643, -4, 26, 177, -2, 26, 645, -4, 26, 646, -4, 26, 647, -4, 26, 649, -4, 26, 650, -4, 26, 652, -4, 26, 854, -6, 26, 23, 1, 26, 406, 3, 26, 409, 3, 26, 411, 3, 26, 415, 3, 26, 417, 3, 26, 420, 3, 26, 798, 5, 26, 169, -2, 26, 171, -2, 26, 174, -2, 26, 644, -4, 26, 178, -2, 26, 648, -4, 26, 651, -4, 26, 653, -4, 26, 24, 1, 26, 412, 3, 26, 418, 3, 26, 421, 3, 26, 172, -2, 26, 175, -2, 26, 179, -2, 26, 654, -4, 26, 25, 1, 26, 422, 3, 26, 176, -2, 26, 180, -2, 26, 26, 1, 26, 181, -2, 26, 27, 1,
27, 167, 1, 27, 640, 6, 27, 641, 6, 27, 642, 6, 27, 645, 6, 27, 646, 6, 27, 649, 6, 27, 854, 15, 27, 403, -3, 27, 404, -3, 27, 407, -3, 27, 793, -10, 27, 413, -3, 27, 794, -10, 27, 795, -10, 27, 796, -10, 27, 168, 1, 27, 643, 6, 27, 647, 6, 27, 650, 6, 27, 405, -3, 27, 408, -3, 27, 414, -3, 27, 797, -10, 27, 169, 1, 27, 644, 6, 27, 648, 6, 27, 651, 6, 27, 406, -3, 27, 409, -3, 27, 415, -3, 27, 798, -10, 27, 170, 1, 27, 652, 6, 27, 410, -3, 27, 416, -3, 27, 171, 1, 27, 653, 6, 27, 411, -3, 27, 417, -3, 27, 172, 1, 27, 654, 6, 27, 412, -3, 27, 418, -3, 27, 173, 1, 27, 419, -3, 27, 174, 1, 27, 420, -3, 27, 175, 1, 27, 421, -3, 27, 176, 1, 27, 422, -3, 27, 177, 1, 27, 178, 1, 27, 179, 1, 27, 180, 1, 27, 181, 1,
28, 403, 1, 28, 793, 10, 28, 794, 10, 28, 795, 10, 28, 640, -4, 28, 641, -4, 28, 645, -4, 28, 854, -20, 28, 404, 1, 28, 796, 10, 28, 642, -4, 28, 646, -4, 28, 405, 1, 28, 797, 10, 28, 643, -4, 28, 647, -4, 28, 406, 1, 28, 798, 10, 28, 644, -4, 28, 648, -4, 28, 407, 1, 28, 649, -4, 28, 408, 1, 28, 650, -4, 28, 409, 1, 28, 651, -4, 28, 410, 1, 28, 652, -4, 28, 411, 1, 28, 653, -4, 28, 412, 1, 28, 654, -4, 28, 413, 1, 28, 414, 1, 28, 415, 1, 28, 416, 1, 28, 417, 1, 28, 418, 1, 28, 419, 1, 28, 420, 1, 28, 421, 1, 28, 422, 1,
29, 640, 1, 29, 854, 15, 29, 793, -5, 29, 794, -5, 29, 641, 1, 29, 795, -5, 29, 642, 1, 29, 796, -5, 29, 643, 1, 29, 797, -5, 29, 644, 1, 29, 798, -5, 29, 645, 1, 29, 646, 1, 29, 647, 1, 29, 648, 1, 29, 649, 1, 29, 650, 1, 29, 651, 1, 29, 652, 1, 29, 653, 1, 29, 654, 1,
30, 793, 1, 30, 854, -6, 30, 794, 1, 30, 795, 1, 30, 796, 1, 30, 797, 1, 30, 798, 1,
31, 854, 1,
32, 182, 1, 32, 183, 1, 32, 184, 1, 32, 185, 1, 32, 186, 1, 32, 187, 1, 32, 655, 1, 32, 28, -1, 32, 29, -1, 32, 30, -1, 32, 423, -1, 32, 31, -1, 32, 424, -1, 32, 425, -1, 32, 426, -1,
33, 28, 1, 33, 423, 3, 33, 424, 3, 33, 425, 3, 33, 182, -2, 33, 183, -2, 33, 185, -2, 33, 655, -4, 33, 29, 1, 33, 426, 3, 33, 184, -2, 33, 186, -2, 33, 30, 1, 33, 187, -2, 33, 31, 1,
34, 182, 1, 34, 655, 6, 34, 423, -3, 34, 424, -3, 34, 183, 1, 34, 425, -3, 34, 184, 1, 34, 426, -3, 34, 185, 1, 34, 186, 1, 34, 187, 1,
35, 423, 1, 35, 655, -4, 35, 424, 1, 35, 425, 1, 35, 426, 1,
36, 655, 1,
37, 188, 1, 37, 189, 1, 37, 190, 1, 37, 191, 1, 37, 192, 1, 37, 193, 1, 37, 656, 1, 37, 194, 1, 37, 195, 1, 37, 196, 1, 37, 657, 1, 37, 197, 1, 37, 658, 1, 37, 659, 1, 37, 660, 1, 37, 32, -1, 37, 33, -1, 37, 34, -1, 37, 427, -1, 37, 35, -1, 37, 428, -1, 37, 429, -1, 37, 430, -1, 37, 36, -1, 37, 431, -1, 37, 432, -1, 37, 433, -1, 37, 434, -1, 37, 435, -1, 37, 436, -1, 37, 799, -1,
38, 32, 1, 38, 427, 3, 38, 428, 3, 38, 429, 3, 38, 431, 3, 38, 432, 3, 38, 434, 3, 38, 799, 5, 38, 188, -2, 38, 189, -2, 38, 191, -2, 38, 656, -4, 38, 194, -2, 38, 657, -4, 38, 658, -4, 38, 659, -4, 38, 33, 1, 38, 430, 3, 38, 433, 3, 38, 435, 3, 38, 190, -2, 38, 192, -2, 38, 195, -2, 38, 660, -4, 38, 34, 1, 38, 436, 3, 38, 193, -2, 38, 196, -2, 38, 35, 1, 38, 197, -2, 38, 36, 1,
39, 188, 1, 39, 656, 6, 39, 657, 6, 39, 658, 6, 39, 427, -3, 39, 428, -3, 39, 431, -3, 39, 799, -10, 39, 189, 1, 39, 659, 6, 39, 429, -3, 39, 432, -3, 39, 190, 1, 39, 660, 6, 39, 430, -3, 39, 433, -3, 39, 191, 1, 39, 434, -3, 39, 192, 1, 39, 435, -3, 39, 193, 1, 39, 436, -3, 39, 194, 1, 39, 195, 1, 39, 196, 1, 39, 197, 1,
40, 427, 1, 40, 799, 10, 40, 656, -4, 40, 657, -4, 40, 428, 1, 40, 658, -4, 40, 429, 1, 40, 659, -4, 40, 430, 1, 40, 660, -4, 40, 431, 1, 40, 432, 1, 40, 433, 1, 40, 434, 1, 40, 435, 1, 40, 436, 1,
41, 656, 1, 41, 799, -5, 41, 657, 1, 41, 658, 1, 41, 659, 1, 41, 660, 1,
42, 799, 1,
43, 198, 1, 43, 199, 1, 43, 200, 1, 43, 37, -1, 43, 38, -1, 43, 39, -1, 43, 437, -1,
44, 37, 1, 44, 437, 3, 44, 198, -2, 44, 199, -2, 44, 38, 1, 44, 200, -2, 44, 39, 1,
45, 198, 1, 45, 437, -3, 45, 199, 1, 45, 200, 1,
46, 437, 1,
47, 201, 1, 47, 202, 1, 47, 203, 1, 47, 204, 1, 47, 205, 1, 47, 206, 1, 47, 661, 1, 47, 207, 1, 47, 208, 1, 47, 209, 1, 47, 662, 1, 47, 210, 1, 47, 663, 1, 47, 664, 1, 47, 665, 1, 47, 211, 1, 47, 212, 1, 47, 213, 1, 47, 666, 1, 47, 214, 1, 47, 667, 1, 47, 668, 1, 47, 669, 1, 47, 215, 1, 47, 670, 1, 47, 671, 1, 47, 672, 1, 47, 673, 1, 47, 674, 1, 47, 675, 1, 47, 855, 1, 47, 216, 1, 47, 217, 1, 47, 218, 1, 47, 676, 1, 47, 219, 1, 47, 677, 1, 47, 678, 1, 47, 679, 1, 47, 220, 1, 47, 680, 1, 47, 681, 1, 47, 682, 1, 47, 683, 1, 47, 684, 1, 47, 685, 1, 47, 856, 1, 47, 221, 1, 47, 686, 1, 47, 687, 1, 47, 688, 1, 47, 689, 1, 47, 690, 1, 47, 691, 1, 47, 857, 1, 47, 692, 1, 47, 693, 1, 47, 694, 1, 47, 858, 1, 47, 695, 1, 47, 859, 1, 47, 860, 1, 47, 861, 1, 47, 40, -1, 47, 41, -1, 47, 42, -1, 47, 438, -1, 47, 43, -1, 47, 439, -1, 47, 440, -1, 47, 441, -1, 47, 44, -1, 47, 442, -1, 47, 443, -1, 47, 444, -1, 47, 445, -1, 47, 446, -1, 47, 447, -1, 47, 800, -1, 47, 45, -1, 47, 448, -1, 47, 449, -1, 47, 450, -1, 47, 451, -1, 47, 452, -1, 47, 453, -1, 47, 801, -1, 47, 454, -1, 47, 455, -1, 47, 456, -1, 47, 802, -1, 47, 457, -1, 47, 803, -1, 47, 804, -1, 47, 805, -1, 47, 46, -1, 47, 458, -1, 47, 459, -1, 47, 460, -1, 47, 461, -1, 47, 462, -1, 47, 463, -1, 47, 806, -1, 47, 464, -1, 47, 465, -1, 47, 466, -1, 47, 807, -1, 47, 467, -1, 47, 808, -1, 47, 809, -1, 47, 810, -1, 47, 468, -1, 47, 469, -1, 47, 470, -1, 47, 811, -1, 47, 471, -1, 47, 812, -1, 47, 813, -1, 47, 814, -1, 47, 472, -1, 47, 815, -1, 47, 816, -1, 47, 817, -1, 47, 818, -1, 47, 819, -1, 47, 820, -1, 47, 867, -1,
48, 40, 1, 48, 438, 3, 48, 439, 3, 48, 440, 3, 48, 442, 3, 48, 443, 3, 48, 445, 3, 48, 800, 5, 48, 448, 3, 48, 449, 3, 48, 451, 3, 48, 801, 5, 48, 454, 3, 48, 802, 5, 48, 803, 5, 48, 804, 5, 48, 458, 3, 48, 459, 3, 48, 461, 3, 48, 806, 5, 48, 464, 3, 48, 807, 5, 48, 808, 5, 48, 809, 5, 48, 468, 3, 48, 811, 5, 48, 812, 5, 48, 813, 5, 48, 815, 5, 48, 816, 5, 48, 818, 5, 48, 867, 7, 48, 201, -2, 48, 202, -2, 48, 204, -2, 48, 661, -4, 48, 207, -2, 48, 662, -4, 48, 663, -4, 48, 664, -4, 48, 211, -2, 48, 666, -4, 48, 667, -4, 48, 668, -4, 48, 670, -4, 48, 671, -4, 48, 673, -4, 48, 855, -6, 48, 216, -2, 48, 676, -4, 48, 677, -4, 48, 678, -4, 48, 680, -4, 48, 681, -4, 48, 683, -4, 48, 856, -6, 48, 686, -4, 48, 687, -4, 48, 689, -4, 48, 857, -6, 48, 692, -4, 48, 858, -6, 48, 859, -6, 48, 860, -6, 48, 41, 1, 48, 441, 3, 48, 444, 3, 48, 446, 3, 48, 450, 3, 48, 452, 3, 48, 455, 3, 48, 805, 5, 48, 460, 3, 48, 462, 3, 48, 465, 3, 48, 810, 5, 48, 469, 3, 48, 814, 5, 48, 817, 5, 48, 819, 5, 48, 203, -2, 48, 205, -2, 48, 208, -2, 48, 665, -4, 48, 212, -2, 48, 669, -4, 48, 672, -4, 48, 674, -4, 48, 217, -2, 48, 679, -4, 48, 682, -4, 48, 684, -4, 48, 688, -4, 48, 690, -4, 48, 693, -4, 48, 861, -6, 48, 42, 1, 48, 447, 3, 48, 453, 3, 48, 456, 3, 48, 463, 3, 48, 466, 3, 48, 470, 3, 48, 820, 5, 48, 206, -2, 48, 209, -2, 48, 213, -2, 48, 675, -4, 48, 218, -2, 48, 685, -4, 48, 691, -4, 48, 694, -4, 48, 43, 1, 48, 457, 3, 48, 467, 3, 48, 471, 3, 48, 210, -2, 48, 214, -2, 48, 219, -2, 48, 695, -4, 48, 44, 1, 48, 472, 3, 48, 215, -2, 48, 220, -2, 48, 45, 1, 48, 221, -2, 48, 46, 1,
49, 201, 1, 49, 661, 6, 49, 662, 6, 49, 663, 6, 49, 666, 6, 49, 667, 6, 49, 670, 6, 49, 855, 15, 49, 676, 6, 49, 677, 6, 49, 680, 6, 49, 856, 15, 49, 686, 6, 49, 857, 15, 49, 858, 15, 49, 859, 15, 49, 438, -3, 49, 439, -3, 49, 442, -3, 49, 800, -10, 49, 448, -3, 49, 801, -10, 49, 802, -10, 49, 803, -10, 49, 458, -3, 49, 806, -10, 49, 807, -10, 49, 808, -10, 49, 811, -10, 49, 812, -10, 49, 815, -10, 49, 867, -21, 49, 202, 1, 49, 664, 6, 49, 668, 6, 49, 671, 6, 49, 678, 6, 49, 681, 6, 49, 687, 6, 49, 860, 15, 49, 440, -3, 49, 443, -3, 49, 449, -3, 49, 804, -10, 49, 459, -3, 49, 809, -10, 49, 813, -10, 49, 816, -10, 49, 203, 1, 49, 665, 6, 49, 669, 6, 49, 672, 6, 49, 679, 6, 49, 682, 6, 49, 688, 6, 49, 861, 15, 49, 441, -3, 49, 444, -3, 49, 450, -3, 49, 805, -10, 49, 460, -3, 49, 810, -10, 49, 814, -10, 49, 817, -10, 49, 204, 1, 49, 673, 6, 49, 683, 6, 49, 689, 6, 49, 445, -3, 49, 451, -3, 49, 461, -3, 49, 818, -10, 49, 205, 1, 49, 674, 6, 49, 684, 6, 49, 690, 6, 49, 446, -3, 49, 452, -3, 49, 462, -3, 49, 819, -10, 49, 206, 1, 49, 675, 6, 49, 685, 6, 49, 691, 6, 49, 447, -3, 49, 453, -3, 49, 463, -3, 49, 820, -10, 49, 207, 1, 49, 692, 6, 49, 454, -3, 49, 464, -3, 49, 208, 1, 49, 693, 6, 49, 455, -3, 49, 465, -3, 49, 209, 1, 49, 694, 6, 49, 456, -3, 49, 466, -3, 49, 210, 1, 49, 695, 6, 49, 457, -3, 49, 467, -3, 49, 211, 1, 49, 468, -3, 49, 212, 1, 49, 469, -3, 49, 213, 1, 49, 470, -3, 49, 214, 1, 49, 471, -3, 49, 215, 1, 49, 472, -3, 49, 216, 1, 49, 217, 1, 49, 218, 1, 49, 219, 1, 49, 220, 1, 49, 221, 1,
50, 438, 1, 50, 800, 10, 50, 801, 10, 50, 802, 10, 50, 806, 10, 50, 807, 10, 50, 811, 10, 50, 867, 35, 50, 661, -4, 50, 662, -4, 50, 666, -4, 50, 855, -20, 50, 676, -4, 50, 856, -20, 50, 857, -20, 50, 858, -20, 50, 439, 1, 50, 803, 10, 50, 808, 10, 50, 812, 10, 50, 663, -4, 50, 667, -4, 50, 677, -4, 50, 859, -20, 50, 440, 1, 50, 804, 10, 50, 809, 10, 50, 813, 10, 50, 664, -4, 50, 668, -4, 50, 678, -4, 50, 860, -20, 50, 441, 1, 50, 805, 10, 50, 810, 10, 50, 814, 10, 50, 665, -4, 50, 669, -4, 50, 679, -4, 50, 861, -20, 50, 442, 1, 50, 815, 10, 50, 670, -4, 50, 680, -4, 50, 443, 1, 50, 816, 10, 50, 671, -4, 50, 681, -4, 50, 444, 1, 50, 817, 10, 50, 672, -4, 50, 682, -4, 50, 445, 1, 50, 818, 10, 50, 673, -4, 50, 683, -4, 50, 446, 1, 50, 819, 10, 50, 674, -4, 50, 684, -4, 50, 447, 1, 50, 820, 10, 50, 675, -4, 50, 685, -4, 50, 448, 1, 50, 686, -4, 50, 449, 1, 50, 687, -4, 50, 450, 1, 50, 688, -4, 50, 451, 1, 50, 689, -4, 50, 452, 1, 50, 690, -4, 50, 453, 1, 50, 691, -4, 50, 454, 1, 50, 692, -4, 50, 455, 1, 50, 693, -4, 50, 456, 1, 50, 694, -4, 50, 457, 1, 50, 695, -4, 50, 458, 1, 50, 459, 1, 50, 460, 1, 50, 461, 1, 50, 462, 1, 50, 463, 1, 50, 464, 1, 50, 465, 1, 50, 466, 1, 50, 467, 1, 50, 468, 1, 50, 469, 1, 50, 470, 1, 50, 471, 1, 50, 472, 1,
51, 661, 1, 51, 855, 15, 51, 856, 15, 51, 857, 15, 51, 800, -5, 51, 801, -5, 51, 806, -5, 51, 867, -35, 51, 662, 1, 51, 858, 15, 51, 802, -5, 51, 807, -5, 51, 663, 1, 51, 859, 15, 51, 803, -5, 51, 808, -5, 51, 664, 1, 51, 860, 15, 51, 804, -5, 51, 809, -5, 51, 665, 1, 51, 861, 15, 51, 805, -5, 51, 810, -5, 51, 666, 1, 51, 811, -5, 51, 667, 1, 51, 812, -5, 51, 668, 1, 51, 813, -5, 51, 669, 1, 51, 814, -5, 51, 670, 1, 51, 815, -5, 51, 671, 1, 51, 816, -5, 51, 672, 1, 51, 817, -5, 51, 673, 1, 51, 818, -5, 51, 674, 1, 51, 819, -5, 51, 675, 1, 51, 820, -5, 51, 676, 1, 51, 677, 1, 51, 678, 1, 51, 679, 1, 51, 680, 1, 51, 681, 1, 51, 682, 1, 51, 683, 1, 51, 684, 1, 51, 685, 1, 51, 686, 1, 51, 687, 1, 51, 688, 1, 51, 689, 1, 51, 690, 1, 51, 691, 1, 51, 692, 1, 51, 693, 1, 51, 694, 1, 51, 695, 1,
52, 800, 1, 52, 867, 21, 52, 855, -6, 52, 856, -6, 52, 801, 1, 52, 857, -6, 52, 802, 1, 52, 858, -6, 52, 803, 1, 52, 859, -6, 52, 804, 1, 52, 860, -6, 52, 805, 1, 52, 861, -6, 52, 806, 1, 52, 807, 1, 52, 808, 1, 52, 809, 1, 52, 810, 1, 52, 811, 1, 52, 812, 1, 52, 813, 1, 52, 814, 1, 52, 815, 1, 52, 816, 1, 52, 817, 1, 52, 818, 1, 52, 819, 1, 52, 820, 1,
53, 855, 1, 53, 867, -7, 53, 856, 1, 53, 857, 1, 53, 858, 1, 53, 859, 1, 53, 860, 1, 53, 861, 1,
54, 867, 1,

NULL), ncol=3, byrow=TRUE); # close ind_mema creation
measmat[[1]][ind_mema[,1:2,drop=FALSE]]=ind_mema[,3]
memaone[[1]]=c(1, 0.0, 0.0, 0.0, 1, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1, 0.0, 0.0, 0.0, 0.0, 1, 0.0, 0.0, 0.0, 0.0, 0.0, 1, 0.0, 0.0, 0.0, 1, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0)

pwe=ipwe=ip2ipwe=pool_factor=ijpwef=dp_ones=meas2sum=dpw_dpf=ipf_in_ppw=vector("list", nb_exp)
mets_in_res=vector("list", nb_exp)
for (iexp in seq_len(nb_exp)) {
   names(memaone[[iexp]])=nm_measmat[[iexp]]

   # prepare weights of label data for pooled metabs
   # prepare ipwe and ip2ipwe such that pwe[ipwe]=pool[ip2ipwe]
   # gives a good base for weight sum and normalization
   pwe[[iexp]]=double(nb_measmat[[iexp]])+1.
   mets_in_res[[iexp]]=sapply(nm_measmat[[iexp]], function(m) strsplit(m, ":")[[1L]][2L])
   for (po in names(ipooled[[iexp]])) {
      if (po == "ishort") next
      nm_sum=strsplit(po, ":")[[1L]][2L]
      mets=strsplit(nm_sum, "\\+")[[1L]]
      irpo=ipooled[[iexp]][[po]]
      ipwe[[iexp]]=c(ipwe[[iexp]], irpo) # where weighting is
      i=pmatch(mets, names(nm_poolf))
      if (any(!is.na(i))) {
         for (ir in i) {
            if (is.na(ir)) next
            ijpwef[[iexp]]=rbind(ijpwef[[iexp]], cbind(irpo, ir)) # where free pools matter
         }
      }
      ip2ipwe[[iexp]]=c(ip2ipwe[[iexp]], pmatch(mets, names(nm_poolall)))
      mets_in_res[[iexp]][irpo]=mets
   }
   # order ijpwef for sparse matrix ordering
   if (!is.null(ijpwef[[iexp]])) {
      o=order(ijpwef[[iexp]][,2L], ijpwef[[iexp]][,1L])
      ijpwef[[iexp]]=ijpwef[[iexp]][o,,drop=FALSE]
   }
   pool_factor[[iexp]]=as.factor(nm_measmat[[iexp]])
   # free pool in principal pool weight
   ipf_in_ppw[[iexp]]=apply(outer(mets_in_res[[iexp]], names(nm_poolf), "=="), 1, function(v) if(length(w <-which(v))) w else NA)
   ipf_in_ppw[[iexp]][is.na(ipf_in_ppw[[iexp]])]=0L
   dp_ones[[iexp]]=matrix(0., nb_measmat[[iexp]], nb_poolf)
   dp_ones[[iexp]][cbind(ipwe[[iexp]], ipf_in_ppw[[iexp]][ipwe[[iexp]]])]=1.
   
   # matrix for summing weighted measurements
   meas2sum[[iexp]]=simple_triplet_zero_matrix(length(ipooled[[iexp]]$ishort), nb_measmat[[iexp]])
   meas2sum[[iexp]][cbind(pmatch(nm_measmat[[iexp]], nm_measmat[[iexp]][ipooled[[iexp]]$ishort], dup=TRUE),       seq_len(nb_measmat[[iexp]]))]=1.
   dimnames(meas2sum[[iexp]])=list(nm_meas[[iexp]], nm_measmat[[iexp]])
   
   # dpw_dpf - matrix for derivation of pool weights by free pools
   if (nb_poolf > 0L && length(ijpwef[[iexp]]) > 0) {
      # indeed, we'll have to do weight derivation by free pools
      dpw_dpf[[iexp]]=simple_triplet_zero_matrix(nb_measmat[[iexp]], nb_poolf)
      dpw_dpf[[iexp]][ijpwef[[iexp]]]=1.
   }
}


# prepare flux measurements
nm_fmn=nm_net[c("BM", "out_Gnt", "out_Kdg", "prot")]
nm_list$fmn=nm_fmn
nb_fmn=length(nm_fmn)
nb_f$nb_fmn=nb_fmn

# measured values
fmn=c(0.0727519, 0.05, 0.0, 0.002341)

# SD for flux measurements
fmndev=c(0.00727519, 0.005, 0.002, 0.0002341)
if (nb_fmn)
   names(fmndev)=names(fmn)=nm_fmn

# indices for measured fluxes
# fallnx[ifmn]=>fmn, here fallnx is complete net|xch flux vector
# combining unknown (dependent), free, constrainded and groth fluxes
ifmn=match(nm_fmn, nm_fallnx)

if (TIMEIT) {
   cat("ineq    : ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
}
# prepare mi matrix and li vector
# such that mi*fallnx>=li corresponds
# to the inequalities given in ftbl file
nb_ineq=14
mi=matrix(0., nrow=nb_ineq, ncol=nb_fallnx)
li=numeric(nb_ineq)
nm_i=c(c("n:0.0001<=gcd", "n:0.0001<=gad", "n:0.0001<=glk", "n:0.0001<=gntk", "n:0.0001<=kdgk", "n:0.0001<=kgud", "n:0.0001<=maldh", "n:0.0001<=edd", "n:0.0001<=gnd", "n:0.0001<=zwf", "n:0.0001<=ppc", "n:0.0001<=aceA", "n:0.0001<=mae", "n:0.0001<=pyc"), c())
dimnames(mi)=list(nm_i, nm_fallnx)
mi[1, nm_net[c("gcd")]]=c(1.0)
li[1]=0.0001
mi[2, nm_net[c("gad")]]=c(1.0)
li[2]=0.0001
mi[3, nm_net[c("glk")]]=c(1.0)
li[3]=0.0001
mi[4, nm_net[c("gntk")]]=c(1.0)
li[4]=0.0001
mi[5, nm_net[c("kdgk")]]=c(1.0)
li[5]=0.0001
mi[6, nm_net[c("kgud")]]=c(1.0)
li[6]=0.0001
mi[7, nm_net[c("maldh")]]=c(1.0)
li[7]=0.0001
mi[8, nm_net[c("edd")]]=c(1.0)
li[8]=0.0001
mi[9, nm_net[c("gnd")]]=c(1.0)
li[9]=0.0001
mi[10, nm_net[c("zwf")]]=c(1.0)
li[10]=0.0001
mi[11, nm_net[c("ppc")]]=c(1.0)
li[11]=0.0001
mi[12, nm_net[c("aceA")]]=c(1.0)
li[12]=0.0001
mi[13, nm_net[c("mae")]]=c(1.0)
li[13]=0.0001
mi[14, nm_net[c("pyc")]]=c(1.0)
li[14]=0.0001

# add standard limits on [df].xch [0;cupx]
nb_tmp=nrow(mi)
nb_fx=nb_flx+nb_ffx
if (nb_fx) {
   mi=rbind(mi, matrix(0, nrow=2*nb_fx, ncol=nb_fallnx))
   if (nb_flx)
      nm_i=c(nm_i, paste(nm_flx, ">=0", sep=""))
   if (nb_ffx)
      nm_i=c(nm_i, paste(nm_ffx, ">=0", sep=""))
   if (nb_flx)
      nm_i=c(nm_i, paste(nm_flx, "<=", cupx, sep=""))
   if (nb_ffx)
      nm_i=c(nm_i, paste(nm_ffx, "<=", cupx, sep=""))
   li=c(li, rep(0, nb_fx), rep(-cupx, nb_fx))
   mi[nb_tmp+(1:nb_fx),c(nm_flx, nm_ffx)]=diag(1., nb_fx)
   mi[nb_tmp+nb_fx+(1:nb_fx),c(nm_flx, nm_ffx)]=diag(-1., nb_fx)
}

nm_inout=grep("^[^c]\\.", nm_net[c("bs_glc6P", "bs_fru6P", "bs_ga3p", "bs_pga", "bs_pyr", "bs_e4p", "bs_rib5p", "bs_pep", "bs_accoa", "bs_akg", "bs_oaa", "bsp_rib5p", "bsp_e4p", "bsp_pga", "bsp_pep", "bsp_pyr", "bsp_accoa", "bsp_oaa", "bsp_akg", "out_Gnt", "out_Kdg", "out_co2", "Glc_in_1", "Glc_in_U", "CO2_in")], v=TRUE) # strip out constrained fluxes
nb_inout=length(nm_inout)
if (nb_inout > 0) {
   # add cinout low limits on inout net fluxes
   nb_tmp=nrow(mi)
   # explicit inequalities take precedence over generic ones
   # so eliminate inout fluxes which are already in inequalities
   nm_itmp=paste("n:.+<=", substring(nm_inout, 5), sep="")
   i=sapply(1:length(nm_itmp), function(k) {
      j=grep(nm_itmp[k], nm_i)
      #cat(nm_itmp[k], "->", nm_i[j], "\n", file=fclog)
      if (length(j)==0) {
         return(0)
      } else {
         return(k)
      }
   })
   i=i[i!=0]
   if (length(i) > 0) {
      nm_tmp=nm_inout[-i]
   } else {
      nm_tmp=nm_inout
   }
   len_tmp=length(nm_tmp)
   if (len_tmp > 0) {
      mi=rbind(mi, matrix(0, nrow=len_tmp, ncol=nb_fallnx))
      nm_i=c(nm_i, paste("inout ", nm_tmp, ">=", cinout, sep=""))
      mi[nb_tmp+(1:len_tmp), nm_tmp]=diag(1., len_tmp)
      li=c(li, rep(cinout, len_tmp))
   }
}
if (clownr!=0.) {
   # add low limits on net >= clownr for not reversible reactions
   nb_tmp=nrow(mi)
   nm_tmp=nm_net[c("Glc_in_1", "Glc_in_U", "bs_glc6P", "BM", "bs_fru6P", "bs_ga3p", "bs_pga", "bs_pyr", "bs_e4p", "bs_rib5p", "bs_pep", "bs_accoa", "bs_akg", "bs_oaa", "gntk", "kdgk", "bsp_rib5p", "prot", "bsp_e4p", "bsp_pga", "bsp_pep", "bsp_pyr", "bsp_accoa", "bsp_oaa", "bsp_akg", "out_Gnt", "out_Kdg", "out_co2", "CO2_in", "gcd", "gad", "glk", "kgud", "fba", "pyk", "zwf", "gnd", "edd", "eda", "pdh", "citsynth", "idh", "akgdh", "aceA", "aceB", "ppc", "mae", "pyc")]
   # explicit inequalities take precedence over generic ones
   # so eliminate notrev fluxes which are already in inequalities
   nm_itmp=paste("n:.+<=", substring(nm_tmp, 5), sep="")
   i=sapply(1:length(nm_itmp), function(k) {
      j=grep(nm_itmp[k], nm_i)
      #cat(nm_itmp[k], "->", nm_i[j], "\n", file=fclog)
      if (length(j)==0) {
         return(0)
      } else {
         return(k)
      }
   })
   i=i[i!=0]
   if (length(i) > 0) {
      nm_tmp=nm_tmp[-i]
   }
   # search for inout too
   nm_itmp=paste("inout ", nm_tmp, ">=", sep="")
   i=sapply(1:length(nm_itmp), function(k) {
      j=grep(nm_itmp[k], nm_i, fix=TRUE)
      #cat(nm_itmp[k], "->", nm_i[j], "\n", file=fclog)
      if (length(j)==0) {
         return(0)
      } else {
         return(k)
      }
   })
   i=i[i!=0]
   if (length(i) > 0) {
      nm_tmp=nm_tmp[-i]
   }

   len_tmp=length(nm_tmp)
   if (len_tmp > 0) {
      mi=rbind(mi, matrix(0, nrow=len_tmp, ncol=nb_fallnx))
      nm_i=c(nm_i, paste(nm_tmp, ">=", clownr, sep=""))
      mi[nb_tmp+(1:len_tmp), nm_tmp]=diag(1., len_tmp)
      li=c(li, rep(clownr, len_tmp))
   }
}
nb_fn=nb_fln+nb_ffn
if (cupn != 0 && nb_fn > 0) {
   # add absolute upper limits on -cupn <= [df].net <= cupn for net fluxes
   # explicit inequalities take precedence over generic ones
   # so eliminate net fluxes which are already in inequalities
   ## proceed n:smth>=flux
   nm_tmp=c(nm_ffn, nm_fln) # all not fixed net fluxes
   nm_itmp=paste("n:.+>=", substring(nm_tmp, 5), sep="")
   i=sapply(vgrep(nm_itmp, nm_i), length)
   i=which(i!=0)
   if (length(i) > 0) {
      nm_tmp=nm_tmp[-i]
   }
   len_tmp=length(nm_tmp)
   if (len_tmp > 0) {
      nb_tmp=nrow(mi)
      mi=rbind(mi, matrix(0, nrow=len_tmp, ncol=nb_fallnx))
      nm_i=c(nm_i, paste0(nm_tmp, "<=", cupn))
      li=c(li, rep(-cupn, len_tmp))
      mi[nb_tmp+(1:len_tmp),nm_tmp]=diag(-1., len_tmp)
   }
   ## proceed n:smth<=flux
   nm_tmp=c(nm_ffn, nm_fln) # all not fixed net fluxes
   nm_itmp=paste("n:.+<=", substring(nm_tmp, 5), sep="")
   i=sapply(vgrep(nm_itmp, nm_i), length)
   i=which(i!=0)
   if (length(i) > 0) {
      nm_tmp=nm_tmp[-i]
   }
   len_tmp=length(nm_tmp)
   if (len_tmp > 0) {
      nb_tmp=nrow(mi)
      mi=rbind(mi, matrix(0, nrow=len_tmp, ncol=nb_fallnx))
      nm_i=c(nm_i, paste0(nm_tmp, ">=", -cupn))
      li=c(li, rep(-cupn, len_tmp))
      mi[nb_tmp+(1:len_tmp),nm_tmp]=diag(1., len_tmp)
   }
}
#browser()
nb_ineq=NROW(li);

dimnames(mi)=list(nm_i, nm_fallnx)
names(li)=nm_i
# prepare ui matrix and ci vector for optimisation
# ui%*%param-ci>=0
# it is composed of explicite inequalities from ftbl
# and permanent inequalities 0<=xch<=0.999 and scale>=0

# constraints such that ui%*%param-ci>=0
# first flux part
ui=mi%*%(md%*%invAfl%stm%p2bfl+mf)
mic=(md%*%invAfl%*%(c2bfl%stm%fc+cnst2bfl) + mc%*%fc)
ci=as.numeric(li-mi%*%mic)

# finaly, metab part
uip=matrix(0., 0, ncol=nb_poolf)
colnames(uip)=nm_poolf
cip=c()
# ind: irow, metab, coef, rhs, name
uip_ind=c(

)
if (length(uip_ind) > 0) {
   uip_ind=matrix(uip_ind, byrow=TRUE, ncol=5L)
} else {
   uip_ind=matrix(0, 0L, 5L)
}
colnames(uip_ind)=c("irow", "metab", "coef", "rhs", "name")


if (nrow(uip_ind) > 0) {
   # rhs are summed up for the same irow by aggregate()
   irow=as.integer(uip_ind[,"irow"])
   cip=aggregate(as.double(uip_ind[,"rhs"]), by=list(irow), sum)[,"x"]
   for (i in seq_len(nrow(uip_ind))) {
      row=uip_ind[i,]
      if (nchar(row["metab"])==0) {
         next
      }
      uip[irow[i], nm_poolf[row["metab"]]]=as.double(row["coef"])
   }
   if (nrow(uip) > 0) {
      rownames(uip)=paste("m:", uip_ind[pmatch(seq_len(nrow(uip)), irow),"name"], sep="")
   }
}
names(cip)=rownames(uip)

#browser() # before null inequality removing
# remove all zero rows in ui (constrained fluxes with fixed values)
# find zero indexes
#print(dim(ui))
if (ncol(ui)) {
   zi=apply(ui,1,function(v){return(max(abs(v))<=1.e-14)})
} else {
   # remove all flux inequalities as there is no free fluxe
   zi=rep(TRUE, nrow(ui))
}

if (!all(ci[zi]<=1.e-10)) {
   cat("The following constant inequalities are not satisfied:\n", file=fcerr)
   cat(nm_i[zi][ci[zi]>1.e-10], sep="\n", file=fcerr)
   cat("They are simply ignored.\n", file=fcerr)
   #stop_mes("", file=fcerr)
}
ui=ui[!zi,,drop=FALSE]
ci=ci[!zi]
nm_i=nm_i[!zi]

# complete ui by zero columns corresponding to scale params
if (nb_sc_tot) {
   ui=cBind(as.matrix(ui), matrix(0., NROW(ui), nb_sc_tot))
   # complete ui by scales >=0
   ui=rBind(ui, cBind(matrix(0, nb_sc_tot, nb_ff), diag(1, nb_sc_tot)))
   ci=c(ci,rep(0., nb_sc_tot))
   nm_i=c(nm_i, paste(nm_par[nb_ff+seq_len(nb_sc_tot)], ">=0", sep=""))
   rownames(ui)=nm_i
   names(ci)=nm_i
}

# remove redundant inequalities
#browser()
nb_i=nrow(ui)
ired=c()
if (nb_i > 1L) {
   for (i in 1L:(nb_i-1L)) {
      nmref=nm_i[i]
      for (j in setdiff((i+1L):nb_i, ired)) {
         if (all(ui[j,]==ui[i,]) && ci[i]==ci[j]) {
            # redundancy
            cat("inequality '", nm_i[j], "' redundant with '", nmref, "' is removed.
", sep="", file=fclog)
            ired=c(ired, j)
         }
      }
   }
}
if (!is.null(ired)) {
   # remove all ired inequalities
   ui=ui[-ired,,drop=FALSE]
   ci=ci[-ired]
   nm_i=nm_i[-ired]
}

# metabolite equalities
ep=matrix(0., 0, ncol=nb_poolf)
cp=c()
colnames(ep)=nm_poolf
# ind: irow, metab, coef, rhs, name
ep_ind=c(

)
if (length(ep_ind) > 0) {
   ep_ind=matrix(ep_ind, byrow=TRUE, ncol=5L)
} else {
   ep_ind=matrix(0, 0L, 5L)
}
colnames(ep_ind)=c("irow", "metab", "coef", "rhs", "name")


if (nrow(ep_ind) > 0) {
   # rhs are summed up for the same irow by aggregate
   irow=as.integer(ep_ind[,"irow"])
   cp=aggregate(as.double(ep_ind[,"rhs"]), by=list(irow))[,"x"]
   for (i in seq_len(nrow(ep_ind))) {
      row=ep_ind[i,]
      if (nchar(row["metab"])==0) {
         next
      }
      ep[irow[i], nm_poolf[row["metab"]]]=as.double(row["coef"])
   }
   if (nrow(ep) > 0) {
      rownames(ep)=paste("m:", ep_ind[pmatch(seq_len(nrow(ep)), irow),"name"], sep="")
   }
}
ep=as.matrix(ep)
names(cp)=rownames(ep)

nb_sys=list(
   reactions=list(
      reversible=11,
      non_reversible=48
   ),
   fluxes=list(
      free=24,
      dependent=50,
      constrained=48
   ),
   metabolites=list(
      input=3,
      output=22,
      intra=27
   ),
   measurements=list(
      flux=4,
      mass=54,
      peak=0,
      label=0,
      metab=0
   ),
   equations=list(
      equalities=23,
      inequalities=14
   ),
   label_variables=list(
      full=c(0,0,0,0,0,0,0),
      reduced_cumomers=c(118,223,253,180,76,16,1)
   ),
   parallel_experiments=1
)
if (sum(nb_sys$label_variables$full)==0) {
   nb_sys$label_variables$full=NULL
}
if (emu) {
   x=nb_sys$label_variables$reduced_cumomers
   nb_sys$label_variables$reduced_cumomers=NULL
   nb_sys$label_variables$emu=paste(x, "*", seq_len(length(x)), "=", x*seq_len(length(x)))
}

#browser()

# extend param vector by free pools
if (nb_poolf > 0) {
   param=c(param, poolf)
   nm_par=c(nm_par, nm_poolf)
   nb_param=length(param)
}
nm_list$par=nm_par

#browser()
if (nb_poolf > 0) {
   # extend inequalities ui, ci by uip, cip
   nb_row=nrow(ui)
   nb_col=ncol(ui)
   ui=cbind(ui, matrix (0., nrow=nb_row, ncol=nb_poolf)) # add 0-columns
   ui=rbind(ui, cbind(matrix(0., nrow(uip), ncol=nb_col), uip))
   ci=c(ci, cip)
   
   # extend inequalities ui, ci by cupp>= poolf >= clowp
   # but exclude metabolites that are individually set in the uip (FTBL)
   met_low=met_up=c()
   if (nrow(uip) > 0) {
      # number of non zero entries per row in uip
      i_nz=rowSums(abs(uip) != 0.)
      # number of positive coeffs for alone metabs (i.e. low limit is set)
      i_pos=colSums(uip[i_nz > 0,,drop=FALSE] > 0)
      met_low=nm_poolf[i_pos > 0]
      # number of negative coeffs for alone metabs (i.e. upper limit is set)
      i_neg=colSums(uip[i_nz > 0,,drop=FALSE] < 0)
      met_up=nm_poolf[i_neg > 0]
   }

   # add low limit
   nb_add=nb_poolf-length(met_low)
   if (nb_add > 0) {
      nm_add=nm_poolf[!nm_poolf %in% met_low]
      ui_add=matrix(0., nrow=nb_add, ncol=ncol(ui))
      ui_add[,nb_col+pmatch(nm_add, nm_poolf)]=diag(1., nb_add)
      rownames(ui_add)=paste(nm_add, ">=", clowp, sep="")
      if (nrow(ui)) {
         ui=rbind(ui, ui_add)
      } else {
         ui=ui_add
      }
      ci=c(ci, rep(clowp, nb_add))
   }

   # add upper limit
   nb_add=nb_poolf-length(met_up)
   if (nb_add > 0) {
      nm_add=nm_poolf[!nm_poolf %in% met_up]
      ui_add=matrix(0., nrow=nb_add, ncol=ncol(ui))
      ui_add[,nb_col+pmatch(nm_add, nm_poolf)]=diag(-1., nb_add)
      rownames(ui_add)=paste(nm_add, "<=", cupp, sep="")
      ui=rbind(ui, ui_add)
      ci=c(ci, rep(-cupp, nb_add))
   }

   nm_i=names(ci)=rownames(ui)
   colnames(ui)=nm_par
}
# extend the matrix of metabolite equalities
ep=cbind(matrix(0., nrow(ep), nb_param-nb_poolf), ep)
colnames(ep)=nm_par

# prepare metabolite pools measurements
nb_poolm=0
nb_f$nb_poolm=nb_poolm
nm_poolm=c()
nm_list$poolm=nm_poolm

# measured values
vecpoolm=c()
names(vecpoolm)=nm_poolm

# inverse of variance for pool measurements
poolmdev=c()
names(poolmdev)=nm_poolm

# simulated metabolite measurements are calculated as
# measmatpool*poolall=>poolm
measmatpool=matrix(0., nrow=nb_poolm, ncol=length(poolall))
dimnames(measmatpool)=list(nm_poolm, nm_poolall)
i=matrix(1+c(), ncol=2, byrow=T)
measmatpool[i]=1.


# gather all measurement information
measurements=list(
   vec=list(labeled=measvec, flux=fmn, pool=vecpoolm, kin=if (case_i) measvecti else NULL),
   dev=list(labeled=measdev, flux=fmndev, pool=poolmdev, kin=if (case_i) lapply(structure(seq(nb_exp), names=names(measdev)), function(i) {v=measdev[[i]]; nbc=if (is.null(measvecti[[i]])) 0 else ncol(measvecti[[i]]); suppressWarnings(matrix(v, nrow=length(v), ncol=nbc))}) else NULL),
   mat=list(labeled=measmat, flux=ifmn, pool=measmatpool),
   one=list(labeled=memaone)
)
nm_resid=c(if (case_i) unlist(lapply(seq_len(nb_exp), function(iexp) {m=outer(rownames(measvecti[[iexp]]), ti[[iexp]][-1L], paste, sep=", t="); if (length(m) > 0L) paste(iexp, m, sep=":", recycle0=TRUE) else character(0L)})) else unlist(lapply(seq_len(nb_exp), function(iexp) paste(iexp, nm_meas[[iexp]], sep=":"))), nm_fmn, nm_poolm)
nm_list$resid=nm_resid

if (TIMEIT) {
   cat("preopt  : ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
}
#browser()
names(param)=nm_par
# prepare series of starting points
if (nchar(fseries) > 0) {
   pstart=as.matrix(read.table(fseries, header=T, row.n=1, sep="\t"))
   # skip parameters (rows) who's name is not in nm_par
   i=rownames(pstart) %in% nm_par
   if (!any(i)) {
      stop_mes("Option --fseries is used but no free parameter with known name is found.\n", file=fcerr)
   }
   pstart=pstart[i,,drop=FALSE]
   cat("Using starting values form '", fseries, "' for the following free parameters:\n", paste(rownames(pstart), collapse="\n"), "\n", sep="", file=fclog)
   nseries=ncol(pstart)
   if (initrand) {
      # fill the rest of rows with random values
      i=nm_par %in% rownames(pstart)
      n=sum(!i)
      pstart=rbind(pstart, matrix(runif(n*nseries), n, nseries))
      rownames(pstart)=c(rownames(pstart)[seq_len(nb_param-n)], nm_par[!i])
   }
   if (nchar(iseries) > 0) {
      iseries=unique(as.integer(eval(parse(t="c("%s+%iseries%s+%")"))))
      iseries=iseries[iseries<=nseries]
      # subsample
      pstart=pstart[,iseries, drop=FALSE]
      nseries=ncol(pstart)
   } else {
      iseries=seq_len(nseries)
   }
} else if (nchar(iseries) > 0) {
   # first construct pstart then if needed fill it with random values
   # and only then subsample
   iseries=unique(as.integer(eval(parse(t="c("%s+%iseries%s+%")"))))
   nseries=max(iseries)
   pstart=matrix(rep(param, nseries), nrow=nb_param, ncol=nseries)
   dimnames(pstart)=list(nm_par, paste("V", seq_len(nseries), sep=""))
   if (initrand) {
      # fill pstart with random values
      pstart[]=runif(length(pstart))
   }
   # subsample
   pstart=pstart[,iseries, drop=FALSE]
   nseries=ncol(pstart)
} else {
   iseries=1L
   pstart=as.matrix(param)
   nseries=1L
   if (initrand) {
      # fill pstart with random values
      pstart[]=runif(length(pstart))
   }
}
nm_pseries=rownames(pstart)

if (is.null(nseries) || nseries==0) {
   stop_mes(sprintf("No starting values in the series file '%s' or --iseries is empty.", fseries),  file=fcerr)
}

pres=matrix(NA, nb_param, nseries)
rownames(pres)=nm_par
colnames(pres)=colnames(pstart)
costres=rep.int(NA, nseries)

# prepare flux index conversion
ifwrv=1:nb_fwrv
names(ifwrv)=nm_fwrv
ifl_in_fw=if (nb_fln) ifwrv[paste("fwd", substring(c(nm_fln, nm_flx), 4), sep="")] else integer(0)
iff_in_fw=if (nb_ff > 0) ifwrv[paste("fwd", substring(c(nm_ffn, nm_ffx), 4), sep="")] else integer(0)
ifg_in_fw=if (nb_fgr > 0) ifwrv[paste("fwd", substring(nm_fgr, 4), sep="")] else integer(0)

# index couples for jacobian df_dfl, df_dffd
cfw_fl=crv_fl=cbind(ifl_in_fw, seq_len(nb_fl))
cfw_ff=crv_ff=cbind(iff_in_fw, seq_len(nb_ff))
cfw_fg=crv_fg=cbind(ifg_in_fw, nb_ff+seq_len(nb_fgr))
crv_fl[,1L]=(nb_fwrv/2)+crv_fl[,1L]
crv_ff[,1L]=(nb_fwrv/2)+crv_ff[,1L]
crv_fg[,1L]=(nb_fwrv/2)+crv_fg[,1L]

# store it in nb_f
nb_f=append(nb_f, list(cfw_fl=cfw_fl, crv_fl=crv_fl, cfw_ff=cfw_ff,
   crv_ff=crv_ff, cfw_fg=cfw_fg, crv_fg=crv_fg))
nb_f=as.environment(nb_f)

nbc_x=c(0, cumsum(nb_x))
nb_f$nbc_x=nbc_x

# fixed part of jacobian (unreduced by SD)
# measured fluxes
dufm_dp=cbind(dufm_dff(nb_f, nm_list), matrix(0, nrow=nb_fmn, ncol=nb_sc_tot+nb_poolf))
dimnames(dufm_dp)=list(nm_fmn, nm_par)

# measured pools
dupm_dp=matrix(0., nb_poolm, nb_ff+nb_sc_tot)
if (nb_poolf > 0L) {
   dupm_dp=cbind(dupm_dp, measurements$mat$pool[,nm_list$poolf, drop=FALSE])
}
dimnames(dupm_dp)=list(rownames(measurements$mat$pool), nm_par)

#browser()
# prepare argument list for passing to label simulating functions
nm_labargs=c("jx_f", "nb_f", "nm_list", "nb_x", "invAfl", "p2bfl", "g2bfl", "bp", "fc", "xi", "spa", "emu", "pool", "measurements", "ipooled", "ir2isc",  "nb_w", "nbc_x", "measmat", "memaone", "dufm_dp", "dupm_dp", "pwe", "ipwe", "ip2ipwe", "pool_factor", "ijpwef", "ipf_in_ppw", "meas2sum", "dp_ones", "clen", "dirr", "dirw", "baseshort", "case_i", "nb_exp", "noscale", "dpw_dpf")

if (TIMEIT) {
   cat("labargs : ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
}
labargs=new.env()
tmp=lapply(nm_labargs, function(nm) assign(nm, get(nm), labargs))
#for (nm in nm_labargs) {
#   labargs[[nm]]=get(nm)
#}
labargs[["nm"]]=labargs[["nm_list"]]

# prepare labargs2 if time_order includes 2
if (case_i && (time_order == "2" || time_order == "1,2")) {
   labargs2=as.environment(as.list(labargs))
   labargs2$nb_f=as.environment(as.list(labargs$nb_f))
   labargs2$tifull=tifull2
   labargs2$xi=xi2
   labargs2$jx_f=new.env()
   labargs2$nb_f$ipf2ircumo=nb_f$ipf2ircumo2
   labargs2$nb_f$tifu=nb_f$tifu2
   labargs[["labargs2"]]=labargs2
}

# formated output in kvh file
fkvh_saved=file.path(dirw, sprintf("%s_res.kvh", baseshort))

retcode=numeric(nseries)
cl_type="PSOCK"
cl=NULL
if ((case_i && (time_order %in% c("1,2", "2"))) || sensitive == "mc") {
   if (np > 1L) {
      # prepare cluster
      nodes=if (sensitive == "mc") np else 2

      # prepare cluster
      cl=makeCluster(nodes, cl_type) #, outfile="cl.log")
#cat("make cluster=")
#print(cl[[1]])
      labargs[["cl"]]=cl
      nodes=length(cl)
      if (TIMEIT) {
         cat("cl expor: ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
      }
      clusterExport(cl, c("lsi_fun", "df_dffp", "lab_sim", "is.diff", "lab_resid", "ui", "ci", "ep", "cp", "control_ftbl", "methods", "sln", "labargs", "dirr", "emu", "%stm%", "case_i", "time_order"))
      if (TIMEIT) {
         cat("cl sourc: ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
      }
      clusterEvalQ(cl, {
         #idth=myinfo$id
         suppressPackageStartupMessages(library(nnls))
         suppressPackageStartupMessages(library(slam)) # for quick sparse matrices
         suppressPackageStartupMessages(library(Rcpp))
         suppressPackageStartupMessages(library(RcppArmadillo))
         suppressPackageStartupMessages(library(rmumps))
         suppressPackageStartupMessages(library(arrApply)) # for fast apply() on arrays
         suppressPackageStartupMessages(library(multbxxc))
         compiler::enableJIT(0)
         source(file.path(dirr, "tools_ssg.R"))
         source(file.path(dirr, "nlsic.R"))
         source(file.path(dirr, "opt_cumo_tools.R"))
         source(file.path(dirr, "opt_icumo_tools.R"))
         #loadcmp(file.path(dirr, "tools_ssg.Rc"))
         #loadcmp(file.path(dirr, "nlsic.Rc"))
         #loadcmp(file.path(dirr, "opt_cumo_tools.Rc"))
         #loadcmp(file.path(dirr, "opt_icumo_tools.Rc"))
         labargs$spa=sparse2spa(labargs$spa)
         if (case_i && (time_order == "2" || time_order == "1,2")) {
            labargs$labargs2$spa=labargs$spa
         }
#cat("evalQ idth=", idth, "\n")
#print(labargs)
#print(labargs$labargs2)
#print(labargs$spa)
#print(labargs$labargs2$spa)
         NULL
      })
      clusterSetRNGStream(cl)
      # set worker id
      idw=parLapply(cl, seq_along(cl), function(i) assign("idw", i, envir=.GlobalEnv))
   } else {
      labargs$cl=NULL
   }
}
for (irun in seq_len(nseries)) {
   if (TIMEIT) {
      cat(sprintf("run %4d: %s cpu=%g\n", irun, format(Sys.time()), proc.time()[1], "\n", sep=""), file=fclog)
   }
   param[nm_pseries]=pstart[nm_pseries, irun]
#browser()
   # prepare kvh file name
   if (nseries > 1) {
      runsuf="." %s+% colnames(pstart)[irun]
   } else {
      runsuf=""
   }
   if (length(nseries) > 0) {
      cat("Starting point", runsuf, "\n", sep="", file=fclog)
   }
   fkvh=file(substring(fkvh_saved, 1, nchar(fkvh_saved)-4) %s+% runsuf %s+% ".kvh", "w");

   # remove zc inequalities from previous runs
   izc=grep("^zc ", nm_i)
   if (length(izc)) {
      ui=ui[-izc,,drop=FALSE]
      ci=ci[-izc]
      nm_i=rownames(ui)
   }
   # check if initial approximation is feasible
   ineq=as.numeric(ui%*%param-ci)
   names(ineq)=rownames(ui)
   # set tolerance for inequality
   tol_ineq=if ("BFGS" %in% methods) 0. else 1.e-10
   nbad=sum(ineq <= -tol_ineq)
   if (nbad > 0) {
      cat("The following ", nbad, " inequalities are not respected at starting point", runsuf, ":\n", sep="", file=fclog)
      i=ineq[ineq<= -tol_ineq]
      cat(paste(names(i), i, sep="\t", collapse="\n"), "\n", sep="", file=fclog)
      # put them inside
      capture.output(pinside <- put_inside(param, ui, ci), file=fclog)
      if (any(is.na(pinside))) {
         if (!is.null(attr(pinside, "err")) && attr(pinside, "err")!=0) {
            # fatal error occured
            cat("put_inside", runsuf, ": ", attr(pinside, "mes"), "\n",
               file=fcerr, sep="")
            #close(fkvh)
            retcode[irun]=attr(pinside, "err")
            next;
         }
      } else if (!is.null(attr(pinside, "err")) && attr(pinside, "err")==0) {
         # non fatal problem
         cat(paste("put_inside: ", attr(pinside, "mes"), collapse=""), "\n", file=fcerr)
      }
      param[]=pinside
   }

   # prepare zero crossing strategy
   # inequalities to keep sens of net flux on first call to opt_wrapper()
   # if active they are removed on the second call to opt_wrapper()
   # and finaly all zc constraints are relaxed on the last call to opt_wrapper()
   fallnx=param2fl(param, labargs)$fallnx
   mi_zc=NULL
   li_zc=NULL
   if (zerocross && length(grep("^[df]\\.n\\.", nm_fallnx))>0) {
      if (TIMEIT) {
         cat("zc ineq : ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
      }
#browser()
      # prepare fluxes that are already in inequalities in alone mode
      ige=names(which(apply(mi, 1L, function(v) diff(range(v))==1 && sum(v)==1) & li>=0))
      ige=nm_dfn[unique(c(
         sub("^n:.+<=(.+)$", "\\1", grep("^n:.+<=.+$", ige, v=T)),
         sub("^[df]\\.n\\.(.+)>=.+$", "\\1", grep("^[df]\\.n\\..+>=.+$", ige, v=T)),
         sub("^inout [df]\\.n\\.(.+)>=.+$", "\\1", grep("^inout [df]\\.n\\..+>=.+$", ige, v=T))
      ))]
      ile=which(apply(mi, 1L, function(v) diff(range(v))==1 && sum(v)==-1)&li>=0)
      ile=nm_dfn[unique(c(
         sub("^n:.+<=(.+)$", "\\1", grep("^n:.+<=.+$", ile, v=T)),
         sub("^[df]\\.n\\.(.+)>=.+$", "\\1", grep("^[df]\\.n\\..+>=.+$", ile, v=T)),
         sub("^inout [df]\\.n\\.(.+)>=.+$", "\\1", grep("^inout [df]\\.n\\..+>=.+$", ile, v=T))
      ))]
      # add lower limits on [df].net >= zc for positive net fluxes
      # and upper limits on [df].net <= -zc for negative net fluxes
      nm_izc=c()
      ipos=setdiff(names(which(fallnx[grep("^[df]\\.n\\.", nm_fallnx)]>=0.)), ige)
      ineg=setdiff(names(which(fallnx[grep("^[df]\\.n\\.", nm_fallnx)]<0.)), ile)
      mi_zc=matrix(0, nrow=length(ipos)+length(ineg), ncol=nb_fallnx)
      colnames(mi_zc)=nm_fallnx
      if (length(ipos)) {
         nm_izc=c(nm_izc, paste("zc ", ipos, ">=", zc, sep=""))
         mi_zc[(1:length(ipos)),ipos]=diag(1., length(ipos))
      }
      if (length(ineg)) {
         nm_izc=c(nm_izc, paste("zc ", ineg, "<=", -zc, sep=""))
         mi_zc[length(ipos)+(1:length(ineg)),ineg]=diag(-1., length(ineg))
      }
      rownames(mi_zc)=nm_izc
      li_zc=rep(zc, length(nm_izc)) # that's ok for both pos and neg constraints
      ui_zc=cbind(mi_zc%*%(md%*%invAfl%stm%p2bfl+mf),
         matrix(0., nrow=nrow(mi_zc), ncol=nb_sc_tot))
      if (nb_fgr > 0) {
         ui_zc=cbind(ui_zc, mi_zc%*%((md%*%invAfl%stm%g2bfl)+mg*nb_f$mu))
      } else if (nb_poolf > 0) {
         ui_zc=cbind(ui_zc, matrix(0., nrow=nrow(mi_zc), ncol=nb_poolf))
      }
      ci_zc=li_zc-mi_zc%*%mic
      # remove constant inequalities
      if (ncol(ui_zc)) {
         zi=apply(ui_zc,1,function(v){return(max(abs(v))<=1.e-14)})
      } else {
         # remove all flux inequalities as there is no free params
         zi=rep(TRUE, nrow(ui_zc))
      }

      inotsat=ci_zc[zi]>tol_ineq
      if (any(inotsat)) {
         cat("Warning: The following constant zc inequalities are not satisfied:\n", file=fcerr)
         cat(nm_izc[zi][inotsat], sep="\n", file=fcerr)
      }
      ui_zc=ui_zc[!zi,,drop=FALSE]
      ci_zc=ci_zc[!zi]
      nm_izc=nm_izc[!zi]
      mi_zc=mi_zc[!zi,,drop=FALSE]

      # remove redundant/contradictory inequalities
      nb_zc=nrow(ui_zc)
      nb_i=nrow(ui)
      ired=c()
      tui=t(ui)
      uzcd=sapply(seq_len(nb_zc), function(i) apply(abs(tui-ui_zc[i,]), 2L, max))
      uzcs=sapply(seq_len(nb_zc), function(i) apply(abs(tui+ui_zc[i,]), 2L, max))
      czcd=abs(outer(abs(ci), abs(ci_zc), "-"))
      ired=which(apply((uzcd < tol_ineq | uzcs < tol_ineq) & czcd <= 1.e-2, 2, any))
      
      if (length(ired) > 0L) {
         # remove all ired inequalities
         cat("The following ", length(ired), " zerocross inequalities are redundant and are removed:\n", paste(nm_izc[ired], collapse="\n"), "\n", sep="", file=fclog)
         ui_zc=ui_zc[-ired,,drop=FALSE]
         ci_zc=ci_zc[-ired]
         nm_izc=nm_izc[-ired]
         mi_zc=mi_zc[-ired,,drop=FALSE]
      }
      if (nrow(ui_zc)) {
         # add zc inequalities
         ui=rbind(ui, ui_zc)
         ci=c(ci, ci_zc)
         nm_i=c(nm_i, nm_izc)
      }
      rm(ui_zc, ci_zc, uzcd, uzcs, czcd)
   }
   rres=NULL

   # set initial scale values to sum(measvec*simlab/dev**2)/sum(simlab**2/dev**2)
   # for corresponding measurements
   if (nb_sc_tot > 0) {
      if (optimize) {
         if (TIMEIT) {
            cat("res esti: ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
         }
         capture.output(rres <- lab_resid(param, cjac=FALSE, labargs), file=fclog)
         if (!is.null(rres$err) && rres$err) {
            cat("lab_resid", runsuf, ": ", rres$mes, "\n", file=fcerr, sep="")
            #close(fkvh)
            retcode[irun]=rres$err
            next
         }
         if (sum(is.infinite(rres$res))) {
            cat("Infinite values appeared in residual vector (at init scale values)", file=fcerr)
            retcode[irun]=1
            #close(fkvh)
            next
         }
         for (iexp in seq_len(nb_exp)) {
            simlab=jx_f$usimlab[[iexp]]
            measinvvar=1./measurements$dev$labeled[[iexp]]**2
            ms=measvec[[iexp]]*simlab*measinvvar
            ss=simlab*simlab*measinvvar
            # get only valid measurements
            iva=!is.na(ms)
            for (i in nb_ff+nb_sc_base[iexp]+seq_len(nb_sc[[iexp]])) {
               im=(ir2isc[[iexp]]==(i+1)) & iva
               if (sum(im) < 2) {
                  mes=sprintf("scaling: no sufficient valid data for scaling factor '%s'\n", nm_par[i])
                  stop_mes(mes, file=fcerr)
               }
               param[i]=sum(ms[im])/sum(ss[im])
            }
         }
      } else {
         # if no optimization, set all scaling params to 1.
         param[nb_ff+seq_len(nb_sc_tot)]=1.
      }
   }

#browser()
   # see if there are any active inequalities at starting point
   ineq=as.numeric(ui%*%param-ci)
   names(ineq)=rownames(ui)
   nbad=sum(abs(ineq)<=tol_ineq)
   if (nbad > 0) {
      cat("The following ", nbad, " ineqalitie(s) are active at starting point", runsuf, ":\n",
         paste(names(ineq[abs(ineq)<=tol_ineq]), collapse="\n"), "\n", sep="", file=fclog)
   }

   if (TIMEIT) {
      cat("kvh init: ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
   }

   cat("influx\n", file=fkvh)
   cat("\tversion\t", vernum, "\n", file=fkvh, sep="")
   cat("\tlabeling\t", if (case_i) "instationary" else "stationary", "\n", file=fkvh, sep="")
   # save options of command line
   cat("\truntime options\n", file=fkvh)
   cat("\t\tclownr=1e-05
		sln=TRUE
		zc=1e-05\n", file=fkvh)
   
   obj2kvh(R.Version(), "R.Version", fkvh, indent=1)
   cat("\tR command line\n", file=fkvh)
   obj2kvh(opts, "opts", fkvh, indent=2)
   cat("\t\texecution date	", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fkvh)

   # resume system sizes
   obj2kvh(nb_sys, "system sizes", fkvh)

   # save initial param
   cat("starting point\n", file=fkvh)
   names(param)=nm_par
   obj2kvh(param, "starting free parameters", fkvh, indent=1)
#browser()
   if (!length(rres)) {
      capture.output(rres <- lab_resid(param, cjac=FALSE, labargs), file=fclog)
      if (!is.null(rres$err) && rres$err) {
         cat("lab_resid", runsuf, ": ", rres$mes, "\n", file=fcerr, sep="")
         #close(fkvh)
         retcode[irun]=rres$err
         next
      }
      if (sum(is.infinite(rres$res))) {
         cat("Infinite values appeared in residual vector (at starting point)", file=fcerr)
         retcode[irun]=1
         #close(fkvh)
         next
      }
   }
   rcost=if (length(rres$res) && !all(ina <- is.na(rres$res))) sum(crossprod(rres$res[!ina])) else NA
   obj2kvh(rcost, "starting cost value", fkvh, indent=1)

   obj2kvh(Afl, "flux system (Afl)", fkvh, indent=1)
   fg=numeric(nb_f$nb_fgr)
   names(fg)=nm_list$fgr
   if (nb_f$nb_fgr > 0) {
      fg[paste("g.n.", substring(nm_list$poolf, 4), "_gr", sep="")]=nb_f$mu*param[nm_list$poolf]
   }
   btmp=as.numeric(p2bfl%stm%param[seq_len(nb_f$nb_ff)]+bp+g2bfl%stm%fg)
   names(btmp)=dimnames(Afl)[[1]]
   obj2kvh(btmp, "flux system (bfl)", fkvh, indent=1)

   #cat("mass vector:\n", file=fclog)
   #print_mass(x)

   names(param)=nm_par

#browser()
   if (optimize && nb_ff+nb_poolf > 0L) {
      if (!(least_norm || sln || !"nlsic" %in% methods)) {
         # check if at starting position all fluxes can be resolved
         if (TIMEIT) {
            cat("check ja: ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
         }
         rres=lab_resid(param, cjac=TRUE, labargs)
         if (sum(is.infinite(rres$res))) {
            cat("Infinite values appeared in residual vector (at identifiability check)", file=fcerr)
            retcode[irun]=1
            #close(fkvh)
            next
         }
         if (any(is.infinite(rres$jacobian))) {
            cat("Infinite values appeared in Jacobian (at identifiability check)", file=fcerr)
            retcode[irun]=1
            #close(fkvh)
            next
         }
         qrj=qr(jx_f$dr_dff, LAPACK=T)
         d=diag(qrj$qr)
         qrj$rank=sum(abs(d)>abs(d[1])*1.e-10)
         if (is.na(qrj$rank)) {
            cat("Rank of starting jacobian could not be estimated.", file=fcerr)
            retcode[irun]=1
            #close(fkvh)
            next
         }
         if (qrj$rank) {
            nm_uns=nm_ff[qrj$pivot[-(1:qrj$rank)]]
         } else {
            nm_uns=nm_ff
         }
         if (qrj$rank < nb_ff) {
            # Too bad. The jacobian of free fluxes is not of full rank.
            dimnames(jx_f$dr_dff)[[2]]=c(nm_ffn, nm_ffx)
            fname="dbg_dr_dff_singular" %s+% runsuf %s+% ".csv"
            cat(sprintf("Provided measurements (labeling and fluxes) are not sufficient to resolve all free fluxes.\nUnsolvable fluxes may be:\n%s\nJacobian dr_dff is written in the result kvh file.\n",
               paste(nm_uns, sep=", ", collapse=", ")),
               file=fcerr)
            obj2kvh(jx_f$dr_dff, "Jacobian dr_dff", fkvh, indent=0)
            #close(fkvh)
            retcode[irun]=1
            next
         }
      }
      if (TIMEIT) {
         cat("optim   : ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
      }
      # pass control to the chosen optimization method
      if (time_order=="1,2")
         labargs$time_order="1" # start with order 1, later continue with 2
      for (method in methods) {
         capture.output(res <- opt_wrapper(param, method, measurements, jx_f, labargs), file=fclog)
         if ((!is.null(res$err) && res$err) || is.null(res$par)) {
            cat("error in first optimization pass", runsuf, ": ", res$mes, "\n", sep="", file=fcerr)
            res$par=rep(NA, length(param))
            res$cost=NA
         } else if (!is.null(res$mes) && nchar(res$mes)) {
            cat("warning in first optimization pass", runsuf, ": ", res$mes, "\n", sep="", file=fcerr)
         }
         if (any(is.na(res$par))) {
            res$retres$jx_f=NULL # to avoid writing of huge data
            obj2kvh(res, "failed first pass optimization process information", fkvh)
            cat("Optimization failed", runsuf, "\n", file=fcerr, sep="")
            #close(fkvh) # some additional information can be written into fkvh
            retcode[irun]=max(res$err, 1)
            next
         }
         param=res$par
   #browser()
         if (zerocross && !is.null(mi_zc)) {
            if (TIMEIT) {
               cat("secondzc: ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
            }
            # inverse active "zc" inequalities
            nm_inv=names(which((ui%*%res$par-ci)[,1]<=tol_ineq))
            i=grep("^zc ", nm_inv, v=T)
            if (length(i) > 0) {
               i=str2ind(i, nm_i)
               cat("The following inequalities are active after first pass
   of zero crossing strategy and will be inverted", runsuf, ":\n", paste(nm_i[i], collapse="\n"), "\n", sep="", file=fclog)
               ipos=grep(">=", nm_i[i], v=T)
               ineg=grep("<=", nm_i[i], v=T)
               ui[i,]=-ui[i,,drop=FALSE]
               if (length(ipos)) {
                  ipzc=str2ind(ipos, nm_izc)
                  ipos=str2ind(ipos, nm_i)
                  ci[ipos]=as.numeric(zc+mi_zc[ipzc,,drop=FALSE]%*%mic)
                  nm_i[ipos]=sub(">=", "<=-", nm_i[ipos])
               }
               if (length(ineg)) {
                  inzc=str2ind(ineg, nm_izc)
                  ineg=str2ind(ineg, nm_i)
                  ci[ineg]=as.numeric(zc+mi_zc[inzc,,drop=FALSE]%*%mic)
                  nm_i[ineg]=sub("<=-", ">=", nm_i[ineg])
               }
               rownames(ui)=nm_i
               names(ci)=nm_i
               # enforce new inequalities
               reopt=TRUE
               capture.output(pinside <- put_inside(res$par, ui, ci), file=fclog)
               if (any(is.na(pinside))) {
                  if (!is.null(attr(pinside, "err")) && attr(pinside, "err")!=0) {
                     # fatal error occured, don't reoptimize
                     cat(paste("put_inside", runsuf, ": ", attr(pinside, "mes"), "\n", collapse=""), file=fcerr)
                     reopt=FALSE
                  }
               } else if (!is.null(attr(pinside, "err")) && attr(pinside, "err")==0){
                  # non fatal problem
                  cat(paste("put_inside", runsuf, ": ", attr(pinside, "mes"), "\n", collapse=""), file=fcerr)
               }
               # reoptimize
               if (reopt) {
                  cat("Second zero crossing pass", runsuf, "\n", sep="", file=fclog)
                  capture.output(reso <- opt_wrapper(pinside, method, measurements, new.env(), labargs), file=fclog)
                  if (reso$err || is.null(reso$par)) {
                     cat("second zero crossing pass: ", reso$mes, "\n", sep="", file=fcerr)
                  } else if (!is.null(reso$mes) && nchar(reso$mes)) {
                     cat("second zero crossing pass", runsuf, ": ", reso$mes, "\n", sep="", file=fcerr)
                  }
                  if(!reso$err && !is.null(reso$par) && !any(is.na(reso$par))) {
                     param=reso$par
                     res=reso
                     jx_f=labargs$jx_f
                  }
                  if (any(is.na(reso$par))) {
                     reso$retres$jx_f=NULL # to avoid writing of huge data
                     obj2kvh(reso, "failed second pass optimization process information", fkvh)
                     cat("Second zero crossing pass failed. Keep free parameters from previous pass", runsuf, "\n", file=fcerr, sep="")
                  }
               }
               # last pass, free all zc constraints
               i=grep("^zc ", nm_i)
               if (length(i) > 0) {
                  if (TIMEIT) {
                     cat("last zc : ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
                  }
                  ui=ui[-i,,drop=FALSE]
                  ci=ci[-i]
                  nm_i=nm_i[-i]
                  cat("Last zero crossing pass (free of zc constraints)", runsuf, "\n", sep="", file=fclog)
                  capture.output(reso <- opt_wrapper(param, method, measurements, new.env(), labargs), file=fclog)
                  if (reso$err || is.null(reso$par) || (!is.null(res$mes) && nchar(res$mes))) {
                     cat("last zero crossing (free of zc)", runsuf, ": ", reso$mes, "\n", sep="", file=fcerr)
                  }
                  if(!reso$err && !is.null(reso$par) && !any(is.na(reso$par))) {
                     param=reso$par
                     res=reso
                     jx_f=labargs$jx_f
                  }
                  if (any(is.na(res$par))) {
                     res$retres$jx_f=NULL # to avoid writing of huge data
                     obj2kvh(res, "failed last pass optimization process information", fkvh)
                     cat("Last zero crossing pass failed. Keep free parameters from previous passes", runsuf, "\n", file=fcerr, sep="")
                  }
               }
            } else {
               cat("After the first optimization, no zero crossing inequality was activated. So no reoptimization", runsuf, "\n", sep="", file=fclog)
            }
         } # end if zero crossing
      } # for method
      param=res$par
      names(param)=nm_par
      if (excl_outliers != F) {
         # detect outliers
         if (TIMEIT) {
            cat("outliers: ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
         }
         iva=!is.na(res$res)
         zpval=rz.pval.bi(res$res)
         iout=which(zpval <= excl_outliers & iva)
         #cat("iout=", iout, "\n", file=fclog)
         if (length(iout)) {
            measurements$outlier=iout
            outtab=cbind(residual=res$res[iout], `p-value`=zpval[iout])
            row.names(outtab)=nm_resid[iout]
            cat("Excluded outliers at p-value ", excl_outliers, ":\n", sep="", file=fclog)
            write.table(outtab, file=fclog, append=TRUE, quote=FALSE, sep="\t", col.names=FALSE)
            
            # optimize with the last method from methods
            capture.output(reso <- opt_wrapper(param, tail(methods, 1L), measurements, new.env(), labargs), file=fclog)
            if (reso$err || is.null(reso$par) || (!is.null(reso$mes) && nchar(reso$mes))) {
               cat("wo outliers: ", reso$mes, "\n", sep="", file=fcerr)
            }
            if (any(is.na(reso$par))) {
               cat("Optimization with outliers excluded has failed, run= ", runsuf, "\n", file=fcerr, sep="")
               # continue without outlier exclusion
               measurements$outlier=NULL
            } else {
               res=reso
               param=reso$par
               names(param)=nm_par
               jx_f=labargs$jx_f
               labargs$measurements=measurements # store outliers
               obj2kvh(outtab, "excluded outliers", fkvh)
            }
         } else {
            cat("Outlier exclusion at p-value "%s+%excl_outliers%s+%" has been requested but no outlier was detected at this level.", "\n", sep="", file=fcerr)
         }
      }
      if (case_i && time_order=="1,2") {
         if (TIMEIT) {
            cat("order 2 : ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
         }
         labargs$time_order="2" # continue with the 2-nd order
         capture.output(reso <- opt_wrapper(param, tail(methods, 1L), measurements, new.env(), labargs), file=fclog)
         if (reso$err || is.null(reso$par) || (!is.null(reso$mes) && nchar(reso$mes))) {
            cat("order2: ", reso$mes, "\n", sep="", file=fcerr)
         }
         if (any(is.na(reso$par))) {
            cat("Optimization time_order 2 (in '1,2' suite) has failed, run=", runsuf, "\n", file=fcerr, sep="")
         } else {
            res=reso
            param=reso$par
            names(param)=nm_par
            jx_f=labargs$jx_f
         }
      }
#browser()
      optinfo=list(
         "fitted parameters"=param,
         "last increment before backtracking"=res$lastp,
         "last increment after backtracking"=res$laststep,
         "iteration number"=res$it,
         "convergence history"=res$hist,
         "exit message"=res$mes
      )
      obj2kvh(optinfo, "optimization process information", fkvh)
      rres=res$retres
   } else {
      rres=lab_resid(param, TRUE, labargs)
   }
   if (TIMEIT) {
      cat("postopt : ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
   }
   # active constraints
   if (!all(is.na(param))) {
      ine=as.numeric(abs(ui%*%param-ci))<tol_ineq
      if (any(ine)) {
         obj2kvh(nm_i[ine], "active inequality constraints", fkvh)
      }
   }
   poolall[nm_poolf]=param[nm_poolf]

#browser()
   if (is.null(jx_f$jacobian)) {
      # final jacobian calculation
      capture.output(rres <- lab_resid(param, cjac=TRUE, labargs), file=fclog)
      if (!is.null(rres$err) && rres$err) {
         cat("lab_resid", runsuf, ": ", rres$mes, "\n", file=fcerr, sep="")
         close(fkvh)
         retcode[irun]=rres$err
         next
      }
   }
   rcost=cumo_cost(param, labargs, rres)
   pres[,irun]=param
   costres[irun]=rcost
   obj2kvh(rcost, "final cost", fkvh)
#browser()
   # get z p-values on residual vector
   zpval=rz.pval.bi(rres$res)
   resid=list()
   if (sum(nb_meas)) {
      resid[["labeled data"]]=lapply(seq_len(nb_exp), function(iexp) if (is.matrix(jx_f$reslab[[iexp]])) jx_f$reslab[[iexp]] else cbind(residual=jx_f$reslab[[iexp]], `p-value`=zpval[seq_along(jx_f$reslab[[iexp]])]))
      names(resid[["labeled data"]])=nm_exp
   
      if (case_i) {
         resid[["labeled data p-value"]]=vector("list", nb_exp)
         names(resid[["labeled data p-value"]])=nm_exp
         for (iexp in seq_len(nb_exp)) {
            mtmp=zpval[seq_along(jx_f$reslab[[iexp]])]
            dim(mtmp)=dim(jx_f$reslab[[iexp]])
            dimnames(mtmp)=dimnames(jx_f$reslab[[iexp]])
            resid[["labeled data p-value"]][[iexp]]=mtmp
            rm(mtmp)
         }
      }
   }
   nb_reslab_tot=sum(sapply(jx_f$reslab, length))
   if (length(jx_f$resflu))
      resid[["measured fluxes"]]=cbind(residual=jx_f$resflu, `p-value`=zpval[nb_reslab_tot+seq_along(jx_f$resflu)])
   if (length(jx_f$respool))
      resid[["measured pools"]]=cbind(residual=if (is.matrix(jx_f$respool)) jx_f$respool[,1] else jx_f$respool, `p-value`=zpval[nb_reslab_tot+length(jx_f$resflu)+seq_along(jx_f$respool)])
   obj2kvh(resid, "(simulated-measured)/sd_exp", fkvh)
   rm(resid, zpval)

   # simulated measurements -> kvh
   simul=list()
#browser()
   if (case_i) {
      if (sum(nb_meas)) {
         if (addnoise) {
            simul[["labeled data"]]=lapply(seq_len(nb_exp), function(iexp) jx_f$usm[[iexp]]+rnorm(length(jx_f$usm[[iexp]]))*measurements$dev$labeled[[iexp]])
            names(simul[["labeled data"]])=nm_exp
         } else {
            simul[["labeled data"]]=jx_f$usm
         }
      }
   } else {
      if (sum(nb_meas)) {
         if (addnoise) {
            simlab=lapply(seq_len(nb_exp), function(iexp) jx_f$simlab[[iexp]]+rnorm(length(jx_f$simlab[[iexp]]))*measurements$dev$labeled[[iexp]])
            names(simlab)=nm_exp
         } else {
            simlab=jx_f$simlab
         }
         if (nb_sc_tot > 0) {
            simul[["labeled data (unscaled)"]]=jx_f$usimlab
            simul[["labeled data (scaled)"]]=simlab
         } else {
            simul[["labeled data"]]=simlab
         }
      }
   }
   if (nb_fmn) {
      if (addnoise)
         simul[["measured fluxes"]]=jx_f$simfmn+rnorm(length(jx_f$simfm))*measurements$dev$flux
      else
         simul[["measured fluxes"]]=jx_f$simfmn
   }
   if (nb_poolm) {
      if (addnoise)
         simul[["measured pools"]]=jx_f$simpool+rnorm(length(jx_f$simpool))*measurements$dev$pool
      else
         simul[["measured pools"]]=jx_f$simpool
   }
   obj2kvh(simul, "simulated measurements", fkvh)
   
   # SD -> kvh
   # get index of non null components
   iget=sapply(names(measurements$dev), function(nm) !is.null(measurements$dev[[nm]]) & nm %in% c("labeled", "flux", "pool"))
   obj2kvh(measurements$dev[iget], "measurement SD", fkvh)

   # gradient -> kvh
   if (length(jx_f$res) && !all(ina <- is.na(jx_f$res))) {
      if (any(ina)) {
         gr=2*as.numeric(crossprod(jx_f$res[!ina], jx_f$jacobian[!ina,,drop=FALSE]))
      } else {
         gr=2*as.numeric(crossprod(jx_f$res, jx_f$jacobian))
      }
      names(gr)=nm_par
      obj2kvh(gr, "gradient vector", fkvh)
   }
   colnames(jx_f$udr_dp)=nm_par
   obj2kvh(jx_f$udr_dp, "jacobian dr_dp (without 1/sd_exp)", fkvh)
   # generalized inverse of non reduced jacobian
   if (length(jx_f$udr_dp) > 0L) {
      svj=svd(jx_f$udr_dp)
      invj=svj$v%*%(t(svj$u)/svj$d)
      dimnames(invj)=rev(dimnames(jx_f$udr_dp))
      obj2kvh(invj, "generalized inverse of jacobian dr_dp (without 1/sd_exp)", fkvh)
   }

   labargs$getx=TRUE
   labargs$labargs2getx=TRUE
   if (fullsys) {
      nm_flist=nm_list
      nm_flist$rcumo=nm_cumo
      nm_flist$rcumo_in_cumo=match(nm_rcumo, nm_cumo)
      nb_f$cumos=nb_cumos
      nm_xi_f=c()
      xi_f=matrix(c(), ncol=nb_exp)
      dimnames(xi_f)[[1]]=nm_xi_f
      nm_flist$xi=nm_xi_f
      labargs$emu=F
      v=lab_sim(param, cjac=FALSE, labargs)
      labargs$emu=emu
      x=if (case_i) v$xf else v$x
   } else {
      v=lab_sim(param, cjac=FALSE, labargs)
      x=if (case_i) v$xf else v$x
   }

   # write some info in result kvh
   mid=cumo2mass(x)
   if (case_i) {
      mid=lapply(mid, function(m) m[sort(rownames(m)),,drop=FALSE])
   } else if (length(mid)) {
      mid=mid[sort(rownames(mid)),,drop=FALSE]
   }
   obj2kvh(mid, "MID vector", fkvh)
   
   # constrained fluxes to kvh
   obj2kvh(fallnx[nm_fc], "constrained net-xch01 fluxes", fkvh)

   fwrv=v$lf$fwrv
   fallnx=v$lf$fallnx
   flnx=v$lf$flnx
   fgr=fallnx[nm_fgr]

   # keep last jx_f in jx_f_last
#browser()
   while (sensitive=="mc" && !all(is.na(param))) {
      if (TIMEIT) {
         cat("monte-ca: ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
      }
      if (set_seed) {
         set.seed(seed)
      }
      # reference simulation corresponding to the final param
      refsim=new.env()
      for (nm_it in c("simlab", "simfmn", "simpool", "usm")) {
         assign(nm_it, jx_f[[nm_it]], envir=refsim)
      }
      # Monte-Carlo simulation in parallel way (if asked and possible)
      if (np > 1L) {
         spli=splitIndices(nmc, nodes);
         clusterExport(cl, c("param", "refsim", "runsuf", "spli"))
         #clusterEvalQ(cl, labargs$spa[[1]]$a <- NULL) # to rebuild sparse matrices on cores ## now, they are build once, at the cluster init
         cl_res=clusterEvalQ(cl, {mc_iter=TRUE; labargs$getx=FALSE; mc_res=lapply(spli[[idw]], mc_sim); rm(mc_iter); mc_res})
         mc_res=vector(nmc, mode="list")
         for (i in seq(nodes))
            mc_res[spli[[i]]]=cl_res[[i]]
         #mc_res=parLapplyLB(cl, seq_len(nmc), function(imc) cl_worker(funth=mc_sim, argth=list(imc)))
      } else {
         mc_res=lapply(seq_len(nmc), function(imc) cl_worker(funth=mc_sim, argth=list(imc)))
      }
      free_mc=sapply(mc_res, function(l) {if (class(l)=="character" || is.null(l) || is.na(l$cost) || l$err) { ret=rep(NA, nb_param+3) } else { ret=c(l$cost, l$it, l$normp, l$par) }; ret })
      if (length(free_mc)==0) {
         cat("Parallel exectution of Monte-Carlo simulations has failed.", "\n", sep="", file=fcerr)
         free_mc=matrix(NA, nb_param+2, 0)
      }
      cost_mc=free_mc[1,]
      nmc_real=nmc-sum(is.na(free_mc[4,]))
      cat("monte-carlo\n", file=fkvh)
      indent=1
      obj2kvh(cl_type, "cluster type", fkvh, indent)
      obj2kvh(avaco, "detected cores", fkvh, indent)
      avaco=max(1, avaco, na.rm=T)
      obj2kvh(min(avaco, np, na.rm=T), "used cores", fkvh, indent)
      cat("\tfitting samples\n", file=fkvh)
      indent=2
      obj2kvh(nmc, "requested number", fkvh, indent)
      obj2kvh(nmc_real, "calculated number", fkvh, indent)
      obj2kvh(nmc-nmc_real, "failed to calculate", fkvh, indent)
      # convergence section in kvh
      indent=1
      mout=rbind(round(free_mc[1:2,,drop=FALSE], 2),
         format(free_mc[3,,drop=FALSE], di=2, sci=T))
      dimnames(mout)=list(c("cost", "it.numb", "normp"), seq_len(ncol(free_mc)))
      obj2kvh(mout, "convergence per sample", fkvh, indent)
      # remove failed m-c iterations
      free_mc=free_mc[-(1:3),,drop=FALSE]
      ifa=which(is.na(free_mc[1,]))
      if (length(ifa)) {
         if (ncol(free_mc) > length(ifa)) {
            cat("Some Monte-Carlo iterations failed.", "\n", sep="", file=fcerr)
         }
         free_mc=free_mc[,-ifa,drop=FALSE]
         cost_mc=cost_mc[-ifa]
      }
      if (nmc_real <= 1) {
         cat("No sufficient Monter-Carlo samples were successfully calculated to do any statistics.", "\n", sep="", file=fcerr)
         retcode[irun]=1
         break
      }
#browser()
      rownames(free_mc)=nm_par
      
      # cost section in kvh
      cat("\tcost\n", file=fkvh)
      indent=2
      obj2kvh(mean(cost_mc), "mean", fkvh, indent)
      obj2kvh(median(cost_mc), "median", fkvh, indent)
      obj2kvh(sd(cost_mc), "sd", fkvh, indent)
      obj2kvh(sd(cost_mc)*100/mean(cost_mc), "rsd (%)", fkvh, indent)
      obj2kvh(quantile(cost_mc, c(0.025, 0.95, 0.975)), "ci", fkvh, indent)
      
      # free parameters section in kvh
      cat("\tStatistics\n", file=fkvh)
      mout=c()
      indent=2
      # param stats
      # mean
      parmean=apply(free_mc, 1, mean)
      # median
      parmed=apply(free_mc, 1, median)
#browser()
      # covariance matrix
      covmc=cov(t(free_mc))
      obj2kvh(covmc, "covariance", fkvh, indent)
      # sd
      sdmc=sqrt(diag(covmc))
      # confidence intervals
      ci_mc=t(apply(free_mc, 1, quantile, probs=c(0.025, 0.975)))
      ci_mc=cbind(ci_mc, t(diff(t(ci_mc))))
      colnames(ci_mc)=c("CI 2.5%", "CI 97.5%", "CI length")
      mout=cbind(mout, mean=parmean, median=parmed, sd=sdmc,
         "rsd (%)"=sdmc*100/abs(parmean), ci_mc)
      obj2kvh(mout, "free parameters", fkvh, indent)

      # net-xch01 stats
      fallnx_mc=apply(free_mc, 2, function(p)param2fl(p, labargs)$fallnx)
      fallnx=param2fl(param, labargs)$fallnx
      if (length(fallnx_mc)) {
         dimnames(fallnx_mc)[[1]]=nm_fallnx
         # form a matrix output
         fallout=matrix(0, nrow=nrow(fallnx_mc), ncol=0)
         # mean
#browser()
         parmean=apply(fallnx_mc, 1, mean)
         # median
         parmed=apply(fallnx_mc, 1, median)
         # covariance matrix
         covmc=cov(t(fallnx_mc))
         dimnames(covmc)=list(nm_fallnx, nm_fallnx)
         # sd
         sdmc=sqrt(diag(covmc))
         # confidence intervals
         ci_mc=t(apply(fallnx_mc, 1, quantile, probs=c(0.025, 0.975)))
         ci_mc=cbind(ci_mc, t(diff(t(ci_mc))))
         ci_mc=cbind(ci_mc, ci_mc[,3]*100/abs(parmean))
         colnames(ci_mc)=c("CI 2.5%", "CI 97.5%", "CI 95% length", "relative CI (%)")
         fallout=cbind(fallout, mean=parmean, median=parmed, sd=sdmc,
            "rsd (%)"=sdmc*100/abs(fallnx), ci_mc)
         o=order(nm_fallnx)
         obj2kvh(fallout[o,,drop=FALSE], "all net-xch01 fluxes", fkvh, indent)
         obj2kvh(covmc[o,o], "covariance of all net-xch01 fluxes", fkvh, indent)

         # fwd-rev stats
         fwrv_mc=apply(free_mc, 2, function(p)param2fl(p, labargs)$fwrv)
         dimnames(fwrv_mc)[[1]]=nm_fwrv
         fallout=matrix(0, nrow=nrow(fwrv_mc), ncol=0)
         # mean
         parmean=apply(fwrv_mc, 1, mean)
         # median
         parmed=apply(fwrv_mc, 1, median)
         # covariance matrix
         covmc=cov(t(fwrv_mc))
         dimnames(covmc)=list(nm_fwrv, nm_fwrv)
         # sd
         sdmc=sqrt(diag(covmc))
         # confidence intervals
         ci_mc=t(apply(fwrv_mc, 1, quantile, probs=c(0.025, 0.975)))
         ci_mc=cbind(ci_mc, t(diff(t(ci_mc))))
         ci_mc=cbind(ci_mc, ci_mc[,3]*100/abs(fwrv))
         dimnames(ci_mc)[[2]]=c("CI 2.5%", "CI 97.5%", "CI 95% length", "relative CI (%)")
         fallout=cbind(fallout, mean=parmean, median=parmed, sd=sdmc,
            "rsd (%)"=sdmc*100/abs(parmean), ci_mc)
         o=order(nm_fwrv)
         obj2kvh(fallout[o,,drop=FALSE], "forward-reverse fluxes", fkvh, indent)
         obj2kvh(covmc[o,o], "covariance of forward-reverse fluxes", fkvh, indent)
      }
      break
   }
#browser()
   if (length(sensitive) && nchar(sensitive) && sensitive != "mc") {
      cat(paste("Unknown sensitivity '", sensitive, "' method chosen.", sep=""), "\n", sep="", file=fcerr)
      retcode[irun]=1
   }

   if (TIMEIT) {
      cat("linstats: ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
   }
   # Linear method based on jacobian x_f
   # reset fluxes and jacobians according to param
   if (is.null(jx_f$jacobian)) {
      capture.output(rres <- lab_resid(param, cjac=TRUE, labargs), file=fclog)
      if (!is.null(rres$err) && rres$err) {
         cat("lab_resid", runsuf, ": ", rres$mes, "\n", file=fcerr, sep="")
         close(fkvh)
         retcode[irun]=rres$err
         next
      }
   } # else use the last calculated jacobian

   # covariance matrix of free fluxes
   if (length(jx_f$jacobian) > 0L && !all(is.na(param))) {
      svj=svd(jx_f$jacobian)
      if (svj$d[1] == 0.) {
         i=rep(TRUE, length(svj$d))
      } else {
         i=svj$d/svj$d[1]<1.e-10
         if (all(!i) && svj$d[1]<1.e-10) {
            # we could not find very small d, take just the last
            i[length(i)]=TRUE
         }
      }
      ibad=apply(svj$v[, i, drop=FALSE], 2, which.contrib)
      ibad=unique(unlist(ibad))
      if (length(ibad) > 0) {
         cat(paste(if (nchar(runsuf)) runsuf%s+%": " else "", "Inverse of covariance matrix is numerically singular.\nStatistically undefined parameter(s) seems to be:\n",
            paste(sort(nm_par[ibad]), collapse="\n"), "\nFor more complete list, see sd columns in '/linear stats'\nin the result file.", sep=""), "\n", sep="", file=fcerr)
      }
      # "square root" of covariance matrix (to preserve numerical positive definitness)
      rtcov=(svj$u)%*%(t(svj$v)/svj$d)
      # standart deviations of free fluxes
      cat("linear stats\n", file=fkvh)

      # sd free+dependent+growth net-xch01 fluxes
      nm_flfd=c(nm_ff, nm_fgr, nm_fl)
      if (nb_ff > 0 || nb_fgr > 0) {
         i=1:nb_param
         i=c(head(i, nb_ff), tail(i, nb_fgr))
         covfl=crossprod(rtcov[, i, drop=FALSE]%mmt%(rbind(diag(nb_ff+nb_fgr), dfl_dffg)%mrv%c(rep.int(1., nb_ff), fgr)))
         dimnames(covfl)=list(nm_flfd, nm_flfd)
         sdfl=sqrt(diag(covfl))
      } else {
         sdfl=rep(0., nb_fl)
         covfl=matrix(0., nb_fl, nb_fl)
      }
      fl=c(head(param, nb_ff), fgr, flnx)
      stats_nx=cbind("value"=fl, "sd"=sdfl, "rsd"=sdfl/abs(fl))
      rownames(stats_nx)=nm_flfd
      o=order(nm_flfd)
      obj2kvh(stats_nx[o,,drop=FALSE], "net-xch01 fluxes (sorted by name)", fkvh, indent=1)
      obj2kvh(covfl[o, o], "covariance net-xch01 fluxes", fkvh, indent=1)

      # sd of all fwd-rev
      if (nb_ff > 0 || nb_fgr > 0) {
         i=1:nb_param
         i=c(head(i, nb_ff), tail(i, nb_fgr))
         covf=crossprod(tcrossprod_simple_triplet_matrix(rtcov[,i, drop=FALSE], jx_f$df_dffp%mrv%c(rep.int(1., nb_ff), head(poolall[nm_poolf], nb_fgr))))
         dimnames(covf)=list(nm_fwrv, nm_fwrv)
         sdf=sqrt(diag(covf))
      } else {
         sdf=rep(0., length(fwrv))
      }
      mtmp=cbind(fwrv, sdf, sdf/abs(fwrv))
      dimnames(mtmp)[[2]]=c("value", "sd", "rsd")
      o=order(nm_fwrv)
      obj2kvh(mtmp[o,], "fwd-rev fluxes (sorted by name)", fkvh, indent=1)
      if (nb_ff > 0 || nb_fgr > 0) {
         obj2kvh(covf, "covariance fwd-rev fluxes", fkvh, indent=1)
      }
      # pool -> kvh
      sdpf=poolall
      sdpf[]=0.

      if (nb_poolf > 0) {
         # covariance matrix of free pools
         # "square root" of covariance matrix (to preserve numerical positive definitness)
         poolall[nm_poolf]=param[nm_poolf]
         # cov poolf
         covpf=crossprod(rtcov[,nb_ff+nb_sc_tot+seq_len(nb_poolf), drop=FALSE])
         dimnames(covpf)=list(nm_poolf, nm_poolf)
         sdpf[nm_poolf]=sqrt(diag(covpf))
      }
      if (length(poolall) > 0) {
         mtmp=cbind("value"=poolall, "sd"=sdpf, "rsd"=sdpf/poolall)
         rownames(mtmp)=nm_poolall
         o=order(nm_poolall)
         obj2kvh(mtmp[o,,drop=FALSE], "metabolite pools (sorted by name)", fkvh, indent=1)
         if (nb_poolf > 0) {
            o=order(nm_poolf)
            obj2kvh(covpf[o, o], "covariance free pools", fkvh, indent=1)
         }
      }
   }

   # chi2 test for goodness of fit
   # goodness of fit (chi2 test)
   if (length(jx_f$res)) {
      nvres=sum(!is.na(jx_f$res))
      if (nvres >= nb_param) {
         chi2test=list("chi2 value"=rcost, "data points"=nvres,
            "fitted parameters"=nb_param, "degrees of freedom"=nvres-nb_param)
         chi2test$`chi2 reduced value`=chi2test$`chi2 value`/chi2test$`degrees of freedom`
         chi2test$`p-value, i.e. P(X^2<=value)`=pchisq(chi2test$`chi2 value`, df=chi2test$`degrees of freedom`)
         chi2test$conclusion=if (chi2test$`p-value, i.e. P(X^2<=value)` > 0.95) "At level of 95% confidence, the model does not fit the data good enough with respect to the provided measurement SD" else "At level of 95% confidence, the model fits the data good enough with respect to the provided measurement SD"
         obj2kvh(chi2test, "goodness of fit (chi2 test)", fkvh, indent=1)
      } else {
         cat(sprintf("chi2: Measurement number %d is lower than parameter number %d. Chi2 test cannot be done.\n", nvres, nb_param), sep="", file=fcerr)
      }
   }
   if (prof) {
      Rprof(NULL)
   }
   close(fkvh)
   # write edge.netflux property
   fedge=file(file.path(dirw, sprintf("edge.netflux.%s%s.attrs", baseshort,  runsuf)), "w")
   cat("netflux (class=Double)\n", sep="", file=fedge)
   nm_edge=names(edge2fl)
   cat(paste(nm_edge, fallnx[edge2fl], sep=" = "), sep="\n" , file=fedge)
   close(fedge)

   # write edge.xchflux property
   fedge=file(file.path(dirw, sprintf("edge.xchflux.%s%s.attrs", baseshort,  runsuf)), "w")
   flxch=paste(".x", substring(edge2fl, 4), sep="")
   ifl=charmatch(flxch, substring(names(fallnx), 2))
   cat("xchflux (class=Double)\n", sep="", file=fedge)
   cat(paste(nm_edge, fallnx[ifl], sep=" = "), sep="\n" , file=fedge)
   close(fedge)

   # write node.log2pool property
   if (length(poolall)> 0) {
      fnode=file(file.path(dirw, sprintf("node.log2pool.%s%s.attrs", baseshort,  runsuf)), "w")
      cat("log2pool (class=Double)\n", sep="", file=fnode)
      nm_node=substring(names(poolall), 4)
      cat(paste(nm_node, log2(poolall), sep=" = "), sep="\n" , file=fnode)
      close(fnode)
   }
}
if (!is.null(cl)) {
   stopCluster(cl)
   labargs$cl=cl=NULL
}

pres=rbind(cost=costres, pres)
fco=file(file.path(dirw, sprintf("%s.pres.csv", baseshort)), open="w")
cat("row_col	", file=fco)
write.table(file=fco, pres, row.n=T, quot=F, sep="\t")
close(fco)
if (TIMEIT) {
   cat("rend    : ", format(Sys.time()), " cpu=", proc.time()[1], "\n", sep="", file=fclog)
}

# source files from FTBL/posttreat_R
postlist=strsplit("", " *; *")[[1]]
for (post in postlist) {
   fpostR=file.path(dirw, post)
   if (file.exists(fpostR) && !isTRUE(file.info(fpostR)$isdir)) {
      source(fpostR)
   } else {
      # not found in 'dirw', try 'dirr'
      fpostR=file.path(dirr, post)
      if (file.exists(fpostR) && !isTRUE(file.info(fpostR)$isdir)) {
         source(fpostR)
      } else {
         cat(sprintf("Posttreatment R file '%s' does not exist in ftbl directory neither in influx_si one. Ignored.\n", post), file=fcerr)
      }
   }
}
xgc=gc(verbose=FALSE) # to avoid the message "Error in (function (x)  : tentative d'appliquer un objet qui n'est pas une fonction"
close(fclog)
close(fcerr)
retcode=max(retcode)
if (format(parent.frame()) == format(.GlobalEnv)) {
   q("no", status=retcode)
}
